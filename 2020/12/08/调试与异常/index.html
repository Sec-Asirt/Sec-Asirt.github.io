<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>调试与异常 | Mr.Hu</title><meta name="description" content="Windows异常处理概述异常机制，就是为了让计算机能够更好的处理程序行期间产生的错误，从编程的角度来看，能够将错误的处理与程序的逻辑分隔开。使得我们可以集中精力开发关键功能，而把 程序可能出现的异常统一管理。  windows提供了异常处理的机制，使得你有机会挽救自己即将崩溃的程序，大体上来说 它提供了以下处理异常的机制： SEH-结构化异常处理 VEH-向量化异常处理 VCH-向量化异常处理"><meta name="author" content="胡先森"><meta name="copyright" content="胡先森"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yoursite.com/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="yandex-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#49B1F5&quot;,&quot;paginator&quot;:&quot;#00c4b6&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;}}"/><meta property="og:type" content="article"><meta property="og:title" content="调试与异常"><meta property="og:url" content="http://yoursite.com/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/"><meta property="og:site_name" content="Mr.Hu"><meta property="og:description" content="Windows异常处理概述异常机制，就是为了让计算机能够更好的处理程序行期间产生的错误，从编程的角度来看，能够将错误的处理与程序的逻辑分隔开。使得我们可以集中精力开发关键功能，而把 程序可能出现的异常统一管理。  windows提供了异常处理的机制，使得你有机会挽救自己即将崩溃的程序，大体上来说 它提供了以下处理异常的机制： SEH-结构化异常处理 VEH-向量化异常处理 VCH-向量化异常处理"><meta property="og:image" content="http://yoursite.com/img/WindowsError.jpg"><meta property="article:published_time" content="2020-12-08T12:59:09.376Z"><meta property="article:modified_time" content="2021-01-13T01:18:13.336Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"❤富强❤,❤民主❤,❤和谐❤,❤友善❤,❤敬业❤,❤文明❤,❤自由❤,❤平等❤,❤公正❤,❤法治❤,❤爱国❤,❤诚信❤","fontSize":"15px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-01-13 09:18:13'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">29</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">32</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/projects/clock/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-bookmark"></i><span> 时光轴</span></a></div><div class="menus_item"><a class="site-page" href="/tools/"><i class="fa-fw fas fa-archive"></i><span> 工具</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 放松</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 学习</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/projects/photo/"><i class="fa-fw fas fa-images"></i><span> 照片墙</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-film"></i><span> 游戏</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/projects/game1/"><i class="fa-fw fas fa-heart"></i><span> 保卫星球</span></a></li><li><a class="site-page" href="/projects/game2/"><i class="fa-fw fas fa-heart"></i><span> 飞字快打</span></a></li><li><a class="site-page" href="/projects/game3/"><i class="fa-fw fas fa-heart"></i><span> 俄罗斯方块</span></a></li><li><a class="site-page" href="/projects/game4/"><i class="fa-fw fas fa-heart"></i><span> 特效画笔</span></a></li><li><a class="site-page" href="/projects/game5/"><i class="fa-fw fas fa-heart"></i><span> 音速小子</span></a></li><li><a class="site-page" href="/projects/game6/"><i class="fa-fw fas fa-heart"></i><span> 植物大战僵尸</span></a></li><li><a class="site-page" href="/projects/zifuyu/"><i class="fa-fw fas fa-heart"></i><span> 字符雨</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-link"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page" href="/projects/link/"><i class="fa-fw fas fa-link"></i><span> 网站导航</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user-circle"></i><span> 留言板</span></a></div></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">Windows异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8-amp-%E4%B8%AD%E6%96%AD"><span class="toc-number">1.2.</span> <span class="toc-text">异常&amp;中断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%88%86%E7%B1%BB"><span class="toc-number">1.2.1.</span> <span class="toc-text">异常分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%8C%96%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86SEH"><span class="toc-number">1.3.</span> <span class="toc-text">结构化异常处理SEH</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#try%E4%B8%8E-finally"><span class="toc-number">1.3.1.</span> <span class="toc-text">try与 finally</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#try%E4%B8%8Eexcept"><span class="toc-number">1.3.2.</span> <span class="toc-text">try与except</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">函数异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%EF%BC%9A-%E8%8E%B7%E5%8F%96%E5%BC%82%E5%B8%B8%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.2.1.1.</span> <span class="toc-text">第一个： 获取异常代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA%EF%BC%9A%E8%8E%B7%E5%8F%96%E5%BC%82%E5%B8%B8%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.2.1.2.</span> <span class="toc-text">第二个：获取异常信息</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E9%94%99%E8%AF%AF%E7%A0%81"><span class="toc-number">1.3.2.1.2.1.</span> <span class="toc-text">异常错误码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.2.1.2.2.</span> <span class="toc-text">示例代码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%812"><span class="toc-number">1.3.2.1.2.3.</span> <span class="toc-text">示例代码2</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%96%E6%9E%90SEH"><span class="toc-number">1.3.3.</span> <span class="toc-text">剖析SEH</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%B7%A5%E6%B3%A8%E5%86%8CSEH"><span class="toc-number">1.3.4.</span> <span class="toc-text">手工注册SEH</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hander%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">hander处理函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E6%B3%A8%E5%86%8C%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">手动注册示例代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B9%8BVEH"><span class="toc-number">1.4.</span> <span class="toc-text">向量化异常处理之VEH</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%90%91%E9%87%8F%E5%8C%96%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.1.</span> <span class="toc-text">注册向量化函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%9B%9E%E8%B0%83%E7%9A%84%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">函数回调的原型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81-1"><span class="toc-number">1.4.3.</span> <span class="toc-text">示例代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">1.4.4.</span> <span class="toc-text">执行结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%80%BCVCH"><span class="toc-number">1.5.</span> <span class="toc-text">向量化异常处理值VCH</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81-2"><span class="toc-number">1.5.1.</span> <span class="toc-text">示例代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C-1"><span class="toc-number">1.5.2.</span> <span class="toc-text">执行结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.3.</span> <span class="toc-text">默认的异常处理函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UEH%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text">UEH异常处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SetUnHandleExceptionFilter"><span class="toc-number">1.7.</span> <span class="toc-text">SetUnHandleExceptionFilter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E8%B0%83%E7%94%A8%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.8.</span> <span class="toc-text">异常调用顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C-2"><span class="toc-number">1.8.1.</span> <span class="toc-text">执行结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.8.2.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%96%E6%9E%90Windows%E5%BC%82%E5%B8%B8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">剖析Windows异常流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%86%E6%9E%90int3"><span class="toc-number">2.1.</span> <span class="toc-text">1、分析int3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81KiTrap03"><span class="toc-number">2.2.</span> <span class="toc-text">2、KiTrap03</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81ComminDispathException"><span class="toc-number">2.3.</span> <span class="toc-text">3、ComminDispathException</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81-KiDispatchException"><span class="toc-number">2.4.</span> <span class="toc-text">4、_KiDispatchException</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KiTrap03%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">2.5.</span> <span class="toc-text">_KiTrap03源代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CommonDispatchException%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">2.6.</span> <span class="toc-text">CommonDispatchException源代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KiDispatchException%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">2.7.</span> <span class="toc-text">_KiDispatchException源代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%B1%82%E5%BC%82%E5%B8%B8%E5%88%86%E5%8F%91%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">2.8.</span> <span class="toc-text">用户层异常分发源代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WinDbg"><span class="toc-number">3.</span> <span class="toc-text">WinDbg</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%B1%82%E4%BC%9A%E8%AF%9D%E8%B0%83%E8%AF%95%E5%BB%BA%E7%AB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">用户层会话调试建立</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E5%B1%82%E8%B0%83%E8%AF%95%E4%BC%9A%E8%AF%9D%E5%BB%BA%E7%AB%8B"><span class="toc-number">3.2.</span> <span class="toc-text">内核层调试会话建立</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E6%9C%BA%E7%8E%AF%E5%A2%83%E7%9A%84%E5%BB%BA%E7%AB%8B"><span class="toc-number">3.2.1.</span> <span class="toc-text">双机环境的建立</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%B0%83%E8%AF%95%E5%99%A8%E8%B7%AF%E5%BE%84"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">设置调试器路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">设置虚拟机</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E7%9A%84%E5%BB%BA%E7%AB%8B"><span class="toc-number">3.2.2.</span> <span class="toc-text">本地内核调试的建立</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5%E8%B0%83%E8%AF%95%E6%A8%A1%E5%BC%8F%E8%BF%9B%E5%85%A5%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">以调试模式进入系统</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%95%8C%E9%9D%A2%E6%A6%82%E8%A7%88"><span class="toc-number">3.3.</span> <span class="toc-text">界面概览</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%AA%97%E5%8F%A3"><span class="toc-number">3.3.1.</span> <span class="toc-text">调试窗口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E7%AA%97%E5%8F%A3"><span class="toc-number">3.3.2.</span> <span class="toc-text">视图窗口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E6%96%87%E4%BB%B6"><span class="toc-number">3.4.</span> <span class="toc-text">符号文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%AC%A6%E5%8F%B7%E8%B7%AF%E5%BE%84"><span class="toc-number">3.4.1.</span> <span class="toc-text">设置符号路径</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">3.4.1.1.</span> <span class="toc-text">方法一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-number">3.4.1.2.</span> <span class="toc-text">方法二</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89"><span class="toc-number">3.4.1.3.</span> <span class="toc-text">方法三</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E7%AC%A6%E5%8F%B7"><span class="toc-number">3.4.2.</span> <span class="toc-text">加载符号</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E7%B3%BB%E7%BB%9F%E7%AC%A6%E5%8F%B7"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">加载系统符号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E9%80%89%E9%A1%B9"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">符号选项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95"><span class="toc-number">3.5.</span> <span class="toc-text">源码调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4"><span class="toc-number">3.6.</span> <span class="toc-text">工作空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.7.</span> <span class="toc-text">命令系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">3.7.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E5%87%86%E5%91%BD%E4%BB%A4"><span class="toc-number">3.7.2.</span> <span class="toc-text">标准命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="toc-number">3.7.3.</span> <span class="toc-text">常用基本命令</span></a></li></ol></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(/img/WindowsError.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Mr.Hu</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/projects/clock/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-bookmark"></i><span> 时光轴</span></a></div><div class="menus_item"><a class="site-page" href="/tools/"><i class="fa-fw fas fa-archive"></i><span> 工具</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 放松</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 学习</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/projects/photo/"><i class="fa-fw fas fa-images"></i><span> 照片墙</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-film"></i><span> 游戏</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/projects/game1/"><i class="fa-fw fas fa-heart"></i><span> 保卫星球</span></a></li><li><a class="site-page" href="/projects/game2/"><i class="fa-fw fas fa-heart"></i><span> 飞字快打</span></a></li><li><a class="site-page" href="/projects/game3/"><i class="fa-fw fas fa-heart"></i><span> 俄罗斯方块</span></a></li><li><a class="site-page" href="/projects/game4/"><i class="fa-fw fas fa-heart"></i><span> 特效画笔</span></a></li><li><a class="site-page" href="/projects/game5/"><i class="fa-fw fas fa-heart"></i><span> 音速小子</span></a></li><li><a class="site-page" href="/projects/game6/"><i class="fa-fw fas fa-heart"></i><span> 植物大战僵尸</span></a></li><li><a class="site-page" href="/projects/zifuyu/"><i class="fa-fw fas fa-heart"></i><span> 字符雨</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-link"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page" href="/projects/link/"><i class="fa-fw fas fa-link"></i><span> 网站导航</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user-circle"></i><span> 留言板</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">调试与异常</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-08T12:59:09.376Z" title="发表于 2020-12-08 20:59:09">2020-12-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-01-13T01:18:13.336Z" title="更新于 2021-01-13 09:18:13">2021-01-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%80%86%E5%90%91%E5%BC%80%E5%8F%91/">逆向开发</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">11.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>47分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Windows异常处理"><a href="#Windows异常处理" class="headerlink" title="Windows异常处理"></a>Windows异常处理</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>异常机制，就是为了让计算机能够更好的处理程序行期间产生的错误，从编程的角度来看，能够将错误的处理与程序的逻辑分隔开。使得我们可以集中精力开发关键功能，而把</p>
<p>程序可能出现的异常统一管理。</p>
<p> windows提供了异常处理的机制，使得你有机会挽救自己即将崩溃的程序，大体上来说</p>
<p>它提供了以下处理异常的机制：</p>
<p>SEH-结构化异常处理</p>
<p>VEH-向量化异常处理</p>
<p>VCH-向量化异常处理</p>
<h2 id="异常-amp-中断"><a href="#异常-amp-中断" class="headerlink" title="异常&amp;中断"></a>异常&amp;中断</h2><p>中断：外部硬件产生的，改变CPU执行流程的机制</p>
<p>异常：CPU内部产生的，改变CPU执行流程的机制</p>
<p>都是通过IDT统一管理</p>
<h3 id="异常分类"><a href="#异常分类" class="headerlink" title="异常分类"></a>异常分类</h3><p>错误：可以修复，EIP指向当前错误指令的位置</p>
<p>陷阱：可以修复，EIP指向错误指令下一条指令的位置</p>
<p>终止：不可修复</p>
<h2 id="结构化异常处理SEH"><a href="#结构化异常处理SEH" class="headerlink" title="结构化异常处理SEH"></a>结构化异常处理SEH</h2><p> Structed Exception Handler（结构化异常处理）称SEH，是微软提供的一种处理异常</p>
<p>的机制。</p>
<p>在VC++中，通过提供四个微软关键字使得程序员能够良好的使用这一机制，分别是： try, finally, except, _leave接下来，我们简要的介绍一下它的用法。</p>
<h3 id="try与-finally"><a href="#try与-finally" class="headerlink" title="try与 finally"></a>try与 finally</h3><p>首先出场的是_try与 __finally组合</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__try</span><br><span class="line"> &#123;</span><br><span class="line">	<span class="comment">//被保护的代码块</span></span><br><span class="line"> &#125;</span><br><span class="line">__finally</span><br><span class="line"> &#123;</span><br><span class="line">	<span class="comment">//终结处理块</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，try内的是被保护的代码块， finally内的是终结处理器，无论try内的代码以何种方式离开被保护区域，均会执行终结处理器。</p>
<p>离开被保护的代码块，就会执行终结处理块：</p>
<p>1正常方式：自己执行完代码或者执行_ leave</p>
<p>2非正常方式：产生了异常或者由于 return goto break， continue等流程控制语句离开了保护代码块。</p>
<p>在终结处理块中我们可以使用下面这个函数获取是正常方式还是非正常方式 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">AbnormalTermination</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<p>当获取到离开方式后，我们可以做出相应的判断，是继续执行程序，重新启动，释放资源还是尝试解决错误。</p>
<p>注意：在被保护区尽量使用_ leave，而不是 return</p>
<h3 id="try与except"><a href="#try与except" class="headerlink" title="try与except"></a>try与except</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__try</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;&#x2F;被保护的代码</span><br><span class="line">&#125;</span><br><span class="line">__except(&#x2F;*过滤表达式*&#x2F;)</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;&#x2F;异常处理块</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里过滤表达式的值共有三个</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EXCEPTION_EXECUTE_HANDLER      1  : 执行处理块内容，不会回到原来位置</span></span><br><span class="line"><span class="comment">//EXCEPTION_CONTINUE_SEARCH      0  : 异常处理不了了，去找其它的处理</span></span><br><span class="line"><span class="comment">//EXCEPTION_CONTINUE_EXECUTION (-1) : 不相信，回到异常位置继续执行</span></span><br></pre></td></tr></table></figure>

<p>只要被保护的代码块产生异常，就会执行except，过滤表达式的形式是任意的，比如可以是数值，可以是函数调用，可以是运算表达式，只要表达式的值为以上三个即可</p>
<h4 id="函数异常处理"><a href="#函数异常处理" class="headerlink" title="函数异常处理"></a>函数异常处理</h4><p>有两个函数在异常处理中非常有用</p>
<h5 id="第一个：-获取异常代码"><a href="#第一个：-获取异常代码" class="headerlink" title="第一个： 获取异常代码"></a>第一个： 获取异常代码</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">GetExceptionCode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>该函数的返回值代表异常类型</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXCEPTION_ACCESS_VIOLATION				<span class="comment">//表示产生的是内存访问方面的异常</span></span><br><span class="line">EXCEPTION_DATATYPE_MISALIGNMENT			<span class="comment">//</span></span><br><span class="line">EXCEPTION_BREAKPOINT					<span class="comment">//表示产生了断点方面的异常</span></span><br><span class="line">EXCEPTION_SINGLE_STEP					<span class="comment">//表示产生了单步断点方面的异常</span></span><br><span class="line">EXCEPTION_...</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h5 id="第二个：获取异常信息"><a href="#第二个：获取异常信息" class="headerlink" title="第二个：获取异常信息"></a>第二个：获取异常信息</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_EXCEPTION_POINTERS * <span class="title">GetExceptionInformation</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> struct _EXCEPTION_POINTERS</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PEXCEPTION_RECORD ExceptionRecord;</span><br><span class="line">    PCONTEXT ContextRecord;</span><br><span class="line">&#125;EXCEPTION_POINTERS,*PEXCEPTION_POINTERS;</span><br></pre></td></tr></table></figure>

<h6 id="异常错误码"><a href="#异常错误码" class="headerlink" title="异常错误码"></a>异常错误码</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* compatibility macros */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STILL_ACTIVE                        STATUS_PENDING</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_ACCESS_VIOLATION          STATUS_ACCESS_VIOLATION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_DATATYPE_MISALIGNMENT     STATUS_DATATYPE_MISALIGNMENT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_BREAKPOINT                STATUS_BREAKPOINT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_SINGLE_STEP               STATUS_SINGLE_STEP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_ARRAY_BOUNDS_EXCEEDED     STATUS_ARRAY_BOUNDS_EXCEEDED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_FLT_DENORMAL_OPERAND      STATUS_FLOAT_DENORMAL_OPERAND</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_FLT_DIVIDE_BY_ZERO        STATUS_FLOAT_DIVIDE_BY_ZERO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_FLT_INEXACT_RESULT        STATUS_FLOAT_INEXACT_RESULT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_FLT_INVALID_OPERATION     STATUS_FLOAT_INVALID_OPERATION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_FLT_OVERFLOW              STATUS_FLOAT_OVERFLOW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_FLT_STACK_CHECK           STATUS_FLOAT_STACK_CHECK</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_FLT_UNDERFLOW             STATUS_FLOAT_UNDERFLOW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_INT_DIVIDE_BY_ZERO        STATUS_INTEGER_DIVIDE_BY_ZERO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_INT_OVERFLOW              STATUS_INTEGER_OVERFLOW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_PRIV_INSTRUCTION          STATUS_PRIVILEGED_INSTRUCTION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_IN_PAGE_ERROR             STATUS_IN_PAGE_ERROR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_ILLEGAL_INSTRUCTION       STATUS_ILLEGAL_INSTRUCTION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_NONCONTINUABLE_EXCEPTION  STATUS_NONCONTINUABLE_EXCEPTION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_STACK_OVERFLOW            STATUS_STACK_OVERFLOW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_INVALID_DISPOSITION       STATUS_INVALID_DISPOSITION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_GUARD_PAGE                STATUS_GUARD_PAGE_VIOLATION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_INVALID_HANDLE            STATUS_INVALID_HANDLE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_POSSIBLE_DEADLOCK         STATUS_POSSIBLE_DEADLOCK</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONTROL_C_EXIT                      STATUS_CONTROL_C_EXIT</span></span><br></pre></td></tr></table></figure>

<h6 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">Filter</span><span class="params">(DWORD ExceptionCode, PEXCEPTION_POINTERS pExceptionInfomation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 异常信息结构体</span></span><br><span class="line">	<span class="comment">//typedef struct _EXCEPTION_RECORD &#123;</span></span><br><span class="line">	<span class="comment">//	DWORD    ExceptionCode;			 // 异常错误码</span></span><br><span class="line">	<span class="comment">//	DWORD ExceptionFlags;			 // 异常标志</span></span><br><span class="line">	<span class="comment">//	struct _EXCEPTION_RECORD* ExceptionRecord; //异常信息</span></span><br><span class="line">	<span class="comment">//	PVOID ExceptionAddress;			// 异常错误地址</span></span><br><span class="line">	<span class="comment">//	DWORD NumberParameters;			// 附加参数(内存错误时有效)</span></span><br><span class="line">	<span class="comment">//	ULONG_PTR ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS];</span></span><br><span class="line">	<span class="comment">//&#125; EXCEPTION_RECORD;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果异常是整形除零错误</span></span><br><span class="line">	<span class="keyword">if</span> (ExceptionCode == EXCEPTION_INT_DIVIDE_BY_ZERO)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 异常信息</span></span><br><span class="line">		pExceptionInfomation-&gt;ExceptionRecord;</span><br><span class="line">		<span class="comment">// 线程上下文 把a变量中内容赋值位1</span></span><br><span class="line">		*(DWORD*)(pExceptionInfomation-&gt;ContextRecord-&gt;Ebp - <span class="number">0x20</span>) = <span class="number">1</span>;</span><br><span class="line">		<span class="comment">//return EXCEPTION_CONTINUE_EXECUTION; // 不相信，继续执行</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 找下一个</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__try &#123; <span class="comment">// 外层seh</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2. __try,__except组合</span></span><br><span class="line">		__try &#123;</span><br><span class="line">			<span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">int</span> c = <span class="number">10</span> / a;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;c = %d&quot;</span>, c);</span><br><span class="line">		&#125;</span><br><span class="line">			__except (Filter(GetExceptionCode(),GetExceptionInformation())) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;这是SEH处理块\n&quot;</span>); <span class="comment">//处理块处理</span></span><br><span class="line">				&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	__except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;我是外部SEH\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c &#x3D; 10</span><br></pre></td></tr></table></figure>



<h6 id="示例代码2"><a href="#示例代码2" class="headerlink" title="示例代码2"></a>示例代码2</h6><p>结构化异常处理的嵌套</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> nStep = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Fun_B</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x, y = <span class="number">0</span>;</span><br><span class="line">    __try &#123; x = <span class="number">5</span> / y; &#125; <span class="comment">// 引发异常</span></span><br><span class="line">    __finally &#123; <span class="built_in">printf</span>(<span class="string">&quot;Step %d :执行Fun_B的finally块的内容\n&quot;</span>, nStep++); &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Fun_A</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    __try &#123; Fun_B(); &#125;</span><br><span class="line">    __finally &#123; <span class="built_in">printf</span>(<span class="string">&quot;Step %d :执行Fun_A的finally块的内容\n&quot;</span>, nStep++); &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">MyExcepteFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Step %d :执行main的异常过滤器\n&quot;</span>, nStep++);</span><br><span class="line">    <span class="keyword">return</span> EXCEPTION_EXECUTE_HANDLER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    __try &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">    __finally</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;finally\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//__try &#123; Fun_A(); &#125;</span></span><br><span class="line">    <span class="comment">//__except (MyExcepteFilter()) &#123;</span></span><br><span class="line">    <span class="comment">//    printf(&quot;Step %d :执行main的except块的内容\n&quot;, nStep++);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">finally</span><br><span class="line">Step <span class="number">1</span> :执行main的异常过滤器</span><br><span class="line">Step <span class="number">2</span> :执行Fun_B的finally块的内容</span><br><span class="line">Step <span class="number">3</span> :执行Fun_A的finally块的内容</span><br><span class="line">Step <span class="number">4</span> :执行main的except块的内容</span><br></pre></td></tr></table></figure>

<h3 id="剖析SEH"><a href="#剖析SEH" class="headerlink" title="剖析SEH"></a>剖析SEH</h3><p>我们都知道异常产生后，是先发给内核层，二Windows提供的异常处理机制，一定是在内核层发出来之后才处理的</p>
<p>Windows仅通过try，except等几个关键字就实现了接管异常，并且能够四处穿梭，而不造成程序奔溃，到底怎么实现的</p>
<p>对于线程而言，在内核层他有一个数据结构叫做ETHREAD，在用户层也有一个数据结构叫做TEB</p>
<p>在双机调试场景下，使用dt  _TEB 查看TEB结构</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _TEB</span><br><span class="line">nt!_TEB</span><br><span class="line">   +<span class="number">0</span>x000 NtTib            : _NT_TIB</span><br><span class="line">   +<span class="number">0</span>x01c EnvironmentPointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0</span>x020 ClientId         : _CLIENT_ID</span><br><span class="line">   +<span class="number">0</span>x028 ActiveRpcHandle  : Ptr32 Void</span><br><span class="line">   +<span class="number">0</span>x02c ThreadLocalStoragePointer : Ptr32 Void</span><br><span class="line">   +<span class="number">0</span>x030 ProcessEnvironmentBlock : Ptr32 _PEB</span><br><span class="line">   +<span class="number">0</span>x034 LastErrorValue   : Uint4B</span><br><span class="line">   +<span class="number">0</span>x038 CountOfOwnedCriticalSections : Uint4B</span><br><span class="line">   +<span class="number">0</span>x03c CsrClientThread  : Ptr32 Void</span><br><span class="line">   +<span class="number">0</span>x040 Win32ThreadInfo  : Ptr32 Void</span><br><span class="line">   +<span class="number">0</span>x044 User32Reserved   : [<span class="number">26</span>] Uint4B</span><br><span class="line">   +<span class="number">0</span>x0ac UserReserved     : [<span class="number">5</span>] Uint4B</span><br><span class="line">   +<span class="number">0</span>x0c0 WOW32Reserved    : Ptr32 Void</span><br><span class="line">   +<span class="number">0</span>x0c4 CurrentLocale    : Uint4B</span><br><span class="line">   +<span class="number">0</span>x0c8 FpSoftwareStatusRegister : Uint4B</span><br><span class="line">   +<span class="number">0</span>x0cc SystemReserved1  : [<span class="number">54</span>] Ptr32 Void</span><br><span class="line">   +<span class="number">0</span>x1a4 ExceptionCode    : Int4B</span><br><span class="line">   +<span class="number">0</span>x1a8 ActivationContextStackPointer : Ptr32 _ACTIVATION_CONTEXT_STACK</span><br><span class="line">   +<span class="number">0</span>x1ac SpareBytes       : [<span class="number">36</span>] UChar</span><br><span class="line">   +<span class="number">0</span>x1d0 TxFsContext      : Uint4B</span><br><span class="line">   ......</span><br></pre></td></tr></table></figure>

<p>可以看出TEB第一个字段是NtTib，而NtTib的第一个字段是ExceptionLIst，这是一个链表的头节点地址，链表元素定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">Next</span>;</span> 		<span class="comment">// 指向下一个SEH</span></span><br><span class="line">	PEXCEPTION_ROUTINE Handler; 						<span class="comment">// 异常处理函数</span></span><br><span class="line">&#125; EXCEPTION_REGISTRATION_RECORD;</span><br></pre></td></tr></table></figure>

<p>注：输入 dt _NT_TEB可查看该字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">00051810 55 push ebp</span><br><span class="line">00051811 8B EC mov ebp,esp</span><br><span class="line">00051813 6A FE push 0FFFFFFFEh</span><br><span class="line">00051815 68 D8 8E 05 00 push 58ED8h</span><br><span class="line">0005181A 68 60 1C 05 00 push offset _except_handler4 (051C60h)&#x2F;&#x2F;异常处理函数</span><br><span class="line">0005181F 64 A1 00 00 00 00 mov eax,dword ptr fs:[00000000h]&#x2F;&#x2F;异常链</span><br><span class="line">00051825 50 push eax</span><br><span class="line">00051826 81 C4 2C FF FF FF add esp,0FFFFFF2Ch</span><br><span class="line">0005182C 53 push ebx</span><br><span class="line">0005182D 56 push esi</span><br><span class="line">0005182E 57 push edi</span><br><span class="line">0005182F 8D BD 1C FF FF FF lea edi,[ebp-0E4h]</span><br><span class="line">00051835 B9 33 00 00 00 mov ecx,33h</span><br><span class="line">0005183A B8 CC CC CC CC mov eax,0CCCCCCCCh</span><br><span class="line">0005183F F3 AB rep stos dword ptr es:[edi]</span><br><span class="line">00051841 A1 04 A0 05 00 mov eax,dword ptr [__security_cookie(05A004h)]</span><br><span class="line">00051846 31 45 F8 xor dword ptr [ebp-8],eax</span><br><span class="line">00051849 33 C5 xor eax,ebp</span><br><span class="line">0005184B 50 push eax</span><br><span class="line">0005184C 8D 45 F0 lea eax,[ebp-10h]</span><br><span class="line">0005184F 64 A3 00 00 00 00 mov dword ptr fs:[00000000h],eax</span><br><span class="line">00051855 89 65 E8 mov dword ptr [ebp-18h],esp</span><br><span class="line">00051858 B9 15 C0 05 00 mov ecx,offset _AF661F63_main@cpp(05C015h)</span><br><span class="line">0005185D E8 B5 F9 FF FF call @__CheckForDebuggerJustMyCode@4(051217h)</span><br><span class="line">00051862 C7 45 FC 00 00 00 00 mov dword ptr [ebp-4],0</span><br><span class="line">00051869 C7 45 E0 00 00 00 00 mov dword ptr [ebp-20h],0</span><br><span class="line">00051870 8B 45 E0 mov eax,dword ptr [ebp-20h]</span><br><span class="line">00051873 C7 00 64 00 00 00 mov dword ptr [eax],64h</span><br><span class="line">00051879 C7 45 FC FE FF FF FF mov dword ptr [ebp-4],0FFFFFFFEh</span><br><span class="line">00051880 EB 1D jmp $LN6+17h (05189Fh) </span><br><span class="line">$LN5:</span><br><span class="line">00051882 B8 01 00 00 00 mov eax,1</span><br><span class="line">$LN7:</span><br><span class="line">00051887 C3 ret</span><br><span class="line"></span><br><span class="line">$LN6:</span><br><span class="line">00051888 8B 65 E8 mov esp,dword ptr [ebp-18h]</span><br><span class="line">0005188B 68 30 7B 05 00 push offset string &quot;__except&quot; (057B30h)</span><br><span class="line">00051890 E8 B1 F7 FF FF call _printf (051046h)</span><br><span class="line">00051895 83 C4 04 add esp,4</span><br><span class="line">00051898 C7 45 FC FE FF FF FF mov dword ptr [ebp-4],0FFFFFFFEh</span><br><span class="line">0005189F 8B F4 mov esi,esp</span><br><span class="line">000518A1 FF 15 7C B1 05 00 call dword ptr [__imp__getchar(05B17Ch)]</span><br><span class="line">000518A7 3B F4 cmp esi,esp</span><br><span class="line">000518A9 E8 73 F9 FF FF call __RTC_CheckEsp (051221h)</span><br><span class="line">000518AE 33 C0 xor eax,eax</span><br><span class="line">000518B0 8B 4D F0 mov ecx,dword ptr [ebp-10h]</span><br><span class="line">000518B3 64 89 0D 00 00 00 00 mov dword ptr fs:[0],ecx</span><br><span class="line">000518BA 59 pop ecx</span><br><span class="line">000518BB 5F pop edi</span><br><span class="line">000518BC 5E pop esi</span><br><span class="line">000518BD 5B pop ebx</span><br><span class="line">000518BE 81 C4 E4 00 00 00 add esp,0E4h</span><br><span class="line">000518C4 3B EC cmp ebp,esp</span><br><span class="line">000518C6 E8 56 F9 FF FF call __RTC_CheckEsp (051221h)</span><br><span class="line">000518CB 8B E5 mov esp,ebp</span><br><span class="line">000518CD 5D pop ebp</span><br><span class="line">000518CE C3 ret</span><br></pre></td></tr></table></figure>

<p>当异常产生时，系统会通过 FS:[0]找到这个链表，依此调用去处理异常，这才是SEH的核心原理，微软提供的关键字只是让你使用起来更加快捷</p>
<h3 id="手工注册SEH"><a href="#手工注册SEH" class="headerlink" title="手工注册SEH"></a>手工注册SEH</h3><p>了解了SEH的大致机理，我们自己就能注册SEH</p>
<h4 id="hander处理函数原型"><a href="#hander处理函数原型" class="headerlink" title="hander处理函数原型"></a>hander处理函数原型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LONG NTAPI</span><br><span class="line">EXCEPTION_ROUTINE (</span><br><span class="line">_Inout_ struct _EXCEPTION_RECORD *ExceptionRecord, 	<span class="comment">//异常信息</span></span><br><span class="line">_In_ PVOID EstablisherFrame, 						<span class="comment">//陷阱帧</span></span><br><span class="line">_Inout_ struct _CONTEXT *ContextRecord, 			<span class="comment">//线程上下文</span></span><br><span class="line">_In_ PVOID DispatcherContext 						<span class="comment">//异常分发上下文（系统使用）</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="手动注册示例代码"><a href="#手动注册示例代码" class="headerlink" title="手动注册示例代码"></a>手动注册示例代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// 异常链中节点</span></span><br><span class="line"><span class="comment">//typedef struct _EXCEPTION_REGISTRATION_RECORD &#123;</span></span><br><span class="line"><span class="comment">// struct _EXCEPTION_REGISTRATION_RECORD* Next; // 指向下一个SEH02 </span></span><br><span class="line"><span class="comment">// PEXCEPTION_ROUTINE Handler; // 异常处理函数</span></span><br><span class="line"><span class="comment">//&#125; EXCEPTION_REGISTRATION_RECORD;</span></span><br><span class="line"><span class="keyword">int</span> g_number;</span><br><span class="line"><span class="comment">// 异常处理函数</span></span><br><span class="line"><span class="function">EXCEPTION_DISPOSITION NTAPI <span class="title">SEH_Handler</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">_Inout_ struct _EXCEPTION_RECORD* ExceptionRecord, <span class="comment">//异常信息</span></span></span></span><br><span class="line"><span class="function"><span class="params">_In_ PVOID EstablisherFrame, <span class="comment">//陷阱帧</span></span></span></span><br><span class="line"><span class="function"><span class="params">_Inout_ struct _CONTEXT* ContextRecord, <span class="comment">//线程上下文</span></span></span></span><br><span class="line"><span class="function"><span class="params">_In_ PVOID DispatcherContext <span class="comment">//异常分发上下文（系统使用）</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span> </span>&#123;</span><br><span class="line">ContextRecord-&gt;Eax = (DWORD)&amp;g_number;</span><br><span class="line"><span class="comment">// ExceptionContinueExecution 0 继续执行</span></span><br><span class="line"><span class="comment">// ExceptionContinueSearch, 1 查找下一个异常</span></span><br><span class="line"><span class="keyword">return</span> ExceptionContinueExecution;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// SEH基于栈上的异常处理</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 1.构建一个_EXCEPTION_REGISTRATION_RECORD结构体</span></span><br><span class="line"><span class="comment">// 2.将这个结构体插入到异常链中</span></span><br><span class="line"><span class="comment">// [next]</span></span><br><span class="line"><span class="comment">// [hanlder]</span></span><br><span class="line">_asm</span><br><span class="line">&#123;</span><br><span class="line">push SEH_Handler; <span class="comment">// 异常处理函数</span></span><br><span class="line">mov eax, fs: [<span class="number">0</span>] ; <span class="comment">// 获取next节点</span></span><br><span class="line">push eax; <span class="comment">// 压入next节点</span></span><br><span class="line">mov fs:[<span class="number">0</span>],esp; <span class="comment">// 插入到异常链表中</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 添加SEH</span></span><br><span class="line"><span class="keyword">int</span>* p = <span class="literal">NULL</span>;</span><br><span class="line">*p = <span class="number">100</span>;</span><br><span class="line"><span class="comment">// 3. 卸载SEH异常节点</span></span><br><span class="line">_asm</span><br><span class="line">&#123;</span><br><span class="line">mov eax, fs: [<span class="number">0</span>] ; <span class="comment">// 获取第一个异常节点</span></span><br><span class="line">mov eax, [eax]; <span class="comment">// 异常节点的第一个字段（Next）</span></span><br><span class="line">mov fs : [<span class="number">0</span>] , eax; <span class="comment">// 删除第一个节点</span></span><br><span class="line">add esp, <span class="number">0x08</span>; <span class="comment">// 平衡堆栈</span></span><br><span class="line">&#125;</span><br><span class="line">getchar();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="向量化异常处理之VEH"><a href="#向量化异常处理之VEH" class="headerlink" title="向量化异常处理之VEH"></a>向量化异常处理之VEH</h2><p>相对于结构化异常处理的作用范围，向量化异常处理就显得很大气了。这种异常处理方式是全局的，一经注册，全进程有效，使用方便，居家旅行</p>
<p>VEH是向量化异常处理, 使用AddVectorExceptionHandle来设置</p>
<p>使用向量化异常只需要我们提供一个回调函数，然后用一个API注册一下即可。以后不管进程内发生了什么异常，都会来调用你的回调函数。</p>
<p>常见的向量化有两种形式：VEH和VCH。</p>
<p>对于VEH来说，我们首先需要知道一个API</p>
<h3 id="注册向量化函数"><a href="#注册向量化函数" class="headerlink" title="注册向量化函数"></a>注册向量化函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PVOID</span><br><span class="line">WINAPI</span><br><span class="line">AddVectoredExceptionHandler(</span><br><span class="line">    _In_ ULONG First,</span><br><span class="line">    _In_ PVECTORED_EXCEPTION_HANDLER Handler</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//参数1:异常处理函数被调用的顺序</span></span><br><span class="line">    <span class="comment">//参数2:异常处理回调函数</span></span><br></pre></td></tr></table></figure>

<h3 id="函数回调的原型"><a href="#函数回调的原型" class="headerlink" title="函数回调的原型"></a>函数回调的原型</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">LONG</span> <span class="params">(NTAPI *PVECTORED_EXCEPTION_HANDLER)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    struct _EXCEPTION_POINTERS *ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">回调函数的返回值只有两种情况</span></span><br><span class="line"><span class="comment">EXCEPTION_CONTINUE_EXECUTION (-1)		: 继续执行</span></span><br><span class="line"><span class="comment">EXCEPTION_CONTINUE_SEARCH (0)			:继续搜索</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">LONG NTAPI  <span class="title">veh_handler1</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	struct _EXCEPTION_POINTERS* ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;VEH 1 执行 \n&quot;</span>);</span><br><span class="line">	<span class="comment">// 如果异常是整形除零错误</span></span><br><span class="line">	<span class="keyword">if</span> (ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionCode == EXCEPTION_INT_DIVIDE_BY_ZERO)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 线程上下文 把a变量中内容赋值位1</span></span><br><span class="line">		a = <span class="number">100</span>;</span><br><span class="line">		<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION; <span class="comment">// 不相信，继续执行</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回值 两种方式</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;		<span class="comment">// 0处理不了，找其VEH处理</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;	<span class="comment">// -1，处理了，回到异常位置继续执行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LONG NTAPI  <span class="title">veh_handler2</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	struct _EXCEPTION_POINTERS* ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;VEH 2  执行 \n&quot;</span>);</span><br><span class="line">	<span class="comment">// 返回值 两种方式</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;		<span class="comment">// 0处理不了，找其VEH处理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SEH处理函数</span></span><br><span class="line"><span class="function">DWORD <span class="title">SEH_handler</span><span class="params">(PEXCEPTION_POINTERS pInfomation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;SEH 异常处理执行 \n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异常处理顺序-》 VEH-&gt;SEH</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 使用veh注册向量化异常处理函数</span></span><br><span class="line">	<span class="comment">// 说全进程有效</span></span><br><span class="line">	AddVectoredExceptionHandler(</span><br><span class="line">		TRUE,					<span class="comment">//调用VEH顺序</span></span><br><span class="line">		veh_handler1			<span class="comment">//veh回调函数</span></span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	AddVectoredExceptionHandler(</span><br><span class="line">		TRUE,					<span class="comment">//调用VEH顺序</span></span><br><span class="line">		veh_handler2			<span class="comment">//veh回调函数</span></span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	__try &#123;</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">int</span> c = <span class="number">10</span> / a;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;c = %d&quot;</span>, c);</span><br><span class="line">	&#125;</span><br><span class="line">	__except (SEH_handler(GetExceptionInformation()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;SEH处理块\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VEH <span class="number">2</span>  执行</span><br><span class="line">VEH <span class="number">1</span> 执行</span><br><span class="line">c = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="向量化异常处理值VCH"><a href="#向量化异常处理值VCH" class="headerlink" title="向量化异常处理值VCH"></a>向量化异常处理值VCH</h2><p>同VEH一样，也是需要一个API和同一个回调函数，不过仅仅只是函数名字不一样而已</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PVOID</span><br><span class="line">WINAPI</span><br><span class="line">AddVectoredContinueHandler(</span><br><span class="line">    _In_ ULONG First,</span><br><span class="line">    _In_ PVECTORED_EXCEPTION_HANDLER Handler</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<p>回调函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">LONG</span> <span class="params">(NTAPI *PVECTORED_EXCEPTION_HANDLER)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    struct _EXCEPTION_POINTERS *ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">LONG NTAPI  <span class="title">vch_handler1</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	struct _EXCEPTION_POINTERS* ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;VCH 1 执行 \n&quot;</span>);</span><br><span class="line">	<span class="comment">// 如果异常是整形除零错误</span></span><br><span class="line">	<span class="comment">//if (ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionCode == EXCEPTION_INT_DIVIDE_BY_ZERO)</span></span><br><span class="line">	<span class="comment">//&#123;</span></span><br><span class="line">	<span class="comment">//	// 线程上下文 把a变量中内容赋值位1</span></span><br><span class="line">	<span class="comment">//	a = 100;</span></span><br><span class="line">	<span class="comment">//	return EXCEPTION_CONTINUE_EXECUTION; // 不相信，继续执行</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回值 两种方式</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;		<span class="comment">// 0处理不了，找其VEH处理</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;	<span class="comment">// -1，处理了，回到异常位置继续执行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// SEH处理函数</span></span><br><span class="line"><span class="function">DWORD <span class="title">SEH_handler</span><span class="params">(PEXCEPTION_POINTERS pInfomation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;SEH 异常处理执行 \n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_EXECUTE_HANDLER; <span class="comment">// 在exception处理块处理</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 异常处理流程： SEH-&gt;VCH</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 使用vch注册向量化异常处理函数</span></span><br><span class="line">	<span class="comment">// 说全进程有效</span></span><br><span class="line">		AddVectoredContinueHandler(</span><br><span class="line">		TRUE,					<span class="comment">//调用VCH顺序</span></span><br><span class="line">		vch_handler1			<span class="comment">//vch回调函数</span></span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	__try &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> c = <span class="number">10</span> / a;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;c = %d&quot;</span>, c);</span><br><span class="line">	&#125;</span><br><span class="line">	__except (SEH_handler(GetExceptionInformation()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;SEH处理块\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行结果-1"><a href="#执行结果-1" class="headerlink" title="执行结果"></a>执行结果</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SEH 异常处理执行</span><br><span class="line">SEH处理块</span><br></pre></td></tr></table></figure>

<h3 id="默认的异常处理函数"><a href="#默认的异常处理函数" class="headerlink" title="默认的异常处理函数"></a>默认的异常处理函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SetUnhandledExceptionFilter(</span><br><span class="line">    _In_opt_ LPTOP_LEVEL_EXCEPTION_FILTER lpTopLevelExceptionFilter</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<p>回调函数原型</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">LONG</span> <span class="params">(WINAPI *PTOP_LEVEL_EXCEPTION_FILTER)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    _In_ struct _EXCEPTION_POINTERS *ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="UEH异常处理"><a href="#UEH异常处理" class="headerlink" title="UEH异常处理"></a>UEH异常处理</h2><p>示例代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">LONG NTAPI  <span class="title">ueh_handler1</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	struct _EXCEPTION_POINTERS* ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ueh 1 执行 \n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回值 两种方式</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;		<span class="comment">// 0处理不了，找其VEH处理</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;	<span class="comment">// -1，处理了，回到异常位置继续执行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SEH处理函数</span></span><br><span class="line"><span class="function">DWORD <span class="title">SEH_handler</span><span class="params">(PEXCEPTION_POINTERS pInfomation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;SEH 异常处理执行 \n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 1.设置一个默认SEH处理函数（UEH）</span></span><br><span class="line">	<span class="comment">// 2. UEH只有在没有调试器的情况下执行(反调试)</span></span><br><span class="line">	SetUnhandledExceptionFilter(ueh_handler1);</span><br><span class="line"></span><br><span class="line">	__try &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> c = <span class="number">10</span> / a;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;c = %d&quot;</span>, c);</span><br><span class="line">	&#125;</span><br><span class="line">	__except (SEH_handler(GetExceptionInformation()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;SEH处理块\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一直没有处理</p>
<p>执行结果，（不会结束）</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SEH 异常处理执行</span><br></pre></td></tr></table></figure>

<h2 id="SetUnHandleExceptionFilter"><a href="#SetUnHandleExceptionFilter" class="headerlink" title="SetUnHandleExceptionFilter"></a>SetUnHandleExceptionFilter</h2><p>设置一个最后的异常处理函数. 这个异常处理函数在所有的VEH,SEH都没有成功处理异常时会被调用.<br>   注意：在进程被调试时,被设置的UEH异常处理函数不会被调用，因为这个差异，此机制也会被用于反调试.</p>
<h2 id="异常调用顺序"><a href="#异常调用顺序" class="headerlink" title="异常调用顺序"></a>异常调用顺序</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line"><span class="function">LONG NTAPI  <span class="title">VEH_handler1</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	struct _EXCEPTION_POINTERS* ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;VEH 1 执行 \n&quot;</span>);</span><br><span class="line">	a = <span class="number">100</span>;</span><br><span class="line">	<span class="comment">//return EXCEPTION_CONTINUE_EXECUTION; //处理了</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;		<span class="comment">// 0处理不了，找其VEH处理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LONG NTAPI  <span class="title">VCH_handler1</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	struct _EXCEPTION_POINTERS* ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;VCH 1 执行 \n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;		<span class="comment">// 0处理不了，找其VEH处理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LONG NTAPI  <span class="title">SEH_handler1</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	struct _EXCEPTION_POINTERS* ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;SEH 1 执行 \n&quot;</span>);</span><br><span class="line">	a = <span class="number">100</span>;</span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;</span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;		<span class="comment">// 0处理不了，找其VEH处理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LONG NTAPI  <span class="title">UEH_handler1</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	struct _EXCEPTION_POINTERS* ExceptionInfo</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;UEH 1 执行 \n&quot;</span>);</span><br><span class="line">	a = <span class="number">100</span>;</span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;		<span class="comment">// 0处理不了，找其VEH处理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 执行顺序（最重要）</span></span><br><span class="line">	<span class="comment">// VEH -&gt; SEH -&gt; UEH -&gt; VCH</span></span><br><span class="line">	<span class="comment">// 没有调试器条件下</span></span><br><span class="line">	<span class="comment">//	VEH 可以处理 - 会调用VCH</span></span><br><span class="line">	<span class="comment">//  VEH 不能处理，SEH能执行 - 调用VCH</span></span><br><span class="line">	<span class="comment">//  VEH 不能处理，SEH不能处理，UEH能执行 - 调用VCH</span></span><br><span class="line">	<span class="comment">//  VEH，SEH,UEH都不能处理，VCH不会调用</span></span><br><span class="line">	<span class="comment">// 有调试器条件下</span></span><br><span class="line">	<span class="comment">// VEH 处理了-》会调用VCH</span></span><br><span class="line">	<span class="comment">// VEH 没有处理，SEH 处理了/没有处理 -》 都调用VCH</span></span><br><span class="line">	<span class="comment">// VEH 没有处理，SEH 处理了/没有处理 -》 都调用VCH</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	AddVectoredExceptionHandler(TRUE, VEH_handler1);</span><br><span class="line">	<span class="comment">//AddVectoredContinueHandler(TRUE, VCH_handler1);</span></span><br><span class="line">	SetUnhandledExceptionFilter(UEH_handler1);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	__try &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> c = <span class="number">10</span> / a;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;c = %d&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	__except (SEH_handler1(GetExceptionInformation()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;SEH处理块\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行结果-2"><a href="#执行结果-2" class="headerlink" title="执行结果"></a>执行结果</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VEH <span class="number">1</span> 执行</span><br><span class="line">SEH <span class="number">1</span> 执行</span><br><span class="line">c = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>一、当异常交由用户处理时，按照一下顺序调用异常处理方式：VEH -&gt; SEH -&gt; UEH -&gt; VCH</p>
<p>二、当VEH表示处理了异常，就不会传递给SEH，但是会传递给VCH</p>
<p>三、当VEH没有处理了，就会传递给SEH</p>
<p>四、当SEH所有异常函数没有能够处理异常，会调用默认的SEH处理函数</p>
<p>五、当SEH处理了异常，从except开始执行，就不会在将异常传递给VCH</p>
<p>六、当SEH返回异常产生处执行，在返回之前会调用VCH</p>
<h1 id="剖析Windows异常流程"><a href="#剖析Windows异常流程" class="headerlink" title="剖析Windows异常流程"></a>剖析Windows异常流程</h1><img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/WindowsException.jpg" title="Mr_Hu">

<p>CPU会根据中断类型号转而执行对应的中断处理程序。CPU会在IDT中查找对应的函数来处理，各个异常处理函数不仅仅处理异常还需要将异常信息封装，以便对后续处理。</p>
<p>例如：处理int3异常</p>
<h2 id="1、分析int3"><a href="#1、分析int3" class="headerlink" title="1、分析int3"></a>1、分析int3</h2><p>​        通过中断描述符表(IDT)的第三项对应的处理函数（KiTrap03）</p>
<h2 id="2、KiTrap03"><a href="#2、KiTrap03" class="headerlink" title="2、KiTrap03"></a>2、KiTrap03</h2><p>​        在开始处理之初，先构造TRAP_FRAME陷阱帧结构，陷阱帧是一个结构体，用来保存系统调用、中断、异常发生时的寄存器现场，方便以后回到用户空间/回到中断处时，恢复寄存器的值，从而继续执行。结构构造完成后会调用ComminDispathException函数</p>
<h2 id="3、ComminDispathException"><a href="#3、ComminDispathException" class="headerlink" title="3、ComminDispathException"></a>3、ComminDispathException</h2><p>​    注意：eax保存异常码 0x80000003</p>
<p>​                ebx保存异常地址</p>
<p>​                ecx保存异常附加参数个数</p>
<p>​    ComminDispathException函数会在栈中分配一个EXCEPTION_RECORD结构，并把异常信息存储到该结构中，之后他会调用_KiDispatchException函数来分发异常</p>
<p>​    EXCEPTION_POINTERS结构体 , 这个结构体中, 有两个结构体, 一个是CONTEXT结构体,保存的是产生异常时所有寄存器的值. 另一个结构体是EXCEPTION_RECORD,保存有异常类型(ExceptionCode),异常产生的地址(ExceptionAddress).</p>
<h2 id="4、-KiDispatchException"><a href="#4、-KiDispatchException" class="headerlink" title="4、_KiDispatchException"></a>4、_KiDispatchException</h2><p>​                参数1：ecx 保存 ExceptionRecord结构体地址 </p>
<p>​                参数2: 0 空异常异常栈帧 </p>
<p>​                参数3：ebp保存陷阱帧 </p>
<p>​                参数4：eax保存异常发生的模式（内核、用户） </p>
<p>​                参数5：1 异常分发次数</p>
<p>​        不管什么异常最后都会调用内核中的KiDispatchExcption函数进行分发，也就是说Windows用统一的方式来管理。异常封装完成后，系统会调用nt!KiDispatchException来处理异常，所以分析KiDispatchException函数就可以了解异常是如何被处理的。                </p>
<p>1、构建一个ContextFrame ，从陷阱帧中获取寄存器信息</p>
<p>2、判断内核模式还是用户模式:</p>
<p>​    一、内核模式</p>
<p>​        1 判断是否第一次触发</p>
<p>​            1))) 是否有内核调试器，有就发给内核调试器</p>
<p>​            2))) 再发给内核的SEH处理</p>
<p>​        2 第二次触发</p>
<p>​            1))) 发给内核调试器</p>
<p>​            2))) 内核调试器没有处理就蓝屏</p>
<p>​        二、 用户模式</p>
<p>​            1 判断是否第一次触发</p>
<p>​                1)))  判断判断内核调试器</p>
<p>​                2))) 没有用户调试器就调用内核调试器</p>
<p>​                3))) 有用户调试器就发给用户调试器</p>
<p>​                4))) 将内核的CONTEXT，EXCEPTION_RECORD拷贝到用户栈</p>
<p>​                5))) 用户层异常处理KeUserExceptionDispatcher</p>
<p>​            2 第二次触发</p>
<p>​                1))) 将异常发给调试器    </p>
<p>​                2))) 结束进程</p>
<p>KeUserExceptionDispatcher</p>
<ul>
<li><p>用户从异常分发</p>
<ul>
<li><ul>
<li>交给VEH-&gt;SEH-&gt;UEH-&gt;VCH </li>
<li>有一个异常处理机制处理了，通过ZwContinue恢复程序继续执行</li>
<li> 没有处理，通过ZwRaiseException主动抛出第二次异常</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="KiTrap03源代码"><a href="#KiTrap03源代码" class="headerlink" title="_KiTrap03源代码"></a>_KiTrap03源代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">_KiTrap03       proc</span><br><span class="line">        push    0                       ; push dummy error code</span><br><span class="line">		</span><br><span class="line">		; ENTER_TRAP 是一个宏, 用于开辟栈帧保存一些东西</span><br><span class="line">        ENTER_TRAP      kit3_a, kit3_t</span><br><span class="line"></span><br><span class="line">        cmp     ds:_PoHiberInProgress, 0</span><br><span class="line">        jnz     short kit03_01</span><br><span class="line"></span><br><span class="line">   lock inc     ds:_KiHardwareTrigger   ; trip hardware analyzer</span><br><span class="line"></span><br><span class="line">kit03_01:</span><br><span class="line">        mov     eax, BREAKPOINT_BREAK   ; BREAKPOINT_BREAK equ 00000H</span><br><span class="line"></span><br><span class="line">KiTrap03DebugService:</span><br><span class="line">;</span><br><span class="line">; If caller is user mode, we want interrupts back on.</span><br><span class="line">;   . all relevant state has already been saved</span><br><span class="line">;   . user mode code always runs with ints on</span><br><span class="line">;</span><br><span class="line">; If caller is kernel mode, we want them off!</span><br><span class="line">;   . some state still in registers, must prevent races</span><br><span class="line">;   . kernel mode code can run with ints off</span><br><span class="line">;</span><br><span class="line">;</span><br><span class="line">; Arguments:</span><br><span class="line">;     eax - ServiceClass - which call is to be performed</span><br><span class="line">;     ecx - Arg1 - generic first argument</span><br><span class="line">;     edx - Arg2 - generic second argument</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">.errnz (EFLAGS_V86_MASK AND 0FF00FFFFh)</span><br><span class="line">        test    byte ptr [ebp]+TsEFlags+2,EFLAGS_V86_MASK&#x2F;010000h ;检查是否在虚拟8086模式产生</span><br><span class="line">        jnz     kit03_30                ; fault occured in V86 mode &#x3D;&gt; Usermode</span><br><span class="line"></span><br><span class="line">.errnz (MODE_MASK AND 0FFFFFF00h)</span><br><span class="line">        test    byte ptr [ebp]+TsSegCs,MODE_MASK;</span><br><span class="line">        jz      kit03_10</span><br><span class="line"></span><br><span class="line">        cmp     word ptr [ebp]+TsSegCs,KGDT_R3_CODE OR RPL_MASK </span><br><span class="line">        jne     kit03_30</span><br><span class="line"></span><br><span class="line">kit03_05:</span><br><span class="line">        sti</span><br><span class="line">kit03_10:</span><br><span class="line"></span><br><span class="line">; 调用CommonDispatchException函数, 并将参数通过寄存器传递过去,</span><br><span class="line">; CommonDispatchException函数的参数是: </span><br><span class="line">;    (eax) &#x3D; 异常代码 </span><br><span class="line">;    (ebx) &#x3D; 异常地址 </span><br><span class="line">;    (ecx) &#x3D; 附加参数的个数</span><br><span class="line">;    (edx) &#x3D; Parameter1(附加参数1)</span><br><span class="line">;    (esi) &#x3D; Parameter2(附加参数2)</span><br><span class="line">;    (edi) &#x3D; Parameter3(附加参数3)</span><br><span class="line">;</span><br><span class="line">; Set up exception record and arguments for raising breakpoint exception</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">        mov     esi, ecx                ; ExceptionInfo 2 附加参数2</span><br><span class="line">        mov     edi, edx                ; ExceptionInfo 3 附加参数3</span><br><span class="line">        mov     edx, eax                ; ExceptionInfo 1 附加参数1</span><br><span class="line"></span><br><span class="line">        mov     ebx, [ebp]+TsEip</span><br><span class="line">        dec     ebx                     ; (ebx)-&gt; int3 instruction,陷阱异常,需要将异常发生的地址减int3指令的长度(1)</span><br><span class="line">        mov     ecx, 3				    ; 附加参数的个数</span><br><span class="line">        mov     eax, STATUS_BREAKPOINT  ; STATUS_BREAKPOINT equ 0x80000003h</span><br><span class="line">        call    CommonDispatchException ; Never return</span><br></pre></td></tr></table></figure>

<h2 id="CommonDispatchException源代码"><a href="#CommonDispatchException源代码" class="headerlink" title="CommonDispatchException源代码"></a>CommonDispatchException源代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> proc            ; 函数开始位置</span><br><span class="line">cPublicFpo 0, ExceptionRecordLength&#x2F;4</span><br><span class="line">;</span><br><span class="line">;       Set up exception record for raising exception</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">        sub     esp, ExceptionRecordLength	; 在栈中开辟异常记录所需的栈空间</span><br><span class="line">                                        ; allocate exception record</span><br><span class="line">        mov     dword ptr [esp]+ErExceptionCode, eax ; 设置异常代码,写入到栈空间中异常记录结构体变量中.</span><br><span class="line">                                        ; set up exception code</span><br><span class="line">        xor     eax, eax</span><br><span class="line">        mov     dword ptr [esp]+ErExceptionFlags, eax ; 设置异常标志(清0)</span><br><span class="line">                                        ; set exception flags</span><br><span class="line">        mov     dword ptr [esp]+ErExceptionRecord, eax</span><br><span class="line">                                        ; set associated exception record</span><br><span class="line">        mov     dword ptr [esp]+ErExceptionAddress, ebx ; 设置异常地址</span><br><span class="line">        mov     dword ptr [esp]+ErNumberParameters, ecx; 附加参数个数</span><br><span class="line">                                        ; set number of parameters</span><br><span class="line">        cmp     ecx, 0</span><br><span class="line">        je      short de00</span><br><span class="line"></span><br><span class="line">        lea     ebx, [esp + ErExceptionInformation] ; 取结构体变量的首地址</span><br><span class="line">        mov     [ebx], edx		; 将附加参数1存入到结构体中</span><br><span class="line">        mov     [ebx+4], esi	; 将附加参数2存入到结构体中</span><br><span class="line">        mov     [ebx+8], edi    ; 将附加参数3存入到结构体中</span><br><span class="line">de00:</span><br><span class="line">;</span><br><span class="line">; set up arguments and call _KiDispatchException</span><br><span class="line">;</span><br><span class="line">		; 将异常记录结构体首地址存入ecx中.</span><br><span class="line">        mov     ecx, esp                ; (ecx)-&gt;exception record</span><br><span class="line"></span><br><span class="line">		; 判断异常发生的模式</span><br><span class="line">.errnz (EFLAGS_V86_MASK AND 0FF00FFFFh)</span><br><span class="line">        test    byte ptr [ebp]+TsEFlags+2,EFLAGS_V86_MASK&#x2F;010000h</span><br><span class="line">        jz      short de10</span><br><span class="line"></span><br><span class="line">        mov     eax,0FFFFh</span><br><span class="line">        jmp     short de20</span><br><span class="line"></span><br><span class="line">de10:   mov     eax,[ebp]+TsSegCs</span><br><span class="line">de20:   and     eax,MODE_MASK</span><br><span class="line"></span><br><span class="line">		; 调用函数来分发异常</span><br><span class="line">		; ecx - exception record addr 异常记录结构体地址</span><br><span class="line">		; 0 -  Null exception frame  空的异常栈帧</span><br><span class="line">		; ebp - trap frame addr 异常记录帧</span><br><span class="line">		; eax - PreviousMode 异常发生的模式(内核层或用户层)</span><br><span class="line">		; 1 - first chance TRUE  第一次异常</span><br><span class="line">        stdCall _KiDispatchException,&lt;ecx, 0, ebp, eax, 1&gt;</span><br><span class="line">		</span><br><span class="line">		; 恢复栈顶</span><br><span class="line">        mov     esp, ebp                ; (esp) -&gt; trap frame</span><br><span class="line">        jmp     _KiExceptionExit</span><br><span class="line"></span><br><span class="line">CommonDispatchException endp</span><br></pre></td></tr></table></figure>

<h2 id="KiDispatchException源代码"><a href="#KiDispatchException源代码" class="headerlink" title="_KiDispatchException源代码"></a>_KiDispatchException源代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br></pre></td><td class="code"><pre><span class="line">VOID</span><br><span class="line">KiDispatchException (</span><br><span class="line">    IN PEXCEPTION_RECORD ExceptionRecord,</span><br><span class="line">    IN PKEXCEPTION_FRAME ExceptionFrame,</span><br><span class="line">    IN PKTRAP_FRAME TrapFrame,</span><br><span class="line">    IN KPROCESSOR_MODE PreviousMode,</span><br><span class="line">    IN BOOLEAN FirstChance</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Routine Description:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    This function is called to dispatch an exception to the proper mode and</span></span><br><span class="line"><span class="comment">    to cause the exception dispatcher to be called. If the previous mode is</span></span><br><span class="line"><span class="comment">    kernel, then the exception dispatcher is called directly to process the</span></span><br><span class="line"><span class="comment">    exception. Otherwise the exception record, exception frame, and trap</span></span><br><span class="line"><span class="comment">    frame contents are copied to the user mode stack. The contents of the</span></span><br><span class="line"><span class="comment">    exception frame and trap are then modified such that when control is</span></span><br><span class="line"><span class="comment">    returned, execution will commense in user mode in a routine which will</span></span><br><span class="line"><span class="comment">    call the exception dispatcher.</span></span><br><span class="line"><span class="comment">	该函数用于分发异常, 根据异常所产生的模式找到异常的处理函数. 如果异常发生在</span></span><br><span class="line"><span class="comment">	内核模式, 函数会直接调用一个异常处理函数直接处理异常. 如果异常发生在用户模</span></span><br><span class="line"><span class="comment">	式, 则函数会将异常记录, 异常栈帧, 和陷阱栈帧拷贝到用户模式的线程的栈 (这些</span></span><br><span class="line"><span class="comment">	信息在用户态可以被修改, 被修改后会重新设置到线程环境上), 随后函数会进入到用</span></span><br><span class="line"><span class="comment">	户态, 到了用户态之后会又专门的函数去处理异常.</span></span><br><span class="line"><span class="comment">Arguments:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame. For NT386,</span></span><br><span class="line"><span class="comment">        this should be NULL.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    PreviousMode - Supplies the previous processor mode.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    FirstChance - Supplies a boolean value that specifies whether this is</span></span><br><span class="line"><span class="comment">        the first (TRUE) or second (FALSE) chance for the exception.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Return Value:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    None.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    CONTEXT ContextFrame; <span class="comment">// 线程环境块</span></span><br><span class="line">    EXCEPTION_RECORD ExceptionRecord1, ExceptionRecord2; <span class="comment">// 异常记录块</span></span><br><span class="line">    LONG Length; </span><br><span class="line">    ULONG UserStack1; <span class="comment">// 保存用户态中栈上的一个地址</span></span><br><span class="line">    ULONG UserStack2; <span class="comment">// 保存用户态中栈上的一个地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Move machine state from trap and exception frames to a context frame,</span></span><br><span class="line">    <span class="comment">// and increment the number of exceptions dispatched.</span></span><br><span class="line">	<span class="comment">// 获取发生异常的线程的线程上下文,输出到ContextRecord结构体变量中.</span></span><br><span class="line"></span><br><span class="line">    KeGetCurrentPrcb()-&gt;KeExceptionDispatchCount += <span class="number">1</span>;</span><br><span class="line">    ContextFrame.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((PreviousMode == UserMode) || KdDebuggerEnabled) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// For usermode exceptions always try to dispatch the floating</span></span><br><span class="line">        <span class="comment">// point state.  This allows exception handlers &amp; debuggers to</span></span><br><span class="line">        <span class="comment">// examine/edit the npx context if required.  Plus it allows</span></span><br><span class="line">        <span class="comment">// exception handlers to use fp instructions without destroying</span></span><br><span class="line">        <span class="comment">// the npx state at the time of the exception.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Note: If there&#x27;s no 80387, ContextTo/FromKFrames will use the</span></span><br><span class="line">        <span class="comment">// emulator&#x27;s current state.  If the emulator can not give the</span></span><br><span class="line">        <span class="comment">// current state, then the context_floating_point bit will be</span></span><br><span class="line">        <span class="comment">// turned off by ContextFromKFrames.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        ContextFrame.ContextFlags |= CONTEXT_FLOATING_POINT;</span><br><span class="line">        <span class="keyword">if</span> (KeI386XMMIPresent) &#123;</span><br><span class="line">            ContextFrame.ContextFlags |= CONTEXT_EXTENDED_REGISTERS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//陷阱帧中获取寄存器信息</span></span><br><span class="line">    KeContextFromKframes(TrapFrame, ExceptionFrame, &amp;ContextFrame);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// if it is BREAK_POINT exception, we subtract 1 from EIP and report</span></span><br><span class="line">    <span class="comment">// the updated EIP to user.  This is because Cruiser requires EIP</span></span><br><span class="line">    <span class="comment">// points to the int 3 instruction (not the instruction following int 3).</span></span><br><span class="line">    <span class="comment">// In this case, BreakPoint exception is fatal. Otherwise we will step</span></span><br><span class="line">    <span class="comment">// on the int 3 over and over again, if user does not handle it</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// if the BREAK_POINT occured in V86 mode, the debugger running in the</span></span><br><span class="line">    <span class="comment">// VDM will expect CS:EIP to point after the exception (the way the</span></span><br><span class="line">    <span class="comment">// processor left it.  this is also true for protected mode dos</span></span><br><span class="line">    <span class="comment">// app debuggers.  We will need a way to detect this.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (ExceptionRecord-&gt;ExceptionCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> STATUS_BREAKPOINT:  <span class="comment">// 断点异常就将eip减到int3指令所在的首地址</span></span><br><span class="line">            ContextFrame.Eip--;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> KI_EXCEPTION_ACCESS_VIOLATION: <span class="comment">// 内存访问异常, 设置附加参数</span></span><br><span class="line">            ExceptionRecord-&gt;ExceptionCode = STATUS_ACCESS_VIOLATION;</span><br><span class="line">            <span class="keyword">if</span> (PreviousMode == UserMode) &#123;</span><br><span class="line">                <span class="keyword">if</span> (KiCheckForAtlThunk(ExceptionRecord,&amp;ContextFrame) != FALSE) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> Handled1;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((SharedUserData-&gt;ProcessorFeatures[PF_NX_ENABLED] == TRUE) &amp;&amp;</span><br><span class="line">                    (ExceptionRecord-&gt;ExceptionInformation [<span class="number">0</span>] == EXCEPTION_EXECUTE_FAULT)) &#123;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (((KeFeatureBits &amp; KF_GLOBAL_32BIT_EXECUTE) != <span class="number">0</span>) ||</span><br><span class="line">                        (PsGetCurrentProcess()-&gt;Pcb.Flags.ExecuteEnable != <span class="number">0</span>) || <span class="comment">// 启用执行属性</span></span><br><span class="line">                        (((KeFeatureBits &amp; KF_GLOBAL_32BIT_NOEXECUTE) == <span class="number">0</span>) &amp;&amp;</span><br><span class="line">                         (PsGetCurrentProcess()-&gt;Pcb.Flags.ExecuteDisable == <span class="number">0</span>))) &#123; <span class="comment">// 禁用执行属性</span></span><br><span class="line">                        ExceptionRecord-&gt;ExceptionInformation [<span class="number">0</span>] = <span class="number">0</span>; <span class="comment">// 设置附加参数</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Select the method of handling the exception based on the previous mode.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ASSERT ((</span><br><span class="line">             !((PreviousMode == KernelMode) &amp;&amp;</span><br><span class="line">             (ContextFrame.EFlags &amp; EFLAGS_V86_MASK))</span><br><span class="line">           ));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果异常是在内核模式下被触发</span></span><br><span class="line">    <span class="keyword">if</span> (PreviousMode == KernelMode) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Previous mode was kernel.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// If the kernel debugger is active, then give the kernel debugger the</span></span><br><span class="line">        <span class="comment">// first chance to handle the exception. If the kernel debugger handles</span></span><br><span class="line">        <span class="comment">// the exception, then continue execution. Else attempt to dispatch the</span></span><br><span class="line">        <span class="comment">// exception to a frame based handler. If a frame based handler handles</span></span><br><span class="line">        <span class="comment">// the exception, then continue execution.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// If a frame based handler does not handle the exception,</span></span><br><span class="line">        <span class="comment">// give the kernel debugger a second chance, if it&#x27;s present.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// If the exception is still unhandled, call KeBugCheck().</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 先判断是否是第一次触发</span></span><br><span class="line">        <span class="keyword">if</span> (FirstChance == TRUE) &#123;</span><br><span class="line">			<span class="comment">// 调用KiDebugRoutine函数指针(实际就是内核调试器,如果没有内核调试器,</span></span><br><span class="line">			<span class="comment">// 函数指针保存的是KdpTrap函数的地址,如果有,则保存KdpStub函数地址)	</span></span><br><span class="line">            <span class="keyword">if</span> ((KiDebugRoutine != <span class="literal">NULL</span>) &amp;&amp;</span><br><span class="line">               (((KiDebugRoutine) (TrapFrame,  <span class="comment">// 线程环境</span></span><br><span class="line">                                   ExceptionFrame, <span class="comment">// 异常栈帧</span></span><br><span class="line">                                   ExceptionRecord, <span class="comment">// 异常信息记录</span></span><br><span class="line">                                   &amp;ContextFrame, <span class="comment">// </span></span><br><span class="line">                                   PreviousMode, </span><br><span class="line">                                   FALSE)) != FALSE)) &#123;</span><br><span class="line">				<span class="comment">// 如果调试处理了异常, 则跳转到函数末尾.</span></span><br><span class="line">                <span class="keyword">goto</span> Handled1;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 没有调试器, 或者有调试器但没有处理得了异常</span></span><br><span class="line">			<span class="comment">// 则将异常交给内核得SEH来处理</span></span><br><span class="line">            <span class="keyword">if</span> (RtlDispatchException(ExceptionRecord, &amp;ContextFrame) == TRUE) &#123;</span><br><span class="line">				<span class="comment">// 如果SEH处理成功, 则跳转到函数末尾</span></span><br><span class="line">                <span class="keyword">goto</span> Handled1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 如果调试器和SEH异常处理都没有处理得了异常, 则进行第二次异常分发:</span></span><br><span class="line">        <span class="comment">// This is the second chance to handle the exception.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">		<span class="comment">// 判断有无内核调试器,并调用(再给内核调试器一次处理异常得机会)</span></span><br><span class="line">        <span class="keyword">if</span> ((KiDebugRoutine != <span class="literal">NULL</span>) &amp;&amp;</span><br><span class="line">            (((KiDebugRoutine) (TrapFrame,</span><br><span class="line">                                ExceptionFrame,</span><br><span class="line">                                ExceptionRecord,</span><br><span class="line">                                &amp;ContextFrame,</span><br><span class="line">                                PreviousMode,</span><br><span class="line">                                TRUE)) != FALSE)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> Handled1;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 没有内核调试器, 或内核调试器不处理, 则调用函数KeBugCheckEx记录异常,之后蓝屏死机</span></span><br><span class="line">        KeBugCheckEx(</span><br><span class="line">            KERNEL_MODE_EXCEPTION_NOT_HANDLED,</span><br><span class="line">            ExceptionRecord-&gt;ExceptionCode,</span><br><span class="line">            (ULONG)ExceptionRecord-&gt;ExceptionAddress,</span><br><span class="line">            (ULONG)TrapFrame,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125; </span><br><span class="line">	<span class="keyword">else</span> <span class="comment">// 异常在在用户模式下触发 </span></span><br><span class="line">	&#123;   </span><br><span class="line"></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// Previous mode was user.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// If this is the first chance and the current process has a debugger</span></span><br><span class="line">		<span class="comment">// port, then send a message to the debugger port and wait for a reply.</span></span><br><span class="line">		<span class="comment">// 如果异常是第一次分发并且进程具有调试端口(被调试状态), 则发送一个消息</span></span><br><span class="line">		<span class="comment">// 到调试端口,并等待回复.</span></span><br><span class="line">		<span class="comment">// If the debugger handles the exception, then continue execution. Else</span></span><br><span class="line">		<span class="comment">// 如果调试器处理了这个异常, 则结束异常的分发. 否则,</span></span><br><span class="line">		<span class="comment">// transfer the exception information to the user stack, transition to</span></span><br><span class="line">		<span class="comment">// 将异常信息拷贝到用户态的栈中, 并转到</span></span><br><span class="line">		<span class="comment">// user mode, and attempt to dispatch the exception to a frame based</span></span><br><span class="line">		<span class="comment">// 用户模式 , 在用户模式下尝试将异常派发给异常处理程序.</span></span><br><span class="line">		<span class="comment">// handler. If a frame based handler handles the exception, then continue</span></span><br><span class="line">		<span class="comment">// 如果异常处理程序处理了异常, 则结束异常分发.</span></span><br><span class="line">		<span class="comment">// execution with the continue system service. Else execute the</span></span><br><span class="line">		<span class="comment">// 如果用户层的异常处理程序处理不了, 则调用NtRaiseException函数</span></span><br><span class="line">		<span class="comment">// NtRaiseException system service with FirstChance == FALSE, which</span></span><br><span class="line">		<span class="comment">// 主动触发异常, 并将FirstChance设置为TRUE. 这个函数(KiDispatchException)</span></span><br><span class="line">		<span class="comment">// will call this routine a second time to process the exception.</span></span><br><span class="line">		<span class="comment">// 将会被第二次调用以继续处理异常.</span></span><br><span class="line">		<span class="comment">// If this is the second chance and the current process has a debugger</span></span><br><span class="line">		<span class="comment">// 如果这次处理是第二次异常处理,并且进程有一个调试</span></span><br><span class="line">		<span class="comment">// port, then send a message to the debugger port and wait for a reply.</span></span><br><span class="line">		<span class="comment">// 端口, 则发送一个消息到调试端口,并等待调试器回复.</span></span><br><span class="line">		<span class="comment">// If the debugger handles the exception, then continue execution. Else</span></span><br><span class="line">		<span class="comment">// 如果调试器回复已经处理了异常, 则结束异常分发. 否则</span></span><br><span class="line">		<span class="comment">// if the current process has a subsystem port, then send a message to</span></span><br><span class="line">		<span class="comment">// 如果当前触发异常的进程有子系统端口,则发送一个消息到</span></span><br><span class="line">		<span class="comment">// the subsystem port and wait for a reply. If the subsystem handles the</span></span><br><span class="line">		<span class="comment">// 子系统端口,并等其回复. 若子系统处理了</span></span><br><span class="line">		<span class="comment">// exception, then continue execution. Else terminate the process.</span></span><br><span class="line">		<span class="comment">// 异常, 则异常分发结束, 否则直接结束掉当前进程.</span></span><br><span class="line">		<span class="comment">// If the current process is a wow64 process, an alignment fault has</span></span><br><span class="line">		<span class="comment">// occurred, and the AC bit is set in EFLAGS, then clear AC in EFLAGS</span></span><br><span class="line">		<span class="comment">// and continue execution. Otherwise, attempt to resolve the exception.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// </span></span><br><span class="line">        <span class="keyword">if</span> (FirstChance == TRUE) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// This is the first chance to handle the exception.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">			<span class="comment">// 检查是进程是否被调试,如果当前有内核调试器, 并且进程没有被调试,则将异常交给</span></span><br><span class="line">			<span class="comment">// 内核调试器去处理.</span></span><br><span class="line">            <span class="keyword">if</span> ((KiDebugRoutine != <span class="literal">NULL</span>)  &amp;&amp;</span><br><span class="line">                ((PsGetCurrentProcess()-&gt;DebugPort == <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">                  !KdIgnoreUmExceptions) ||</span><br><span class="line">                 (KdIsThisAKdTrap(ExceptionRecord, &amp;ContextFrame, UserMode)))) &#123;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Now dispatch the fault to the kernel debugger.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">				<span class="comment">// 将异常信息交给内核调试器处理</span></span><br><span class="line">                <span class="keyword">if</span> ((((KiDebugRoutine) (TrapFrame,</span><br><span class="line">                                        ExceptionFrame,</span><br><span class="line">                                        ExceptionRecord,</span><br><span class="line">                                        &amp;ContextFrame,</span><br><span class="line">                                        PreviousMode,</span><br><span class="line">                                        FALSE)) != FALSE)) &#123;</span><br><span class="line">					<span class="comment">// 处理成功则异常分发结束</span></span><br><span class="line">                    <span class="keyword">goto</span> Handled1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 将异常交给调试子系统去处理. DbgkForwardException函数会将</span></span><br><span class="line">			<span class="comment">// 异常记录发送给3环的调试器进程, 并等待3环的调试器回复.</span></span><br><span class="line">			<span class="comment">// 如果调试器回复了异常被处理, 则异常分发到此结束.</span></span><br><span class="line">            <span class="keyword">if</span> (DbgkForwardException(ExceptionRecord, TRUE, FALSE)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> Handled2;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 如果没有用户调试器,或用户调试器没有处理异常则接着往下走.</span></span><br><span class="line">			<span class="comment">// 函数会试图将异常记录, 线程环境</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Transfer exception information to the user stack, transition</span></span><br><span class="line">            <span class="comment">// to user mode, and attempt to dispatch the exception to a frame</span></span><br><span class="line">            <span class="comment">// based handler.</span></span><br><span class="line">			</span><br><span class="line">            ExceptionRecord1.ExceptionCode = <span class="number">0</span>; <span class="comment">// satisfy no_opt compilation</span></span><br><span class="line"></span><br><span class="line">        repeat:</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// If the SS segment is not 32 bit flat, there is no point</span></span><br><span class="line">                <span class="comment">// to dispatch exception to frame based exception handler.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (TrapFrame-&gt;HardwareSegSs != (KGDT_R3_DATA | RPL_MASK) ||</span><br><span class="line">                    TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK ) &#123;</span><br><span class="line">                    ExceptionRecord2.ExceptionCode = STATUS_ACCESS_VIOLATION;</span><br><span class="line">                    ExceptionRecord2.ExceptionFlags = <span class="number">0</span>;</span><br><span class="line">                    ExceptionRecord2.NumberParameters = <span class="number">0</span>;</span><br><span class="line">                    ExRaiseException(&amp;ExceptionRecord2);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Compute length of context record and new aligned user stack</span></span><br><span class="line">                <span class="comment">// pointer.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">				<span class="comment">// 为将线程上下文块整个结构体拷贝到用户的栈空间, 需要找到栈空间上一个空闲</span></span><br><span class="line">				<span class="comment">// 的地址, 此处是计算esp(栈顶位置) - 一个线程上下文块的大小, 也就是相当于</span></span><br><span class="line">				<span class="comment">// sub esp , sizeof(CONTEXT) </span></span><br><span class="line">                UserStack1 = (ContextFrame.Esp &amp; ~CONTEXT_ROUND) - CONTEXT_ALIGNED_SIZE;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Probe user stack area for writability and then transfer the</span></span><br><span class="line">                <span class="comment">// context record to the user stack.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">				<span class="comment">// 将指定地址设置为可写入</span></span><br><span class="line">                ProbeForWrite((PCHAR)UserStack1, CONTEXT_ALIGNED_SIZE, CONTEXT_ALIGN);</span><br><span class="line">				<span class="comment">// 将线程上下文拷贝到用户的栈空间中.</span></span><br><span class="line">                RtlCopyMemory((PULONG)UserStack1, &amp;ContextFrame, <span class="keyword">sizeof</span>(CONTEXT));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Compute length of exception record and new aligned stack</span></span><br><span class="line">                <span class="comment">// address.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">				<span class="comment">// 计算处异常信息结构体的在用户栈空间中的位置, 也是为了将异常信息写入</span></span><br><span class="line">				<span class="comment">// 到用户栈空间中.</span></span><br><span class="line">                Length = (<span class="keyword">sizeof</span>(EXCEPTION_RECORD) - (EXCEPTION_MAXIMUM_PARAMETERS -</span><br><span class="line">                         ExceptionRecord-&gt;NumberParameters) * <span class="keyword">sizeof</span>(ULONG) +<span class="number">3</span>) &amp;</span><br><span class="line">                         (~<span class="number">3</span>);</span><br><span class="line">                UserStack2 = UserStack1 - Length;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Probe user stack area for writeability and then transfer the</span></span><br><span class="line">                <span class="comment">// context record to the user stack area.</span></span><br><span class="line">                <span class="comment">// N.B. The probing length is Length+8 because there are two</span></span><br><span class="line">                <span class="comment">//      arguments need to be pushed to user stack later.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">				<span class="comment">// 将地址设置为可写</span></span><br><span class="line">                ProbeForWrite((PCHAR)(UserStack2 - <span class="number">8</span>), Length + <span class="number">8</span>, <span class="keyword">sizeof</span>(ULONG));</span><br><span class="line">				<span class="comment">// 将异常信息拷贝用户的栈空间中.</span></span><br><span class="line">                RtlCopyMemory((PULONG)UserStack2, ExceptionRecord, Length);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Push address of exception record, context record to the</span></span><br><span class="line">                <span class="comment">// user stack.  They are the two parameters required by</span></span><br><span class="line">                <span class="comment">// _KiUserExceptionDispatch.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">				<span class="comment">// 构造处一个EXCEPTION_POINTERS的结构体, 并保存线程上下文,异常信息两个结构体</span></span><br><span class="line">				<span class="comment">// 变量的首地址.</span></span><br><span class="line">                *(PULONG)(UserStack2 - <span class="keyword">sizeof</span>(ULONG)) = UserStack1;</span><br><span class="line">                *(PULONG)(UserStack2 - <span class="number">2</span>*<span class="keyword">sizeof</span>(ULONG)) = UserStack2;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Set new stack pointer to the trap frame.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">                KiSegSsToTrapFrame(TrapFrame, KGDT_R3_DATA);</span><br><span class="line">                KiEspToTrapFrame(TrapFrame, (UserStack2 - <span class="keyword">sizeof</span>(ULONG)*<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Force correct R3 selectors into TrapFrame.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">				<span class="comment">// 设置段选择子----用户层</span></span><br><span class="line">                TrapFrame-&gt;SegCs = SANITIZE_SEG(KGDT_R3_CODE, PreviousMode);</span><br><span class="line">                TrapFrame-&gt;SegDs = SANITIZE_SEG(KGDT_R3_DATA, PreviousMode);</span><br><span class="line">                TrapFrame-&gt;SegEs = SANITIZE_SEG(KGDT_R3_DATA, PreviousMode);</span><br><span class="line">                TrapFrame-&gt;SegFs = SANITIZE_SEG(KGDT_R3_TEB, PreviousMode);</span><br><span class="line">                TrapFrame-&gt;SegGs = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Set the address of the exception routine that will call the</span></span><br><span class="line">                <span class="comment">// exception dispatcher and then return to the trap handler.</span></span><br><span class="line">                <span class="comment">// The trap handler will restore the exception and trap frame</span></span><br><span class="line">                <span class="comment">// context and continue execution in the routine that will</span></span><br><span class="line">                <span class="comment">// call the exception dispatcher.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">				<span class="comment">// 将发生异常的线程的eip的地址设置为KeUserExceptionDispatcher函数的地址</span></span><br><span class="line">				<span class="comment">// 这个函数是ntdll中的导出函数,这个导出函数就是负责用户层的异常分发的,</span></span><br><span class="line">				<span class="comment">// 在这个函数中,它会把异常发给进程的异常处理机制(VEH,SEH)去处理.</span></span><br><span class="line">				<span class="comment">// 这样一来, 当执行流从0环回到3环的时候, eip指向何处, 那个地方的代码就开始</span></span><br><span class="line">				<span class="comment">// 被执行.</span></span><br><span class="line">                TrapFrame-&gt;Eip = (ULONG)KeUserExceptionDispatcher;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            &#125; except (KiCopyInformation(&amp;ExceptionRecord1,</span><br><span class="line">                        (GetExceptionInformation())-&gt;ExceptionRecord)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// If the exception is a stack overflow, then attempt</span></span><br><span class="line">                <span class="comment">// to raise the stack overflow exception. Otherwise,</span></span><br><span class="line">                <span class="comment">// the user&#x27;s stack is not accessible, or is misaligned,</span></span><br><span class="line">                <span class="comment">// and second chance processing is performed.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ExceptionRecord1.ExceptionCode == STATUS_STACK_OVERFLOW) &#123;</span><br><span class="line">                    ExceptionRecord1.ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;</span><br><span class="line">                    RtlCopyMemory((PVOID)ExceptionRecord,</span><br><span class="line">                                  &amp;ExceptionRecord1, <span class="keyword">sizeof</span>(EXCEPTION_RECORD));</span><br><span class="line">                    <span class="keyword">goto</span> repeat;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// This is the second chance to handle the exception.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DbgkForwardException(ExceptionRecord, TRUE, TRUE)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> Handled2;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DbgkForwardException(ExceptionRecord, FALSE, TRUE)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> Handled2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ZwTerminateProcess(NtCurrentProcess(), ExceptionRecord-&gt;ExceptionCode);</span><br><span class="line">            KeBugCheckEx(</span><br><span class="line">                KERNEL_MODE_EXCEPTION_NOT_HANDLED,</span><br><span class="line">                ExceptionRecord-&gt;ExceptionCode,</span><br><span class="line">                (ULONG)ExceptionRecord-&gt;ExceptionAddress,</span><br><span class="line">                (ULONG)TrapFrame,</span><br><span class="line">                <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Move machine state from context frame to trap and exception frames and</span></span><br><span class="line">    <span class="comment">// then return to continue execution with the restored state.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">Handled1:</span><br><span class="line">	<span class="comment">// 将异常栈帧, 线程环境设置到线程中.</span></span><br><span class="line">    KeContextToKframes(TrapFrame, ExceptionFrame, &amp;ContextFrame,</span><br><span class="line">                       ContextFrame.ContextFlags, PreviousMode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Exception was handled by the debugger or the associated subsystem</span></span><br><span class="line">    <span class="comment">// and state was modified, if necessary, using the get state and set</span></span><br><span class="line">    <span class="comment">// state capabilities. Therefore the context frame does not need to</span></span><br><span class="line">    <span class="comment">// be transferred to the trap and exception frames.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">Handled2:</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="用户层异常分发源代码"><a href="#用户层异常分发源代码" class="headerlink" title="用户层异常分发源代码"></a>用户层异常分发源代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 		exception handling routines (xp 32-bit, partial/incomplete)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *		ntdll 5.1.2600.5755</span></span><br><span class="line"><span class="comment"> *		v2 (updated jan 2011)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *		- hawkes &lt;hawkes@sota.gen.nz&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *		useful link: http://www.eeye.com/html/resources/newsletters/vice/VI20060830.html</span></span><br><span class="line"><span class="comment"> *		</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPOSITION_DISMISS				0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPOSITION_CONTINUE_SEARCH 	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPOSITION_NESTED_EXCEPTION	2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPOSITION_COLLIDED_UNWIND		3</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EH_NONCONTINUABLE   0x01</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EH_UNWINDING        0x02</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EH_EXIT_UNWIND      0x04</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EH_STACK_INVALID    0x08</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EH_NESTED_CALL      0x10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STATUS_NONCONTINUABLE_EXCEPTION 0xC0000025</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STATUS_INVALID_DISPOSITION		0xC0000026</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXCEPTION_CONTINUE_EXECUTION 	-1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_EXEC_MASK (PAGE_EXECUTE|PAGE_EXECUTE_READ|PAGE_EXECUTE_READWRITE|PAGE_EXECUTE_WRITECOPY)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD</span> &#123;</span></span><br><span class="line">	DWORD ExceptionCode;</span><br><span class="line">	DWORD ExceptionFlags;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD</span> *<span class="title">ExceptionRecord</span>;</span>	<span class="comment">// var_CW</span></span><br><span class="line">	PVOID ExceptionAddress;</span><br><span class="line">	DWORD NumberParameters;</span><br><span class="line">	ULONG_PTR ExceptionInformation[<span class="number">15</span>];</span><br><span class="line">&#125; EXCEPTION_RECORD, *PEXCEPTION_RECORD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION</span>*	<span class="title">pNext</span>;</span></span><br><span class="line">	PEXCEPTION_HANDLER		handler;</span><br><span class="line">&#125; EXCEPTION_REGISTRATION, *PEXCEPTION_REGISTRATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">VECTORED_EXCEPTION_NODE</span> &#123;</span></span><br><span class="line">    LIST_ENTRY ListEntry;</span><br><span class="line">    PVECTORED_EXCEPTION_HANDLER handler;</span><br><span class="line">&#125; VECTORED_EXCEPTION_NODE, *PVECTORED_EXCEPTION_NODE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">EXCEPTION_DISPOSITION</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  ExceptionContinueExecution,</span><br><span class="line">  ExceptionContinueSearch,</span><br><span class="line">  ExceptionNestedException,</span><br><span class="line">  ExceptionCollidedUnwind</span><br><span class="line">&#125; EXCEPTION_DISPOSITION;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7C97E3FA */</span></span><br><span class="line">UCHAR LogExceptions = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7C97E3C0 */</span></span><br><span class="line">LIST_ENTRY RtlpCalloutEntryList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7C9805E0 */</span></span><br><span class="line">RTL_CRITICAL_SECTION RtlpCalloutEntryLock;</span><br><span class="line">RTL_CRITICAL_SECTION LdrpLoaderLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7C90E47C */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 用户层的异常派发源头</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">VOID <span class="title">KeUserExceptionDispatcher</span><span class="params">(PCONTEXT ContextRecord, </span></span></span><br><span class="line"><span class="function"><span class="params">                     PEXCEPTION_RECORD ExceptionRecord)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	</span><br><span class="line">	NTSTATUS Status;</span><br><span class="line">	<span class="comment">// 调用RtlDispatchException函数去派发异常.</span></span><br><span class="line">	<span class="keyword">if</span> (RtlDispatchException(ContextRecord, ExceptionRecord)) &#123;</span><br><span class="line">		<span class="comment">/* 7C90E48E modify the execution context of the current thread to whatever the chosen exception handler gives us */</span></span><br><span class="line">		<span class="comment">// 结束异常分发</span></span><br><span class="line">		Status = ZwContinue(ContextRecord, <span class="number">0</span>);</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* 7C90E49A no exception handler found so re-raise the exception for a debugger or the NT exception handler */</span></span><br><span class="line">		<span class="comment">// 在此触发一个异常, 并触发时最后一个参数传FALSE,表明这是一个第二次触发的异常.</span></span><br><span class="line">		Status = ZwRaiseException(ExceptionRecord, ContextRecord, FALSE);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 7C90E4A5 build an exception record with 20 bytes on the stack, second chance exception? */</span></span><br><span class="line">	PEXCEPTION_RECORD exception = (PEXCEPTION_RECORD) alloca(<span class="number">0x14</span>);</span><br><span class="line">	exception-&gt;ExceptionCode = Status;</span><br><span class="line">	exception-&gt;ExceptionFlags = <span class="number">1</span>;</span><br><span class="line">	exception-&gt;ExceptionRecord = ContextRecord;</span><br><span class="line">	exception-&gt;NumberParameters = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> RtlRaiseException(exception);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LPVOID <span class="title">RtlpGetRegistrationHead</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_asm mov eax , fs:[<span class="number">0</span>]</span><br><span class="line">	_asm ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7C92A970 如果异常被处理返回TRUE */</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">RtlDispatchException</span><span class="params">(PCONTEXT ContextRecord, PEXCEPTION_RECORD ExceptionRecord)</span> </span>&#123;</span><br><span class="line">	BOOLEAN ret = <span class="number">0</span>;</span><br><span class="line">	LPVOID StackBase, StackLimit;</span><br><span class="line">	PEXCEPTION_REGISTRATION head;</span><br><span class="line">	DWORD kProcess_Flags;</span><br><span class="line">	DWORD dispatch, highest;</span><br><span class="line">	EXCEPTION_RECORD exRec;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 先将异常交给VEH处理. 如果能够处理,则结束异常分发</span></span><br><span class="line">	<span class="keyword">if</span> (RtlCallVectoredExceptionHandlers(ExceptionRecord, ContextRecord)) &#123;</span><br><span class="line">		<span class="comment">/* 7C95010A */</span></span><br><span class="line">		ret = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123; <span class="comment">/* 否则交给SEH处理 */</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* 7C92A991 */</span></span><br><span class="line">		RtlpGetStackLimits(&amp;StackLimit, &amp;StackBase);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取SEH链表头节点</span></span><br><span class="line">		<span class="comment">/* 7C92A99F */</span></span><br><span class="line">		head = (PEXCEPTION_REGISTRATION)RtlpGetRegistrationHead();</span><br><span class="line">		</span><br><span class="line">		highest = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> (head != (PEXCEPTION_REGISTRATION) <span class="number">-1</span>) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 判断获取出来的节点的地址是否正确</span></span><br><span class="line">			<span class="keyword">if</span> (head &lt; StackLimit || head + <span class="keyword">sizeof</span>(EXCEPTION_REGISTRATION) &gt; StackBase || head &amp; <span class="number">3</span>) &#123;</span><br><span class="line">	</span><br><span class="line">				ExceptionRecord-&gt;ExceptionFlags |= EH_STACK_INVALID;</span><br><span class="line">				<span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 判断异常处理函数的地址是否正确</span></span><br><span class="line">			<span class="keyword">if</span> (head-&gt;handler &gt;= StackLimit &amp;&amp; head-&gt;handler &lt; StackBase) &#123;</span><br><span class="line">				</span><br><span class="line">				ExceptionRecord-&gt;ExceptionFlags |= EH_STACK_INVALID;</span><br><span class="line">				<span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 判断异常处理函数是否为有效处理函数</span></span><br><span class="line">			<span class="keyword">if</span> (!RtlIsValidHandler(head-&gt;handler)) &#123;</span><br><span class="line">				<span class="comment">/* 7C92A336 */</span></span><br><span class="line">				ExceptionRecord-&gt;ExceptionFlags |= EH_STACK_INVALID;</span><br><span class="line">				<span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (LogExceptions) &#123;</span><br><span class="line">				<span class="comment">/* 7C950113 */</span></span><br><span class="line">				RtlpLogExceptionHandler(ContextRecord, ExceptionRecord, <span class="number">0</span>, head, <span class="number">0x10</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 执行SEH的 _except_handler4()</span></span><br><span class="line">			hret = RtlpExecuteHandlerForException(ContextRecord, </span><br><span class="line">			                                      head, </span><br><span class="line">												  ExceptionRecord,</span><br><span class="line">												  &amp;dispatch, </span><br><span class="line">												  head-&gt;handler);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (LogExceptions) &#123;</span><br><span class="line">				<span class="comment">/* 7C950129 there is a second parameter to this function that I don&#x27;t understand yet */</span></span><br><span class="line">				RtlpLogLastExceptionDisposition(highest, hret);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">/* 7C92AA1E */</span></span><br><span class="line">			<span class="keyword">if</span> (head == <span class="literal">NULL</span>) &#123;</span><br><span class="line">				ExceptionRecord-&gt;ExceptionFlags &amp;= ~EH_NESTED_CALL;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">/* 7C92AA27 */</span></span><br><span class="line">			<span class="keyword">if</span> (hret == DISPOSITION_DISMISS) &#123;</span><br><span class="line">				<span class="keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; EH_NONCONTINUABLE) &#123;</span><br><span class="line">					<span class="comment">/* 7C950181 */</span></span><br><span class="line">					exRec.ExceptionCode = STATUS_NONCONTINUABLE_EXCEPTION;</span><br><span class="line">					exRec.ExceptionFlags = EH_NONCONTINUABLE;</span><br><span class="line">					exRec.ExceptionRecord = ExceptionRecord;</span><br><span class="line">					exRec.NumberParameters = <span class="number">0</span>;</span><br><span class="line">					RtlRaiseException(&amp;exRec);</span><br><span class="line">					</span><br><span class="line">					<span class="comment">/* 7C92A31C a little fudging with this block */</span></span><br><span class="line">					<span class="keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; EH_STACK_INVALID) &#123;</span><br><span class="line">						<span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="comment">/* 77EDBD64 */</span></span><br><span class="line">					ret = <span class="number">1</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 如果SEH过滤函数返回的是搜索其它过滤函数处理</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (hret == DISPOSITION_CONTINUE_SEARCH) &#123;</span><br><span class="line">				<span class="comment">/* 7C92A31C a little fudging with this block */</span></span><br><span class="line">				<span class="keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; EH_STACK_INVALID) &#123;</span><br><span class="line">					<span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (hret == DISPOSITION_NESTED_EXCEPTION) &#123;</span><br><span class="line">				<span class="comment">/* 7C950169 */</span></span><br><span class="line">				ExceptionRecord-&gt;ExceptionFlags |= EH_NESTED_CALL;</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span> (dispatch &gt; highest) &#123;</span><br><span class="line">					highest = dispatch;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123; </span><br><span class="line">				<span class="comment">/* 7C950147 */</span></span><br><span class="line">					exRec.ExceptionCode = STATUS_INVALID_DISPOSITION;</span><br><span class="line">					exRec.ExceptionFlags = EH_NONCONTINUABLE;</span><br><span class="line">					exRec.ExceptionRecord = ExceptionRecord;</span><br><span class="line">					exRec.NumberParameters = <span class="number">0</span>;</span><br><span class="line">					RtlRaiseException(&amp;exRec);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">/* 7C92A326 */</span></span><br><span class="line">			head = head-&gt;pNext;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">	<span class="comment">/* 7C92AA43 */</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7C92A934 */</span></span><br><span class="line"><span class="comment">// 调用VEH函数</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">RtlCallVectoredExceptionHandlers</span><span class="params">(PEXCEPTION_RECORD ExceptionRecord, PCONTEXT ContextRecord)</span> </span>&#123;</span><br><span class="line">	BOOLEAN ret = FALSE;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		PEXCEPTION_RECORD eRec;</span><br><span class="line">		PCONTEXT cRec;</span><br><span class="line">	&#125; Rec;</span><br><span class="line">	PVECTORED_EXCEPTION_NODE veh;</span><br><span class="line">	PVECTORED_EXCEPTION_HANDLER handler;</span><br><span class="line">	DWORD disposition</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (RtlpCalloutEntryList.Flink == &amp;RtlpCalloutEntryList) &#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	eRec = ExceptionRecord;</span><br><span class="line">	cRec = ExceptionRecord;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 进入临界区</span></span><br><span class="line">	RtlEnterCriticalSection(&amp;RtlpCalloutEntryLock);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 开始遍历VEH的双向链表</span></span><br><span class="line">	<span class="keyword">for</span> (veh = (PVECTORED_EXCEPTION_NODE) RtlpCalloutEntryList.Flink); </span><br><span class="line">				veh != (PVECTORED_EXCEPTION_NODE) RtlpCalloutEntryList; </span><br><span class="line">				veh =  (PVECTORED_EXCEPTION_NODE) veh-&gt;ListEntry.Flink) &#123;</span><br><span class="line">					</span><br><span class="line">			<span class="comment">// 解密处理函数地址</span></span><br><span class="line">			handler = RtlDecodePointer(veh-&gt;handler);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 调用处理函数</span></span><br><span class="line">			disposition = handler(&amp;Rec);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 判断处理函数是否处理了异常.如果是则结束循环.</span></span><br><span class="line">			<span class="comment">// 如果没有,则继续找到下一个处理函数.</span></span><br><span class="line">			<span class="keyword">if</span> (disposition == EXCEPTION_CONTINUE_EXECUTION) &#123;</span><br><span class="line">				<span class="comment">// 将返回值设置为TRUE.</span></span><br><span class="line">				ret = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 离开临界区</span></span><br><span class="line">	RtlLeaveCriticalSection(&amp;RtlpCalloutEntryLock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7C9033DC */</span></span><br><span class="line"><span class="function">VOID <span class="title">RtlpGetStackLimits</span><span class="params">(LPVOID **StackLimit, LPVOID **StackBase)</span> </span>&#123;</span><br><span class="line">	PTEB teb = _TEB;							<span class="comment">// fs:18h</span></span><br><span class="line">	</span><br><span class="line">	*StackLimit = teb-&gt;NtTib-&gt;StackLimit;</span><br><span class="line">	*StackBase = teb-&gt;NtTib-&gt;StackBase;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7C92AA50 */</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">RtlIsValidHandler</span><span class="params">(PEXCEPTION_HANDLER handler)</span> </span>&#123;</span><br><span class="line">	DWORD table_sz;</span><br><span class="line">	LPVOID safeseh_table, base_addr;</span><br><span class="line">	DWORD ret, result_len, exec_flags, high, low;</span><br><span class="line">	MEMORY_BASIC_INFORMATION mbi;</span><br><span class="line">	</span><br><span class="line">	safeseh_table = RtlLookupFunctionTable(handler, &amp;base_addr, &amp;table_sz);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (safeseh_table == <span class="literal">NULL</span> || table_sz == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/* 7C9500D1 ProcessExecuteFlags*/</span></span><br><span class="line">		<span class="keyword">if</span> (ZwQueryInformationProcess(INVALID_HANDLE_VALUE, <span class="number">22</span>, &amp;exec_flags, <span class="number">4</span>, <span class="literal">NULL</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">/* 7C92CF94 0x10 = ExecuteDispatchEnable */</span></span><br><span class="line">			<span class="keyword">if</span> (!(exec_flags &amp; <span class="number">0x10</span>)) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* 7C935E8E */</span></span><br><span class="line">		<span class="keyword">if</span> (NtQueryVirtualMemory(INVALID_HANDLE_VALUE, handler, <span class="literal">NULL</span>, &amp;mbi, <span class="keyword">sizeof</span>(MEMORY_BASIC_INFORMATION), &amp;result_len) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* 7C935EA9 */</span></span><br><span class="line">		<span class="keyword">if</span> (!(mbi.Protect &amp; PAGE_EXEC_MASK)) &#123;</span><br><span class="line">			RtlInvalidHandlerDetected(handler, <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (mbi.Type != SEC_IMAGE) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		RtlCaptureImageExceptionValues(mbi.AllocationBase, &amp;safeseh_table, &amp;table_sz);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* 7C935ED0 */</span></span><br><span class="line">		<span class="keyword">if</span> (var_10 == <span class="literal">NULL</span> || table_sz == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (safeseh_table == (LPVOID) <span class="number">-1</span> &amp;&amp; table_sz == <span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 7C9500A6 */</span></span><br><span class="line">	<span class="keyword">if</span> (table_sz &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		RtlInvalidHandlerDetected(handler, safeseh_table, table_sz);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	rel_addr = handler - base_addr;</span><br><span class="line">	high = table_sz;</span><br><span class="line">	low = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 7C9500B1 binary search through SafeSEH table */</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		idx = (high + low) / <span class="number">2</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (rel_addr &lt; safeseh_table[idx]) &#123;</span><br><span class="line">			<span class="keyword">if</span> (idx == <span class="number">0</span>) &#123;</span><br><span class="line">				RtlInvalidHandlerDetected(handler, safeseh_table, table_sz);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			high = idx - <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (high &lt; low) &#123;</span><br><span class="line">				RtlInvalidHandlerDetected(handler, safeseh_table, table_sz);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (rel_addr &gt; safeseh_table[idx]) &#123;</span><br><span class="line">			low = idx + <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (high &lt; low) &#123;</span><br><span class="line">				RtlInvalidHandlerDetected(handler, safeseh_table, table_sz);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7C92AAA4 */</span></span><br><span class="line"><span class="function">LPVOID <span class="title">RtlLookupFunctionTable</span><span class="params">(PEXCEPTION_HANDLER handler, DWORD *base_addr, DWORD *table_sz)</span> </span>&#123;</span><br><span class="line">	MEMORY_BASIC_INFORMATION mbi;</span><br><span class="line">	LPVOID safeseh_table, base;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (LdrpInLdrInit &amp;&amp; RtlTryEnterCriticalSection(&amp;LdrpLoaderLock) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/* 7C92DD29 3 = MemoryBasicVlmInformation */</span></span><br><span class="line">		<span class="keyword">if</span> (NtQueryVirtualMemory((HANDLE) <span class="number">-1</span>, handler, <span class="number">3</span>, &amp;mbi, <span class="keyword">sizeof</span>(MEMORY_BASIC_INFORMATION), <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (mbi.Type != SEC_IMAGE) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">			</span><br><span class="line">		base = mbi.BaseAddress;</span><br><span class="line">			</span><br><span class="line">		<span class="comment">/* 7C92DD51 */</span></span><br><span class="line">		RtlCaptureImageExceptionValues(base, &amp;safeseh_table, table_sz);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (_TEB != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="comment">/* 7C92AAD9 */</span></span><br><span class="line">			PLDR_MODULE node = _PEB-&gt;Ldr-&gt;InLoadOrderModuleList.Flink</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (_PEB-&gt;Ldr != <span class="number">0</span> &amp;&amp; node != <span class="literal">NULL</span>) &#123;</span><br><span class="line">				<span class="keyword">while</span> (node != &amp;_PEB-&gt;Ldr-&gt;InLoadOrderModuleList) &#123;</span><br><span class="line">					<span class="comment">/* 7C92AB00 */</span></span><br><span class="line">					<span class="keyword">if</span> (handler &lt; node-&gt;BaseAddr) &#123;</span><br><span class="line">						node = node-&gt;InLoadOrderModuleList.Flink;</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span> (handler &gt;= node-&gt;BaseAddr + node-&gt;SizeOfImage) &#123;</span><br><span class="line">						node = node-&gt;InLoadOrderModuleList.Flink;</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					<span class="comment">/* 7C92AB14 */</span></span><br><span class="line">					base = node-&gt;BaseAddr;</span><br><span class="line">					RtlCaptureImageExceptionValues(base, &amp;safeseh_table, table_sz);</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span> (safeseh_table == <span class="literal">NULL</span> &amp;&amp; NtDllBase != <span class="literal">NULL</span> &amp;&amp; (base = RtlNtImageHeader(NtDllBase)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">						<span class="keyword">if</span> (header &gt; base &amp;&amp; header &lt; base + ((PIMAGE_NT_HEADER) base)-&gt;OptionalHeaders.SizeOfImage) &#123;</span><br><span class="line">							<span class="comment">/* 7C950D7D */</span></span><br><span class="line">							RtlCaptureImageExceptionValues(base, &amp;safeseh_table, table_sz);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* 7C92AB2C */</span></span><br><span class="line">		<span class="keyword">if</span> (LdrpInLdrInit) &#123;</span><br><span class="line">			RtlLeaveCriticalSection(&amp;LdrpLoaderLock);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	*base_addr = base;</span><br><span class="line">	<span class="keyword">return</span> safeseh_table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="WinDbg"><a href="#WinDbg" class="headerlink" title="WinDbg"></a>WinDbg</h1><h2 id="用户层会话调试建立"><a href="#用户层会话调试建立" class="headerlink" title="用户层会话调试建立"></a>用户层会话调试建立</h2><p>1，直接创建一个进程，并调试它：File-Open Executetable</p>
<p>2，附加到已经打开的进程：File-Attatch to a Process</p>
<p>​    侵入式附加：接管正在运行的程序，能够进行调试</p>
<p>​    非侵入式附加：只能够读取进程信息，不能接收目标进程的调试事件</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/Select.jpg" title="Mr_Hu">

<h2 id="内核层调试会话建立"><a href="#内核层调试会话建立" class="headerlink" title="内核层调试会话建立"></a>内核层调试会话建立</h2><p>正常情况下是无法用自己的系统调试自己的系统的，我们都需要知道调试器是要下断点的，加入我们中断了自己的操作系统，那么我们就什么都做不了了，所以一般调试内核都是用一台机器调试另一台机器</p>
<p>1，使用两台机器过于繁琐，可以使用物理机调试虚拟机，建立双机调试环境</p>
<p>2，类似于用户层非侵入式的调试，是可以不接管本系统的调试，仅仅查看本系统内核中的信息，这种方式叫本地内核调试</p>
<h3 id="双机环境的建立"><a href="#双机环境的建立" class="headerlink" title="双机环境的建立"></a>双机环境的建立</h3><p>虚拟机进行双击内核调试有多种链接方式，以下使用的是VirtualKD工具来复制创建双机调试环境</p>
<p>​    需要：Windbg，虚拟机，VirtualKD</p>
<h4 id="设置调试器路径"><a href="#设置调试器路径" class="headerlink" title="设置调试器路径"></a>设置调试器路径</h4><img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/SetPath.png" title="Mr_Hu">

<h4 id="设置虚拟机"><a href="#设置虚拟机" class="headerlink" title="设置虚拟机"></a>设置虚拟机</h4><p>打开虚拟机运行Install VirtualKD程序</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/SetVirtualKD.png" title="Mr_Hu">

<p>这个时候会重启系统</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/System.png">

<p>然后就能看到</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/StartSystem.png" title="Mr_Hu">

<p>虚拟机就跑起来了</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/RunWindows.jpg" titel="Mr_Hu">

<h3 id="本地内核调试的建立"><a href="#本地内核调试的建立" class="headerlink" title="本地内核调试的建立"></a>本地内核调试的建立</h3><p>本地内核调试不是真正的调试，只是查看信息而已，故而调试相关的命令都是受限的</p>
<p>需要注意的是：</p>
<p>本地调试需要是以调试模式启动的Windows操作系统，且需要以管理员的方式运行Windbg，操作系统版本要与Windbg版本对应</p>
<h4 id="以调试模式进入系统"><a href="#以调试模式进入系统" class="headerlink" title="以调试模式进入系统"></a>以调试模式进入系统</h4><p>开机按F8-调试模式</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/TestMoudel.jpg" title="Mr_Hu">

<p>进入系统后选择以管理员的方式运行-Kernel Debug-local</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/KernelDbg.png" title="Mr_Hu">

<p>之后就进入本地内核调试了</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/KernelTest.jpg" title="Mr_Hu">

<h2 id="界面概览"><a href="#界面概览" class="headerlink" title="界面概览"></a>界面概览</h2><h3 id="调试窗口"><a href="#调试窗口" class="headerlink" title="调试窗口"></a>调试窗口</h3><img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/Debug.jpg" title="Mr_Hu">

<h3 id="视图窗口"><a href="#视图窗口" class="headerlink" title="视图窗口"></a>视图窗口</h3><img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/View.jpg" title="Mr_Hu">

<h2 id="符号文件"><a href="#符号文件" class="headerlink" title="符号文件"></a>符号文件</h2><p>符号文件是编译器编译可执行文件时生成的一些文件，通常在Windows平台遇到符号文件叫做pdb文件，其中包括：</p>
<pre><code>- 全局变量的类型、名称、地址
- 局部变量的类型、名称、地址
- 函数名称、原型、地址
- 变量、结构体类型的定义</code></pre>
<p>符号文件对于程序的调试非常重要，无论是源码调试还是非源码调试</p>
<h3 id="设置符号路径"><a href="#设置符号路径" class="headerlink" title="设置符号路径"></a>设置符号路径</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/SetSymbolPath.jpg" title="Mr_Hu">

<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/SetSymbolPath1.jpg" title="Mr_Hu">

<h4 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h4><p>使用命令</p>
<p>.sympath [+] [路径]</p>
<h3 id="加载符号"><a href="#加载符号" class="headerlink" title="加载符号"></a>加载符号</h3><p>使用命令：.reload刷新符号路径加载位置</p>
<p>使用命令：Id+[模块名]来加载某一个模块的符号</p>
<h4 id="加载系统符号"><a href="#加载系统符号" class="headerlink" title="加载系统符号"></a>加载系统符号</h4><p>当进行双机调试，可以使用微软提供的符号文件辅助内核分析调试，</p>
<p>获取方式</p>
<p>在符号路径下添加一个微软的符号服务器，格式如下：</p>
<p>​    SRV*[本地路径]*服务器路径</p>
<p>​    例：</p>
<pre><code>    - srv* d:\\\ mysymbols* \\\symsrv\symbol假如自己公司有一个符号服务器的话） 
    - srv* d :\\\ Mmysymbols *http //msdl . microsoft .com/download /symbols （微软符号服务器）</code></pre>
<p>通过后面的服务器地址下载到前面的本地路径</p>
<h4 id="符号选项"><a href="#符号选项" class="headerlink" title="符号选项"></a>符号选项</h4><p>使用 命令 .symopt</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/Symbol.jpg" title="Mr_Hu">

<h2 id="源码调试"><a href="#源码调试" class="headerlink" title="源码调试"></a>源码调试</h2><p>Windbug有源码调试与反汇编调试两种模式</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/Source.jpg" title="Mr_Hu">

<p>当既有符号文件，又有程序源代码是，才可以使用Windbug进行源码调试</p>
<ul>
<li>加载符号</li>
<li>打开源文件，设置断点</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/SourceTest.jpg" title="Mr_Hu">

<h2 id="工作空间"><a href="#工作空间" class="headerlink" title="工作空间"></a>工作空间</h2><p>当前的Windows中的工作环境称之为工作空间，包括：</p>
<pre><code>- 当前的界面布局等调试器设置信息
- 调试项目有关的属性，参数以及调试器设置等信息</code></pre>
<p>每次Windbg打开都是默认的初始工作空间，其实可以把工作配置保存起来，这样每次调试程序的时候，就可以快速的进入工作状态</p>
<ul>
<li><p>默认工作空间</p>
</li>
<li><ul>
<li>基础工作空间</li>
<li>默认内核态工作空间</li>
<li>默认用户态工作空间</li>
<li>默认转储文件工作空间</li>
</ul>
<p>默认工作空间是以单个分析过程区分的，例如使用Windbg分析一个应用程序时会根据可执行文件的路径和文件名为其建立一个默认的工作空间</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/SaveWorkSpace.jpg" title="Mr_Hu">
</li>
<li><p>命名工作空间</p>
<p>在Windbg中可以为工作空间命名，就是把自己的工作空间保存起来或者存储成文件。</p>
</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/SaveWorkSpaceAs.jpg" title="Mr_Hu">

<h2 id="命令系统"><a href="#命令系统" class="headerlink" title="命令系统"></a>命令系统</h2><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><p>Windebug是一个支持强大命令系统的调试器</p>
<h3 id="标准命令"><a href="#标准命令" class="headerlink" title="标准命令"></a>标准命令</h3><table>
<thead>
<tr>
<th>类型</th>
<th>代表命令</th>
</tr>
</thead>
<tbody><tr>
<td>程序控制类</td>
<td>g系列 t系列 p系列</td>
</tr>
<tr>
<td>内存查看修改类</td>
<td>d系列 e系列 s等</td>
</tr>
<tr>
<td>断点设置类</td>
<td>b系列</td>
</tr>
<tr>
<td>观察堆栈</td>
<td>k系列</td>
</tr>
<tr>
<td>反汇编命令</td>
<td>u系列</td>
</tr>
<tr>
<td>其它命令</td>
<td>x q ls等</td>
</tr>
</tbody></table>
<p>在命令输入框中输入？ 可以看到主要的标准命令及简介</p>
<p>元命令</p>
<p>元命令作为标准命令的一个补充也没内置在了Windbg中，其特点是以一个.开头，通常都是一个单次：</p>
<p>.symopt .sympathy .asm .restart .reboot ……</p>
<p>输入 .help可以查看到元命令以及帮助说明</p>
<p>扩展命令</p>
<p>注意：</p>
<pre><code>- 只有当程序暂停的时候才能输入命令
- 直接回车可以重复上一条命令
- 按上下方向键可以浏览之前输入的命令
- 当命令提示框为*BUSY\*的时候，无法立即输入命令</code></pre>
<h3 id="常用基本命令"><a href="#常用基本命令" class="headerlink" title="常用基本命令"></a>常用基本命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>lm</td>
<td>查看当前模块及符号加载情况</td>
</tr>
<tr>
<td>.reload</td>
<td>刷新符号路径，重新载入符号</td>
</tr>
<tr>
<td>ld</td>
<td>加载某一个模块符号</td>
</tr>
<tr>
<td>.restart</td>
<td>重新开始调试</td>
</tr>
<tr>
<td>.detach</td>
<td>分离调试</td>
</tr>
<tr>
<td>q</td>
<td>退出调试</td>
</tr>
</tbody></table>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">胡先森</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/">http://yoursite.com/2020/12/08/%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%82%E5%B8%B8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">Mr.Hu</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/WindowsError.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/09/%E5%8F%8D%E8%B0%83%E8%AF%95%E4%B8%8E%E5%8F%8D%E5%8F%8D%E8%B0%83%E8%AF%95/"><img class="prev-cover" data-lazy-src="/img/Debug2.01.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">反调试&amp;反反调试</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/05/010Editor%E7%9A%84%E9%80%86%E5%90%91/"><img class="next-cover" data-lazy-src="/img/16.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">逆向开发————010Editor注册机</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" style="background-image: url(/img/WindowsError.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 胡先森</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    $.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js', function () {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: 'Eo4Vh3u0nKU2EUIpOMidpb6L-gzGzoHsz',
      appKey: 'RIFmwqkX4dT5EpJghF6o6DWE',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: 'https://eo4vh3u0.lc-cn-n1-shared.com',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><style type="text/css">#toggle-sidebar {bottom: 80px}</style><div class="aplayer no-destroy" data-id="7322622901" data-server="tencent" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/third-party/ClickShowText.js" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script></div></body></html><!-- 雪花特效 -->
<script type="text/javascript" src="\js\snow.js"></script>