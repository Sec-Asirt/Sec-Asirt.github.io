<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>安全卫士————笔记 | Mr.Hu</title><meta name="description" content="基础功能TAB控件的封装与使用123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566&#x2F;&#x2F;封装的Tab控件函数void CMyTabDlg::InitTab(int nCount, ...)&amp;#123;	va_"><meta name="keywords" content="Windows,MFC"><meta name="author" content="胡先森"><meta name="copyright" content="胡先森"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yoursite.com/2020/11/22/%E5%AE%89%E5%85%A8%E5%8D%AB%E5%A3%AB%E7%AC%94%E8%AE%B0/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="yandex-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#49B1F5&quot;,&quot;paginator&quot;:&quot;#00c4b6&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;}}"/><meta property="og:type" content="article"><meta property="og:title" content="安全卫士————笔记"><meta property="og:url" content="http://yoursite.com/2020/11/22/%E5%AE%89%E5%85%A8%E5%8D%AB%E5%A3%AB%E7%AC%94%E8%AE%B0/"><meta property="og:site_name" content="Mr.Hu"><meta property="og:description" content="基础功能TAB控件的封装与使用123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566&#x2F;&#x2F;封装的Tab控件函数void CMyTabDlg::InitTab(int nCount, ...)&amp;#123;	va_"><meta property="og:image" content="http://yoursite.com/img/14.jpg"><meta property="article:published_time" content="2020-11-22T05:17:36.000Z"><meta property="article:modified_time" content="2020-12-11T06:20:17.287Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"❤富强❤,❤民主❤,❤和谐❤,❤友善❤,❤敬业❤,❤文明❤,❤自由❤,❤平等❤,❤公正❤,❤法治❤,❤爱国❤,❤诚信❤","fontSize":"15px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-12-11 14:20:17'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/projects/clock/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-bookmark"></i><span> 时光轴</span></a></div><div class="menus_item"><a class="site-page" href="/tools/"><i class="fa-fw fas fa-archive"></i><span> 工具</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 放松</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 学习</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/projects/photo/"><i class="fa-fw fas fa-images"></i><span> 照片墙</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-film"></i><span> 游戏</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/projects/game1/"><i class="fa-fw fas fa-heart"></i><span> 保卫星球</span></a></li><li><a class="site-page" href="/projects/game2/"><i class="fa-fw fas fa-heart"></i><span> 飞字快打</span></a></li><li><a class="site-page" href="/projects/game3/"><i class="fa-fw fas fa-heart"></i><span> 俄罗斯方块</span></a></li><li><a class="site-page" href="/projects/game4/"><i class="fa-fw fas fa-heart"></i><span> 特效画笔</span></a></li><li><a class="site-page" href="/projects/game5/"><i class="fa-fw fas fa-heart"></i><span> 音速小子</span></a></li><li><a class="site-page" href="/projects/game6/"><i class="fa-fw fas fa-heart"></i><span> 植物大战僵尸</span></a></li><li><a class="site-page" href="/projects/zifuyu/"><i class="fa-fw fas fa-heart"></i><span> 字符雨</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-link"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page" href="/projects/link/"><i class="fa-fw fas fa-link"></i><span> 网站导航</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user-circle"></i><span> 留言板</span></a></div></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD"><span class="toc-number">1.</span> <span class="toc-text">基础功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TAB%E6%8E%A7%E4%BB%B6%E7%9A%84%E5%B0%81%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">TAB控件的封装与使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E6%9C%BA%E3%80%81%E6%B3%A8%E9%94%80%E3%80%81%E9%94%81%E5%B1%8F%E3%80%81%E9%87%8D%E5%90%AF"><span class="toc-number">1.2.</span> <span class="toc-text">关机、注销、锁屏、重启</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CPU%E3%80%81%E5%86%85%E5%AD%98%E7%9A%84%E5%8D%A0%E6%9C%89%E7%8E%87%E8%8E%B7%E5%8F%96"><span class="toc-number">1.3.</span> <span class="toc-text">CPU、内存的占有率获取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%80%81%E6%9D%BF%E9%94%AE%E7%9A%84%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%93%8D%E5%BA%94"><span class="toc-number">1.4.</span> <span class="toc-text">老板键的注册与响应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%87%AA%E6%88%91%E5%A4%8D%E5%88%B6"><span class="toc-number">1.5.</span> <span class="toc-text">程序的自我复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E6%97%B6%E5%99%A8%E7%9A%84%E8%AE%BE%E7%BD%AE%E4%B8%8E%E5%93%8D%E5%BA%94"><span class="toc-number">1.6.</span> <span class="toc-text">计时器的设置与响应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%B3%E5%87%BB%E8%8F%9C%E5%8D%95%E7%9A%84%E5%93%8D%E5%BA%94"><span class="toc-number">1.7.</span> <span class="toc-text">右击菜单的响应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E8%BF%90%E8%A1%8C%E6%97%A0%E6%B3%95%E6%8B%96%E6%8B%BD"><span class="toc-number">1.8.</span> <span class="toc-text">管理员运行无法拖拽</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E6%8B%96%E6%8B%BD"><span class="toc-number">1.9.</span> <span class="toc-text">响应拖拽</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%81%8D%E5%8E%86"><span class="toc-number">1.10.</span> <span class="toc-text">进程遍历</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E9%81%8D%E5%8E%86%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.11.</span> <span class="toc-text">循环遍历进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.12.</span> <span class="toc-text">守护进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E7%94%A8dll"><span class="toc-number">1.12.1.</span> <span class="toc-text">所用dll</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%8D%E5%8E%86%E7%AA%97%E5%8F%A3"><span class="toc-number">1.13.</span> <span class="toc-text">遍历窗口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%BF%9B%E7%A8%8BPID"><span class="toc-number">1.14.</span> <span class="toc-text">获取进程PID</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86wchar-t%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%95%B4%E5%BD%A2"><span class="toc-number">1.15.</span> <span class="toc-text">将wchar_t类型转换为整形</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WCHAR-%E8%BD%ACchar"><span class="toc-number">1.16.</span> <span class="toc-text">WCHAR* 转char*</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%A8%8B%E5%BA%8F%E7%9A%84%E9%81%8D%E5%8E%86%E5%8F%8A%E5%8D%B8%E8%BD%BD"><span class="toc-number">2.</span> <span class="toc-text">安装程序的遍历及卸载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E3%80%81CPU%E3%80%81%E5%86%85%E5%AD%98%E7%BD%91%E5%8D%A1%E4%BF%A1%E6%81%AF%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-number">3.</span> <span class="toc-text">系统、CPU、内存网卡信息的获取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#h%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.</span> <span class="toc-text">.h文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cpp%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.</span> <span class="toc-text">.cpp文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E4%B8%8E%E8%BE%93%E5%87%BA"><span class="toc-number">3.3.</span> <span class="toc-text">调用与输出</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E9%81%8D%E5%8E%86%E4%B8%8E%E6%A0%91%E6%8E%A7%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">文件的遍历与树控件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%88%86%E5%8C%BA%E7%9B%98%E7%AC%A6"><span class="toc-number">4.2.</span> <span class="toc-text">获取分区盘符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%9B%AE%E5%BD%95"><span class="toc-number">4.3.</span> <span class="toc-text">添加目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%85%A8%E8%B7%AF%E5%BE%84"><span class="toc-number">4.4.</span> <span class="toc-text">获取全路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8List%E6%8E%A7%E4%BB%B6%E4%B8%AD%E6%98%BE%E7%A4%BA"><span class="toc-number">4.5.</span> <span class="toc-text">在List控件中显示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84%E4%BF%A1%E6%81%AF%E5%B9%B6%E8%BE%93%E5%87%BA"><span class="toc-number">4.6.</span> <span class="toc-text">获取文件的信息并输出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E5%87%BBlist%E6%8E%A7%E4%BB%B6%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E5%B9%B6%E6%89%A7%E8%A1%8C"><span class="toc-number">4.7.</span> <span class="toc-text">双击list控件中的文件并执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%B3%E5%87%BB%E6%96%87%E4%BB%B6%E5%88%97%E8%A1%A8%EF%BC%88List%EF%BC%89%E5%BC%B9%E7%AA%97%E6%98%BE%E7%A4%BA%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="toc-number">4.8.</span> <span class="toc-text">右击文件列表（List）弹窗显示详细信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E5%8F%B3%E5%87%BB%E5%B9%B6%E5%BC%B9%E7%AA%97"><span class="toc-number">4.8.1.</span> <span class="toc-text">响应右击并弹窗</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E4%BF%A1%E6%81%AF%E5%8F%8A%E7%BA%BF%E7%A8%8B%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-number">4.8.2.</span> <span class="toc-text">输出信息及线程的调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97MD5%E5%80%BC%EF%BC%88%E9%9C%80%E8%A6%81%E4%BF%9D%E6%8A%A4openssl%EF%BC%89"><span class="toc-number">4.8.3.</span> <span class="toc-text">计算MD5值（需要保护openssl）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E6%88%90%E6%88%91%E4%BB%AC%E7%9C%8B%E7%9A%84%E6%87%82%E7%9A%8416%E8%BF%9B%E5%88%B6"><span class="toc-number">4.8.4.</span> <span class="toc-text">转换成我们看的懂的16进制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%B8%85%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">文件清理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%85%E7%A9%BA%E6%B4%BB%E5%9B%9E%E6%94%B6%E7%AB%99"><span class="toc-number">5.1.</span> <span class="toc-text">清空活回收站</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VS%E5%B7%A5%E7%A8%8B%E6%B8%85%E7%90%86"><span class="toc-number">5.2.</span> <span class="toc-text">VS工程清理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E9%81%8D%E5%8E%86"><span class="toc-number">5.2.1.</span> <span class="toc-text">文件遍历</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4"><span class="toc-number">5.2.2.</span> <span class="toc-text">文件删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%BC%93%E5%AD%98"><span class="toc-number">5.3.</span> <span class="toc-text">系统缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9F%A5%E6%89%BE"><span class="toc-number">5.3.1.</span> <span class="toc-text">缓存查找</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="toc-number">5.3.2.</span> <span class="toc-text">回调函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E9%81%8D%E5%8E%86-1"><span class="toc-number">5.3.3.</span> <span class="toc-text">文件遍历</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%EF%BC%88%E7%B1%BB%E4%BC%BC%E4%BA%8E%E4%B8%80%E9%94%AE%E5%8A%A0%E9%80%9F%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">内存优化（类似于一键加速）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LOAD-PE%E8%A7%A3%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">LOAD_PE解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-1"><span class="toc-number">7.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E4%B8%BAPE%E6%96%87%E4%BB%B6"><span class="toc-number">7.2.</span> <span class="toc-text">判断文件是否为PE文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%8D%E7%BD%AE%E8%AE%A1%E7%AE%97%E5%99%A8"><span class="toc-number">7.3.</span> <span class="toc-text">位置计算器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87VA%E8%AE%A1%E7%AE%97RVA%E3%80%81FOA"><span class="toc-number">7.3.1.</span> <span class="toc-text">通过VA计算RVA、FOA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87RVA%E8%AE%A1%E7%AE%97VA%E3%80%81FOA"><span class="toc-number">7.3.2.</span> <span class="toc-text">通过RVA计算VA、FOA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87FOA%E8%AE%A1%E7%AE%97VA%E3%80%81RVA"><span class="toc-number">7.3.3.</span> <span class="toc-text">通过FOA计算VA、RVA</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RVA%E8%BD%AC%E6%8D%A2FOA%EF%BC%88%E5%87%BD%E6%95%B0%E5%B0%81%E8%A3%85%EF%BC%89"><span class="toc-number">7.4.</span> <span class="toc-text">RVA转换FOA（函数封装）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E8%A1%A8"><span class="toc-number">7.5.</span> <span class="toc-text">目录表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E8%A1%A8"><span class="toc-number">7.5.1.</span> <span class="toc-text">导出表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E8%A1%A8%E7%9A%84%E8%A7%A3%E6%9E%90%E4%B8%8E%E8%BE%93%E5%87%BA"><span class="toc-number">7.5.1.1.</span> <span class="toc-text">导出表的解析与输出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E8%A1%A8"><span class="toc-number">7.5.2.</span> <span class="toc-text">导入表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-2"><span class="toc-number">7.5.2.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E8%A1%A8%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="toc-number">7.5.2.2.</span> <span class="toc-text">导入表的解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E8%A1%A8%E7%9A%84%E8%BE%93%E5%87%BA"><span class="toc-number">7.5.2.3.</span> <span class="toc-text">导入表的输出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A8"><span class="toc-number">7.5.3.</span> <span class="toc-text">重定位表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-3"><span class="toc-number">7.5.3.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BA%E6%AE%B5"><span class="toc-number">7.5.3.2.</span> <span class="toc-text">区段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9D%97"><span class="toc-number">7.5.3.3.</span> <span class="toc-text">块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E5%87%BB%E5%8C%BA%E6%AE%B5%E5%93%8D%E5%BA%94%E5%9D%97"><span class="toc-number">7.5.3.4.</span> <span class="toc-text">点击区段响应块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TLS%E8%A1%A8"><span class="toc-number">7.5.4.</span> <span class="toc-text">TLS表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TLS%E8%A1%A8%E7%9A%84%E8%BE%93%E5%87%BA"><span class="toc-number">7.5.4.1.</span> <span class="toc-text">TLS表的输出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E8%BE%93%E5%85%A5%E8%A1%A8"><span class="toc-number">7.5.5.</span> <span class="toc-text">延迟输入表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E8%BE%93%E5%85%A5%E8%A1%A8%E7%9A%84%E8%BE%93%E5%87%BA"><span class="toc-number">7.5.5.1.</span> <span class="toc-text">延迟输入表的输出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%BA%E6%AE%B5%E8%A1%A8"><span class="toc-number">7.6.</span> <span class="toc-text">区段表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-4"><span class="toc-number">7.6.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E4%B8%8E%E8%BE%93%E5%87%BA"><span class="toc-number">7.6.2.</span> <span class="toc-text">解析与输出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E6%9D%80"><span class="toc-number">8.</span> <span class="toc-text">查杀</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MD5"><span class="toc-number">8.1.</span> <span class="toc-text">MD5</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8MD5%E6%9F%A5%E6%9D%80"><span class="toc-number">8.1.1.</span> <span class="toc-text">启动MD5查杀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MD5%E2%80%94CallBack%E5%9B%9E%E8%B0%83"><span class="toc-number">8.1.2.</span> <span class="toc-text">MD5—CallBack回调</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E9%9C%80%E8%A6%81%E6%9F%A5%E6%9D%80%E7%9A%84%E7%9B%AE%E5%BD%95%E5%8F%8A%E6%96%87%E4%BB%B6"><span class="toc-number">8.1.3.</span> <span class="toc-text">获取需要查杀的目录及文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81MD5%E5%80%BC"><span class="toc-number">8.1.4.</span> <span class="toc-text">验证MD5值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81MD5%E6%89%80%E7%94%A8%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">8.1.5.</span> <span class="toc-text">验证MD5所用的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%96%87%E4%BB%B6%E7%9A%84%E5%88%A0%E9%99%A4"><span class="toc-number">8.1.6.</span> <span class="toc-text">异常文件的删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%91%E7%AB%AF%E6%9F%A5%E6%9D%80"><span class="toc-number">8.2.</span> <span class="toc-text">云端查杀</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E7%BA%BF%E7%A8%8B"><span class="toc-number">8.2.1.</span> <span class="toc-text">开启线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E6%9C%AC%E5%9C%B0%E7%9A%84%E6%96%87%E4%BB%B6%E9%81%8D%E5%8E%86%E5%8F%8AMD5%E8%AE%A1%E7%AE%97%E5%8F%8A%E5%90%AF%E5%8A%A8%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">8.2.2.</span> <span class="toc-text">调用本地的文件遍历及MD5计算及启动客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">8.2.3.</span> <span class="toc-text">客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">8.2.4.</span> <span class="toc-text">服务端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%85%A5%E5%8F%A3"><span class="toc-number">8.2.4.1.</span> <span class="toc-text">服务端入口</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(/img/14.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Mr.Hu</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/projects/clock/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-bookmark"></i><span> 时光轴</span></a></div><div class="menus_item"><a class="site-page" href="/tools/"><i class="fa-fw fas fa-archive"></i><span> 工具</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 放松</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 学习</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/projects/photo/"><i class="fa-fw fas fa-images"></i><span> 照片墙</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-film"></i><span> 游戏</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/projects/game1/"><i class="fa-fw fas fa-heart"></i><span> 保卫星球</span></a></li><li><a class="site-page" href="/projects/game2/"><i class="fa-fw fas fa-heart"></i><span> 飞字快打</span></a></li><li><a class="site-page" href="/projects/game3/"><i class="fa-fw fas fa-heart"></i><span> 俄罗斯方块</span></a></li><li><a class="site-page" href="/projects/game4/"><i class="fa-fw fas fa-heart"></i><span> 特效画笔</span></a></li><li><a class="site-page" href="/projects/game5/"><i class="fa-fw fas fa-heart"></i><span> 音速小子</span></a></li><li><a class="site-page" href="/projects/game6/"><i class="fa-fw fas fa-heart"></i><span> 植物大战僵尸</span></a></li><li><a class="site-page" href="/projects/zifuyu/"><i class="fa-fw fas fa-heart"></i><span> 字符雨</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-link"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page" href="/projects/link/"><i class="fa-fw fas fa-link"></i><span> 网站导航</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user-circle"></i><span> 留言板</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">安全卫士————笔记</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-22T05:17:36.000Z" title="发表于 2020-11-22 13:17:36">2020-11-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-12-11T06:20:17.287Z" title="更新于 2020-12-11 14:20:17">2020-12-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Windows/">Windows</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">15.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>78分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="基础功能"><a href="#基础功能" class="headerlink" title="基础功能"></a>基础功能</h1><h2 id="TAB控件的封装与使用"><a href="#TAB控件的封装与使用" class="headerlink" title="TAB控件的封装与使用"></a>TAB控件的封装与使用</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//封装的Tab控件函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyTabDlg::InitTab</span><span class="params">(<span class="keyword">int</span> nCount, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	va_list  vl;</span><br><span class="line">	va_start(vl, nCount);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nCount; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//1 获取这一个选项，需要的数据</span></span><br><span class="line">		<span class="keyword">wchar_t</span>* szTabItemName = va_arg(vl, <span class="keyword">wchar_t</span>*);</span><br><span class="line">		CDialogEx* pDlg = va_arg(vl, CDialogEx*);</span><br><span class="line">		DWORD dwId = va_arg(vl, DWORD);</span><br><span class="line">		<span class="comment">//2 创建选项，创建子窗口</span></span><br><span class="line">		InsertItem(i, szTabItemName);</span><br><span class="line">		pDlg-&gt;Create(dwId, <span class="keyword">this</span>);</span><br><span class="line">		<span class="comment">//3 将子窗口移动合适的位置上</span></span><br><span class="line">		CRect rc = &#123;&#125;;</span><br><span class="line">		GetClientRect(&amp;rc);</span><br><span class="line">		<span class="comment">//4 将矩形框，缩小一下，能够把Tab的表头 显示出来</span></span><br><span class="line">		rc.DeflateRect(<span class="number">1</span>, <span class="number">23</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">		<span class="comment">//5 移动</span></span><br><span class="line">		pDlg-&gt;MoveWindow(rc);</span><br><span class="line">		m_vecDlg.push_back(pDlg);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m_vecDlg[<span class="number">0</span>]-&gt;ShowWindow(SW_SHOW);</span><br><span class="line">	va_end(vl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//消息映射</span></span><br><span class="line">ON_NOTIFY_REFLECT(TCN_SELCHANGE, &amp;CMyTabDlg::OnTcnSelchange)</span><br><span class="line"><span class="comment">//类中声明</span></span><br><span class="line"><span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnTcnSelchange</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span>;</span><br><span class="line"><span class="comment">//响应Tab控件的切换</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyTabDlg::OnTcnSelchange</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> nSel = GetCurSel();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_vecDlg.size(); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (i == nSel)</span><br><span class="line">		&#123;</span><br><span class="line">			m_vecDlg[i]-&gt;ShowWindow(SW_SHOW);	</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		m_vecDlg[i]-&gt;ShowWindow(SW_HIDE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*pResult = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//主类中的绑定</span></span><br><span class="line">CMyTabDlg m_objTabDlg;<span class="comment">//主类中控件的声明定义</span></span><br><span class="line">DDX_Control(pDX, IDC_TAB1, m_objTabDlg);<span class="comment">//控件的绑定</span></span><br><span class="line"><span class="comment">//主类的调用</span></span><br><span class="line">m_objTabDlg.InitTab(<span class="number">7</span>,</span><br><span class="line">		<span class="string">L&quot;我的电脑&quot;</span>, <span class="keyword">new</span> CMyComputerDlg(), IDD_COMPUTER,</span><br><span class="line">		<span class="string">L&quot;LOAD_PE&quot;</span>,<span class="keyword">new</span> CMyLoadPeDlg(),IDD_LOADPE,</span><br><span class="line">		<span class="string">L&quot;清理&quot;</span>, <span class="keyword">new</span> CMySystemDlg(), IDD_SYSTEMINFO,</span><br><span class="line">		<span class="string">L&quot;程序&quot;</span>, <span class="keyword">new</span> CMyInstallDlg(), IDD_INSTALL,</span><br><span class="line">		<span class="string">L&quot;服务&quot;</span>, <span class="keyword">new</span> CMyServicesDlg(), IDD_SERVICES,</span><br><span class="line">		<span class="string">L&quot;启动项&quot;</span>, <span class="keyword">new</span> CMyStartItemDlg(), IDD_STARTITEM,</span><br><span class="line">		<span class="string">L&quot;查杀&quot;</span>, <span class="keyword">new</span> CMyAntivirusDlg(), IDD_ANTIVIRUS</span><br><span class="line">	);</span><br></pre></td></tr></table></figure>



<h2 id="关机、注销、锁屏、重启"><a href="#关机、注销、锁屏、重启" class="headerlink" title="关机、注销、锁屏、重启"></a>关机、注销、锁屏、重启</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ID_32784:<span class="comment">//关机</span></span><br><span class="line">		SetSystem();</span><br><span class="line">		ExitWindowsEx(EWX_POWEROFF | EWX_FORCE, SHTDN_REASON_FLAG_USER_DEFINED);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> ID_32785:<span class="comment">//重启</span></span><br><span class="line">		SetSystem();</span><br><span class="line">		ExitWindowsEx(EWX_REBOOT | EWX_FORCE, SHTDN_REASON_FLAG_USER_DEFINED);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> ID_32786:<span class="comment">//注销</span></span><br><span class="line">		ExitWindowsEx(EWX_LOGOFF | EWX_FORCE, SHTDN_REASON_FLAG_USER_DEFINED);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> ID_32787:<span class="comment">//锁屏</span></span><br><span class="line">		LockWorkStation();</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line"><span class="comment">//关机、重启所需要调用的提权函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CSecurityguardDlg::SetSystem</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hTOken = <span class="literal">NULL</span>;</span><br><span class="line">	HANDLE hProcess = GetCurrentProcess();<span class="comment">//获取进程伪句柄</span></span><br><span class="line">	OpenProcessToken(hProcess, TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hTOken);</span><br><span class="line">	TOKEN_PRIVILEGES tp = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	LookupPrivilegeValue(<span class="number">0</span>, SE_SHUTDOWN_NAME, &amp;tp.Privileges[<span class="number">0</span>].Luid);</span><br><span class="line">	tp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">	tp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	AdjustTokenPrivileges(hTOken, FALSE, &amp;tp, <span class="keyword">sizeof</span>(tp), <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

<h2 id="CPU、内存的占有率获取"><a href="#CPU、内存的占有率获取" class="headerlink" title="CPU、内存的占有率获取"></a>CPU、内存的占有率获取</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用于辅助CPU的获取（时间换算）</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">FILETIME2Double</span><span class="params">(<span class="keyword">const</span> _FILETIME&amp; filetime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">double</span>(filetime.dwHighDateTime * <span class="number">4.294967296e9</span>)</span><br><span class="line">		+ <span class="keyword">double</span>(filetime.dwLowDateTime);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//CPU占用率获取</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CSecurityguardDlg::GetCpusage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//          空闲时间   内核时间     用户时间</span></span><br><span class="line">	_FILETIME idleTime, kernelTime, userTime;</span><br><span class="line">	<span class="comment">//获取时间</span></span><br><span class="line">	GetSystemTimes(&amp;idleTime, &amp;kernelTime, &amp;userTime);</span><br><span class="line"></span><br><span class="line">	HANDLE hEvent = CreateEvent(<span class="literal">NULL</span>, FALSE, FALSE, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">//等待1000毫秒</span></span><br><span class="line">	WaitForSingleObject(hEvent, <span class="number">50</span>);</span><br><span class="line">	<span class="comment">//获取新时间</span></span><br><span class="line">	_FILETIME newTime, newKerneTime, newUserTime;</span><br><span class="line">	GetSystemTimes(&amp;newTime, &amp;newKerneTime, &amp;newUserTime);</span><br><span class="line">	<span class="comment">//将各个时间转换</span></span><br><span class="line">	<span class="keyword">double</span> dOldIdleTime = FILETIME2Double(idleTime);</span><br><span class="line">	<span class="keyword">double</span> dNewIdleTime = FILETIME2Double(newTime);</span><br><span class="line">	<span class="keyword">double</span> dOldKernelTime = FILETIME2Double(kernelTime);</span><br><span class="line">	<span class="keyword">double</span> dNewKernelTime = FILETIME2Double(newKerneTime);</span><br><span class="line">	<span class="keyword">double</span> dOldUserTime = FILETIME2Double(userTime);</span><br><span class="line">	<span class="keyword">double</span> dNewUserTime = FILETIME2Double(newUserTime);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(<span class="number">100.0</span> - (dNewIdleTime - dOldIdleTime) / (dNewKernelTime - dOldKernelTime + dNewUserTime - dOldUserTime) * <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//内存占用率获取</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CSecurityguardDlg::GetMemsage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MEMORYSTATUS memStatus;</span><br><span class="line">	GlobalMemoryStatus(&amp;memStatus);</span><br><span class="line">	CString strmery;</span><br><span class="line">	strmery.Format(<span class="string">L&quot;内存占用率: %d%%&quot;</span>, memStatus.dwMemoryLoad);	</span><br><span class="line">	m_strMem.SetString(strmery);<span class="comment">//在文本上显示</span></span><br><span class="line">	UpdateData(FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="老板键的注册与响应"><a href="#老板键的注册与响应" class="headerlink" title="老板键的注册与响应"></a>老板键的注册与响应</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ON_WM_HOTKEY()<span class="comment">//消息映射</span></span><br><span class="line"><span class="comment">//类中声明</span></span><br><span class="line"><span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnHotKey</span><span class="params">(UINT nHotKeyId, UINT nKey1, UINT nKey2)</span></span>;</span><br><span class="line"><span class="comment">//注册老板键//响应注册的按键Ctrl + Shift + Z </span></span><br><span class="line">	::RegisterHotKey(</span><br><span class="line">		m_hWnd,							<span class="comment">//响应热键的窗口句柄</span></span><br><span class="line">		<span class="number">0x1234</span>,							<span class="comment">//热键ID，自定义ID值</span></span><br><span class="line">		MOD_CONTROL | MOD_SHIFT,				<span class="comment">//辅助按键</span></span><br><span class="line">		<span class="string">&#x27;Z&#x27;</span>							<span class="comment">//键值，按键码</span></span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//老板键的响应</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CSecurityguardDlg::OnHotKey</span><span class="params">(UINT nHotKeyId, UINT nKey1, UINT nKey2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ShowWindow(SW_HIDE);<span class="comment">//隐藏</span></span><br><span class="line">		i = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		ShowWindow(SW_SHOW);<span class="comment">//显示</span></span><br><span class="line">	&#125;</span><br><span class="line">	CDialogEx::OnHotKey(nHotKeyId, nKey1, nKey2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="程序的自我复制"><a href="#程序的自我复制" class="headerlink" title="程序的自我复制"></a>程序的自我复制</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复制到开机启动路径</span></span><br><span class="line">	LPCTSTR targetPath = _T(<span class="string">&quot;C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp\\安全卫士.exe&quot;</span>); </span><br><span class="line">	CopyMyselfTo(targetPath);</span><br><span class="line"></span><br><span class="line"><span class="comment">//自我复制</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CSecurityguardDlg::CopyMyselfTo</span><span class="params">(LPCTSTR targetPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TCHAR tcBuf[_MAX_PATH]; <span class="comment">// 缓冲区</span></span><br><span class="line">   <span class="comment">// 取自己程序的程序名</span></span><br><span class="line">	::GetModuleFileName(<span class="literal">NULL</span>, tcBuf, <span class="keyword">sizeof</span>(tcBuf));</span><br><span class="line">	<span class="comment">// 复制文件</span></span><br><span class="line">	::CopyFile(tcBuf, targetPath, FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="计时器的设置与响应"><a href="#计时器的设置与响应" class="headerlink" title="计时器的设置与响应"></a>计时器的设置与响应</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ON_WM_TIMER()<span class="comment">//消息映射</span></span><br><span class="line"><span class="comment">//类中声明</span></span><br><span class="line"><span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnTimer</span><span class="params">(UINT_PTR nIDEvent)</span></span>;</span><br><span class="line"><span class="comment">// 设置计时器</span></span><br><span class="line">	SetTimer(</span><br><span class="line">		<span class="number">1</span>,   <span class="comment">//自定义的Timer的ID</span></span><br><span class="line">		<span class="number">1000</span>, <span class="comment">//间隔的毫秒数</span></span><br><span class="line">		<span class="literal">NULL</span> <span class="comment">//回调函数，如果设置了，每隔500毫秒调这个回调函数</span></span><br><span class="line">	);	 <span class="comment">//如果没有设置，就是给主窗口发WM_TIMER消息</span></span><br><span class="line">	SetTimer(</span><br><span class="line">		<span class="number">2</span>,   <span class="comment">//自定义的Timer的ID</span></span><br><span class="line">		<span class="number">1000</span>, <span class="comment">//间隔的毫秒数</span></span><br><span class="line">		<span class="literal">NULL</span> <span class="comment">//回调函数，如果设置了，每隔500毫秒调这个回调函数</span></span><br><span class="line">	);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//响应计时器</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CSecurityguardDlg::OnTimer</span><span class="params">(UINT_PTR nIDEvent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (nIDEvent == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		CString str;</span><br><span class="line">		str.Format(<span class="string">L&quot;CPU占用率：%d%%&quot;</span>, GetCpusage());</span><br><span class="line">		m_strCpu.SetString(str);</span><br><span class="line">		UpdateData(FALSE);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (nIDEvent == <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		GetMemsage();</span><br><span class="line">	&#125;</span><br><span class="line">	CDialogEx::OnTimer(nIDEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="右击菜单的响应"><a href="#右击菜单的响应" class="headerlink" title="右击菜单的响应"></a>右击菜单的响应</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//消息映射</span></span><br><span class="line">ON_NOTIFY(NM_RCLICK, IDC_SERVICES, &amp;CMyServicesDlg::OnRclickServices)</span><br><span class="line"><span class="comment">//类中声明</span></span><br><span class="line"><span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnRclickServices</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span>;</span><br><span class="line"><span class="comment">//右击弹出菜单</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyServicesDlg::OnRclickServices</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LPNMITEMACTIVATE pNMItemActivate = <span class="keyword">reinterpret_cast</span>&lt;LPNMITEMACTIVATE&gt;(pNMHDR);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 需要载入菜单资源</span></span><br><span class="line">	CMenu obj;</span><br><span class="line">	obj.LoadMenuW(IDR_MENU3);</span><br><span class="line">	<span class="comment">//坐标转换</span></span><br><span class="line">	POINT pt = &#123; pNMItemActivate-&gt;ptAction.x,pNMItemActivate-&gt;ptAction.y&#125;;</span><br><span class="line">	ClientToScreen(&amp;pt);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取一个下拉菜单</span></span><br><span class="line">	CMenu* pSubMenu1 = obj.GetSubMenu(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 弹出菜单</span></span><br><span class="line">	pSubMenu1-&gt;TrackPopupMenu(TPM_LEFTALIGN, pt.x, pt.y, <span class="keyword">this</span>);</span><br><span class="line">	<span class="comment">//获取ID（选择的进程）</span></span><br><span class="line">	<span class="keyword">int</span> item = pNMItemActivate-&gt;iItem;  <span class="comment">//LPNMITEMACTIVATF 这个结构体 iItem 有列表框记录的信息</span></span><br><span class="line">	strName = m_objServices.GetItemText(item, <span class="number">0</span>);  <span class="comment">//获取文本框</span></span><br><span class="line">	</span><br><span class="line">	*pResult = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//消息映射</span></span><br><span class="line">ON_COMMAND_RANGE(ID_32789, ID_32790, &amp;CMyServicesDlg::OnRangeCmds1)</span><br><span class="line"><span class="comment">//类中声明</span></span><br><span class="line"><span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnRangeCmds1</span><span class="params">(UINT nMenuID)</span></span>;</span><br><span class="line"><span class="comment">//响应弹出菜单</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyServicesDlg::OnRangeCmds1</span><span class="params">(UINT nMenuID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//获取服务的开启与结束需要的相应权限的句柄</span></span><br><span class="line">	SC_HANDLE hScMess = OpenSCManagerW(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_ALL_ACCESS);</span><br><span class="line">	SC_HANDLE hService = OpenService(hScMess,strName,SC_MANAGER_ALL_ACCESS</span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">switch</span> (nMenuID)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> ID_32789:<span class="comment">//开启服务</span></span><br><span class="line">		StartService(hService, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> ID_32790:<span class="comment">//结束服务</span></span><br><span class="line">		SERVICE_STATUS_PROCESS ssp;</span><br><span class="line">		ControlService(hService, SERVICE_CONTROL_STOP, (LPSERVICE_STATUS)&amp;ssp);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="管理员运行无法拖拽"><a href="#管理员运行无法拖拽" class="headerlink" title="管理员运行无法拖拽"></a>管理员运行无法拖拽</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解决管理员无法拖拽</span></span><br><span class="line">	ChangeWindowMessageFilter(WM_DROPFILES, MSGFLT_ADD);</span><br><span class="line">	ChangeWindowMessageFilter(<span class="number">0x0049</span>, MSGFLT_ADD);</span><br></pre></td></tr></table></figure>

<h2 id="响应拖拽"><a href="#响应拖拽" class="headerlink" title="响应拖拽"></a>响应拖拽</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//响应文件拖拽</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyLoadPeDlg::OnDropFiles</span><span class="params">(HDROP hDropInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">	<span class="comment">// 存放文件路径</span></span><br><span class="line">	<span class="keyword">wchar_t</span> filePath[MAX_PATH] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取拖拽文件的路径</span></span><br><span class="line">	DragQueryFile(hDropInfo, <span class="number">0</span>, filePath, MAX_PATH);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	CDialogEx::OnDropFiles(hDropInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="进程遍历"><a href="#进程遍历" class="headerlink" title="进程遍历"></a>进程遍历</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//遍历进程</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyLoadPeDlg::EnumProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_vecProcess.clear();</span><br><span class="line">    CString cs;</span><br><span class="line">	HANDLE hSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	PROCESSENTRY32 pe = &#123; <span class="keyword">sizeof</span>(pe) &#125;;</span><br><span class="line">	<span class="keyword">if</span> (Process32First(hSnap, &amp;pe))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			PROCESS* stcPro = <span class="keyword">new</span> PROCESS;</span><br><span class="line"></span><br><span class="line">			GetPathByProcessId(pe.th32ProcessID, stcPro);</span><br><span class="line">			cs = szPath;<span class="comment">//WCHAR*[MAX+PATH]无法直接与L&quot;&quot;比较（类型不符），所以这里需要转换一下</span></span><br><span class="line">			<span class="keyword">if</span> (cs==<span class="string">L&quot;&quot;</span>)<span class="comment">//如果路径为空直接输出进程名</span></span><br><span class="line">			&#123;</span><br><span class="line">				m_objProcessList.InsertItem(i, pe.szExeFile, i);</span><br><span class="line">			&#125;		</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				SHFILEINFO info = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">				CString temp = szPath;</span><br><span class="line">				SHGetFileInfo(temp, <span class="number">0</span>, &amp;info, <span class="keyword">sizeof</span>(&amp;info), SHGFI_DISPLAYNAME | SHGFI_ICON);</span><br><span class="line">				m_ImageList.Add(info.hIcon);</span><br><span class="line">				<span class="keyword">if</span> (info.hIcon == <span class="literal">NULL</span>)<span class="comment">//如果图标没有获取到，则直接输出进程名</span></span><br><span class="line">				&#123;</span><br><span class="line">					m_objProcessList.InsertItem(i, pe.szExeFile, i);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					m_objProcessList.InsertItem(i, info.szDisplayName, i);</span><br><span class="line">				&#125;				</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 转换成字符串格式</span></span><br><span class="line">			<span class="keyword">wchar_t</span> tmp[<span class="number">100</span>] = &#123;&#125;;</span><br><span class="line">			wsprintf(tmp, <span class="string">L&quot;%d&quot;</span>, pe.th32ProcessID);</span><br><span class="line"></span><br><span class="line">			m_objProcessList.SetItemText(i, <span class="number">1</span>, tmp);</span><br><span class="line"></span><br><span class="line">			cs.Format(<span class="string">L&quot;%d&quot;</span>, pe.cntThreads);</span><br><span class="line">			m_objProcessList.SetItemText(i, <span class="number">2</span>, cs);</span><br><span class="line"></span><br><span class="line">			m_objProcessList.SetItemText(i, <span class="number">3</span>, <span class="string">L&quot;正在运行&quot;</span>);</span><br><span class="line">			<span class="comment">//使用vector保存进程名和id</span></span><br><span class="line">			cs = szPath;</span><br><span class="line">			m_objProcessList.SetItemText(i, <span class="number">4</span>, cs);</span><br><span class="line">			stcPro-&gt;csProcessName = pe.szExeFile;</span><br><span class="line">			stcPro-&gt;dwProcessId = pe.th32ProcessID;</span><br><span class="line">			stcPro-&gt;csProcessPath = szPath;</span><br><span class="line">			m_vecProcess.push_back(stcPro);</span><br><span class="line">			i++;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">while</span> (Process32Next(hSnap, &amp;pe));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="循环遍历进程"><a href="#循环遍历进程" class="headerlink" title="循环遍历进程"></a>循环遍历进程</h2><p>查找是否由黑名单进程，既然是循环肯定要开线程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//循环遍历进程，查看是否由黑名单程序运行</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyLoadPeDlg::WhileProcessEunm</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="comment">// 判断快照句柄是否有效</span></span><br><span class="line">		<span class="keyword">if</span> (hSnapshot != INVALID_HANDLE_VALUE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//定义进程结构体，第一个元素必须赋值为结构体大小</span></span><br><span class="line">			PROCESSENTRY32 stcPe32 = &#123; <span class="keyword">sizeof</span>(PROCESSENTRY32) &#125;;</span><br><span class="line">			<span class="comment">//查找第一个进程</span></span><br><span class="line">			Process32First(hSnapshot, &amp;stcPe32);		</span><br><span class="line">			<span class="keyword">do</span></span><br><span class="line">			&#123;	<span class="comment">// 如果进程名一致，返回进程id</span></span><br><span class="line">				</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m_vecHeiName.size(); i++)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (stcPe32.szExeFile == m_vecHeiName[i])</span><br><span class="line">					&#123;</span><br><span class="line">						HANDLE Process = OpenProcess(PROCESS_TERMINATE, FALSE, stcPe32.th32ProcessID);</span><br><span class="line">						TerminateProcess(Process, <span class="number">0</span>);</span><br><span class="line">						<span class="comment">//CloseHandle(Process);</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//查找下一个进程</span></span><br><span class="line">			&#125; <span class="keyword">while</span> (Process32Next(hSnapshot, &amp;stcPe32));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//关闭快照句柄	</span></span><br><span class="line">		CloseHandle(hSnapshot);</span><br><span class="line">	Sleep(<span class="number">1000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLPATH <span class="meta-string">&quot;C:\\xxx\\InlineHook.dll&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//守护进程的回调函数</span></span><br><span class="line"><span class="function">WORD WINAPI <span class="title">ThreadGuardianProcessBack</span><span class="params">(LPARAM lparam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CMyLoadPeDlg* pObj = (CMyLoadPeDlg*)lparam;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 1.获取目标进程句柄</span></span><br><span class="line">	<span class="comment">// 1.1 获取指定进程id</span></span><br><span class="line">	DWORD dwPid = GetPid(<span class="string">L&quot;Taskmgr.exe&quot;</span>);</span><br><span class="line">	<span class="comment">// 1.2 打开进程（注入OD需要以管理员身份运行vs，否则无法打开进程)</span></span><br><span class="line">	HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);</span><br><span class="line">	<span class="comment">// 1.3 检测进程句柄</span></span><br><span class="line">	<span class="keyword">if</span> (hProcess == INVALID_HANDLE_VALUE)</span><br><span class="line">		ThreadGuardianProcessBack((LPARAM)pObj);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2.1 计算dll路径长度</span></span><br><span class="line">	DWORD dwSize = <span class="built_in">strlen</span>(DLLPATH) + <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// 2.在目标进程申请一段空间</span></span><br><span class="line">	LPVOID lpAddr = VirtualAllocEx(</span><br><span class="line">		hProcess, <span class="number">0</span>, dwSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!WriteProcessMemory(hProcess, lpAddr, DLLPATH, dwSize, <span class="literal">NULL</span>))</span><br><span class="line">		ThreadGuardianProcessBack((LPARAM)pObj);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.创建远程线程</span></span><br><span class="line">	HANDLE hRtThread = CreateRemoteThread(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		(LPTHREAD_START_ROUTINE)LoadLibraryA, lpAddr, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	Sleep(<span class="number">1000000</span>);</span><br><span class="line">	<span class="comment">// 5.等待执行结果</span></span><br><span class="line">	WaitForSingleObject(hRtThread, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 6.获取线程退出码</span></span><br><span class="line">	DWORD dwExitCode = <span class="number">0</span>;</span><br><span class="line">	GetExitCodeThread(hRtThread, &amp;dwExitCode);</span><br><span class="line">	<span class="comment">// 6.1 退出码也就是LoadLibrary的返回值（如果执行成功，就是dll的模块句柄）</span></span><br><span class="line">	HMODULE hModule = (HMODULE)dwExitCode;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 7.释放空间</span></span><br><span class="line">	<span class="keyword">if</span> (!VirtualFreeEx(hProcess, lpAddr, dwSize, MEM_DECOMMIT))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	CloseHandle(hProcess);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="所用dll"><a href="#所用dll" class="headerlink" title="所用dll"></a>所用dll</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过进程名获取进程id</span></span><br><span class="line"><span class="function">DWORD <span class="title">GetPid</span><span class="params">(<span class="keyword">const</span> <span class="keyword">wchar_t</span>* filePath)</span></span>;</span><br><span class="line"><span class="comment">// 获取被保护程序pid</span></span><br><span class="line">DWORD g_dwPid = GetPid(<span class="string">L&quot;FileCleaner2.0.exe&quot;</span>);</span><br><span class="line"><span class="comment">// 旧的函数地址</span></span><br><span class="line">DWORD* g_pOldAddr = (DWORD*)OpenProcess;</span><br><span class="line"><span class="comment">// 旧的函数数据</span></span><br><span class="line"><span class="keyword">char</span> g_oldCode[<span class="number">5</span>] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnHook</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnHook</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编写自己的OpenProcess函数</span></span><br><span class="line"><span class="function">HANDLE WINAPI <span class="title">MyOpenProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	_In_ DWORD dwDesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">	_In_ BOOL bInheritHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">	_In_ DWORD dwProcessId</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 比对pid是否与helloworld程序相等</span></span><br><span class="line">	<span class="keyword">if</span> (dwProcessId == g_dwPid)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(<span class="number">0</span>,<span class="string">L&quot;进程被保护&quot;</span>,<span class="string">L&quot;提示&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 如果不相等，重新调用原来的OpenProcess函数</span></span><br><span class="line">		<span class="comment">// 先恢复原来函数数据</span></span><br><span class="line">		UnHook();</span><br><span class="line">		HANDLE hProcess = OpenProcess(</span><br><span class="line">			dwDesiredAccess, bInheritHandle, dwProcessId);</span><br><span class="line">		<span class="comment">// 调用完之后重新hook</span></span><br><span class="line">		OnHook();</span><br><span class="line">		<span class="keyword">return</span> hProcess;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">	DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">	LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">	&#123;</span><br><span class="line">		OnHook();</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;注入成功&quot;</span>, <span class="string">L&quot;提示&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">	<span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">	<span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnHook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 1.先保存OpenProcess原来的数据</span></span><br><span class="line">	<span class="built_in">memcpy</span>(g_oldCode, g_pOldAddr, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2.设置新的指令,jmp</span></span><br><span class="line">	<span class="keyword">char</span> opcode[<span class="number">5</span>] = &#123; <span class="number">0xE9</span> &#125;;</span><br><span class="line">	<span class="comment">// 2.1 计算偏移并赋值</span></span><br><span class="line">	*(DWORD*)(opcode + <span class="number">1</span>) = (DWORD)MyOpenProcess - (DWORD)OpenProcess - <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3.修改保护属性</span></span><br><span class="line">	DWORD dwOldProtect = <span class="number">0</span>;</span><br><span class="line">	VirtualProtect(g_pOldAddr, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.写入跳转指令</span></span><br><span class="line">	<span class="built_in">memcpy</span>(g_pOldAddr, opcode, <span class="number">5</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 5.还原保护属性</span></span><br><span class="line">	VirtualProtect(g_pOldAddr, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnHook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 1.修改保护属性</span></span><br><span class="line">	DWORD dwOldProtect = <span class="number">0</span>;</span><br><span class="line">	VirtualProtect(g_pOldAddr, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line">	<span class="comment">// 2.还原旧的指令数据</span></span><br><span class="line">	<span class="built_in">memcpy</span>(g_pOldAddr, g_oldCode, <span class="number">5</span>);</span><br><span class="line">	<span class="comment">// 3.还原保护属性</span></span><br><span class="line">	VirtualProtect(g_pOldAddr, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">GetPid</span><span class="params">(<span class="keyword">const</span> <span class="keyword">wchar_t</span>* szExeName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 创建进程快照</span></span><br><span class="line">	HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="comment">// 判断快照句柄是否有效</span></span><br><span class="line">	<span class="keyword">if</span> (hSnapshot != INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//定义进程结构体，第一个元素必须赋值为结构体大小</span></span><br><span class="line">		PROCESSENTRY32 stcPe32 = &#123; <span class="keyword">sizeof</span>(PROCESSENTRY32) &#125;;</span><br><span class="line">		<span class="comment">//查找第一个进程</span></span><br><span class="line">		Process32First(hSnapshot, &amp;stcPe32);</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;	<span class="comment">// 如果进程名一致，返回进程id</span></span><br><span class="line">			<span class="keyword">if</span> (!wcscmp(stcPe32.szExeFile, szExeName))</span><br><span class="line">				<span class="keyword">return</span> stcPe32.th32ProcessID;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//查找下一个进程</span></span><br><span class="line">		&#125; <span class="keyword">while</span> (Process32Next(hSnapshot, &amp;stcPe32));</span><br><span class="line">		<span class="comment">//关闭快照句柄</span></span><br><span class="line">		CloseHandle(hSnapshot);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="遍历窗口"><a href="#遍历窗口" class="headerlink" title="遍历窗口"></a>遍历窗口</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//枚举窗口</span></span><br><span class="line"><span class="function">BOOL CALLBACK <span class="title">EnumWindowsProc</span><span class="params">(HWND hWnd, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	CMyLoadPeDlg* t = (CMyLoadPeDlg*)lParam;</span><br><span class="line">	TCHAR buff[<span class="number">200</span>];</span><br><span class="line">	TCHAR ClassName[<span class="number">200</span>];</span><br><span class="line">	GetWindowText(hWnd, buff, <span class="number">200</span>);</span><br><span class="line">	GetClassName(hWnd, ClassName,<span class="number">200</span> );</span><br><span class="line">	<span class="comment">//HICON hIcon = (HICON)GetClassLongPtr(hWnd, GCLP_HICON);</span></span><br><span class="line">	<span class="keyword">static</span> HICON hIcon = LoadIcon(AfxGetApp()-&gt;m_hInstance, MAKEINTRESOURCE(IDR_MAINFRAME));<span class="comment">//加载本地自己的图标</span></span><br><span class="line">	CString cs;</span><br><span class="line">	<span class="keyword">if</span> (hIcon != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		t-&gt;m_vecIcon.push_back(hIcon);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IsWindowVisible(hWnd) == TRUE &amp;&amp; wcslen(buff) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		cs.Format(<span class="string">L&quot;%s&quot;</span>, buff);</span><br><span class="line">		t-&gt;m_objEMWNDLope.InsertItem(i, cs , i);	</span><br><span class="line">		t-&gt;m_objEMWNDLope.SetItemText(i, <span class="number">1</span>, ClassName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//cs=ClassName;</span></span><br><span class="line">	</span><br><span class="line">	i++;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="获取进程PID"><a href="#获取进程PID" class="headerlink" title="获取进程PID"></a>获取进程PID</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">GetPid</span><span class="params">(<span class="keyword">const</span> <span class="keyword">wchar_t</span>* szExeName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 创建进程快照</span></span><br><span class="line">	HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	<span class="comment">// 判断快照句柄是否有效</span></span><br><span class="line">	<span class="keyword">if</span> (hSnapshot != INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//定义进程结构体，第一个元素必须赋值为结构体大小</span></span><br><span class="line">		PROCESSENTRY32 stcPe32 = &#123; <span class="keyword">sizeof</span>(PROCESSENTRY32) &#125;;</span><br><span class="line">		<span class="comment">//查找第一个进程</span></span><br><span class="line">		Process32First(hSnapshot, &amp;stcPe32);</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;	<span class="comment">// 如果进程名一致，返回进程id</span></span><br><span class="line">			<span class="keyword">if</span> (!wcscmp(stcPe32.szExeFile, szExeName))</span><br><span class="line">				<span class="keyword">return</span> stcPe32.th32ProcessID;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//查找下一个进程</span></span><br><span class="line">		&#125; <span class="keyword">while</span> (Process32Next(hSnapshot, &amp;stcPe32));</span><br><span class="line">		<span class="comment">//关闭快照句柄</span></span><br><span class="line">		CloseHandle(hSnapshot);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="将wchar-t类型转换为整形"><a href="#将wchar-t类型转换为整形" class="headerlink" title="将wchar_t类型转换为整形"></a>将wchar_t类型转换为整形</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CString strPid = m_objProcessList.GetItemText(item, <span class="number">1</span>);  <span class="comment">//获取文本框</span></span><br><span class="line">DWORD dwPID = _wtoi(strPid);<span class="comment">//转换为整型</span></span><br></pre></td></tr></table></figure>

<h2 id="WCHAR-转char"><a href="#WCHAR-转char" class="headerlink" title="WCHAR* 转char*"></a>WCHAR* 转char*</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wchar* 转到 <span class="keyword">char</span>*</span><br><span class="line">　　</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;comdef.h&gt; // you will need this</span></span></span><br><span class="line"><span class="keyword">const</span> WCHAR* wc = <span class="string">L&quot;Hello World&quot;</span> ;</span><br><span class="line"><span class="function"><span class="keyword">_bstr_t</span> <span class="title">b</span><span class="params">(wc)</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* c = b;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Output: %s\n&quot;</span>, c);</span><br></pre></td></tr></table></figure>



<h1 id="安装程序的遍历及卸载"><a href="#安装程序的遍历及卸载" class="headerlink" title="安装程序的遍历及卸载"></a>安装程序的遍历及卸载</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//,需要开线程不然很卡</span></span><br><span class="line">	HANDLE hThread = CreateThread(<span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPTHREAD_START_ROUTINE)ThreadPro, <span class="keyword">this</span>-&gt;m_objInstallList, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//已安装程序的获取（回调函数）</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadPro</span><span class="params">(CListCtrl Soft)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//CImageList m_objIma;</span></span><br><span class="line">	<span class="comment">//m_objIma.Create(16, 16, ILC_COLOR32, 4, 1);     //创建图像序列CImageList对象 </span></span><br><span class="line">	<span class="comment">//Soft.SetImageList(&amp;m_objIma, LVSIL_SMALL);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">SoftInfo</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		<span class="comment">// 软件名</span></span><br><span class="line">		WCHAR m_strSoftName[<span class="number">50</span>];</span><br><span class="line">		<span class="comment">// 软件版本号</span></span><br><span class="line">		WCHAR m_strSoftVersion[<span class="number">50</span>];</span><br><span class="line">		<span class="comment">// 软件安装目录</span></span><br><span class="line">		WCHAR m_strInstallLocation[MAX_PATH];</span><br><span class="line">		<span class="comment">// 软件发布厂商</span></span><br><span class="line">		WCHAR m_strPublisher[<span class="number">50</span>];</span><br><span class="line">		<span class="comment">// 主程序所在完整路径</span></span><br><span class="line">		WCHAR m_strMainProPath[MAX_PATH];</span><br><span class="line">		<span class="comment">// 卸载exe所在完整路径</span></span><br><span class="line">		WCHAR m_strUninstallPth[MAX_PATH];</span><br><span class="line">	&#125;SoftInfo;</span><br><span class="line">	<span class="comment">// 主键</span></span><br><span class="line">	HKEY RootKey;</span><br><span class="line">	<span class="comment">// 子键名称</span></span><br><span class="line">	LPCTSTR lpSubKey;</span><br><span class="line">	<span class="comment">// 将要打开键的句柄 </span></span><br><span class="line">	HKEY hkResult;</span><br><span class="line">	<span class="comment">// 记录读取注册表是否成功</span></span><br><span class="line">	LONG lReturn;</span><br><span class="line">	CString strBuffer;</span><br><span class="line">	CString strMidReg;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	DWORD index = <span class="number">0</span>;</span><br><span class="line">	TCHAR szKeyName[<span class="number">255</span>] = &#123; <span class="number">0</span> &#125;;        <span class="comment">// 注册表项名称</span></span><br><span class="line">	TCHAR szBuffer[<span class="number">255</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	DWORD dwKeyLen = <span class="number">255</span>;</span><br><span class="line">	DWORD dwNameLen = <span class="number">255</span>;</span><br><span class="line">	DWORD dwType = REG_BINARY | REG_DWORD | REG_EXPAND_SZ | REG_MULTI_SZ | REG_NONE | REG_SZ;</span><br><span class="line">	CString* name = <span class="keyword">new</span> CString;</span><br><span class="line">	RootKey = HKEY_LOCAL_MACHINE;</span><br><span class="line">	lpSubKey = _T(<span class="string">&quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> isOK = <span class="literal">false</span>;</span><br><span class="line">	lReturn = RegOpenKeyEx(RootKey, lpSubKey, <span class="number">0</span>, KEY_ALL_ACCESS, &amp;hkResult);</span><br><span class="line">	DWORD dwIndex = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		DWORD dwKeyLen = <span class="number">255</span>;</span><br><span class="line">		WCHAR szNewKeyName[MAX_PATH] = &#123;&#125;;</span><br><span class="line">		LONG lReturn = RegEnumKeyEx(hkResult, dwIndex, szNewKeyName, &amp;dwKeyLen, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		OutputDebugString(szNewKeyName);</span><br><span class="line">		WCHAR strMidReg[MAX_PATH] = &#123;&#125;;</span><br><span class="line">		swprintf_s(strMidReg, <span class="string">L&quot;%s%s%s&quot;</span>, lpSubKey, <span class="string">L&quot;\\&quot;</span>, szNewKeyName);</span><br><span class="line">		HKEY hkValueKey = <span class="number">0</span>;</span><br><span class="line">		RegOpenKeyEx(RootKey, strMidReg, <span class="number">0</span>, KEY_QUERY_VALUE, &amp;hkValueKey);</span><br><span class="line"></span><br><span class="line">		DWORD dwNameLen = <span class="number">255</span>;</span><br><span class="line">		RegQueryValueEx(hkValueKey, <span class="string">L&quot;DisplayName&quot;</span>, <span class="number">0</span>, &amp;dwType, (LPBYTE)SoftInfo.m_strSoftName, &amp;dwNameLen);</span><br><span class="line">		dwNameLen = <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (SoftInfo.m_strSoftName == name[<span class="number">0</span>])<span class="comment">//去除重复</span></span><br><span class="line">		&#123;</span><br><span class="line">			dwIndex++;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		name[<span class="number">0</span>] = SoftInfo.m_strSoftName;</span><br><span class="line"></span><br><span class="line">		Soft.InsertItem(i, <span class="string">L&quot;&quot;</span>);</span><br><span class="line">		<span class="comment">//名字</span></span><br><span class="line">		Soft.InsertItem(i, SoftInfo.m_strSoftName);</span><br><span class="line">		<span class="comment">// 厂商</span></span><br><span class="line">		RegQueryValueEx(hkValueKey, <span class="string">L&quot;Publisher&quot;</span>, <span class="number">0</span>, &amp;dwType, (LPBYTE)SoftInfo.m_strPublisher, &amp;dwNameLen);</span><br><span class="line">		dwNameLen = <span class="number">255</span>;</span><br><span class="line">		Soft.SetItemText(i, <span class="number">1</span>, SoftInfo.m_strPublisher);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//安装路径</span></span><br><span class="line">		RegQueryValueEx(hkValueKey, <span class="string">L&quot;InstallLocation&quot;</span>, <span class="number">0</span>, &amp;dwType, (LPBYTE)SoftInfo.m_strInstallLocation, &amp;dwNameLen);</span><br><span class="line">		dwNameLen = <span class="number">255</span>;</span><br><span class="line">		Soft.SetItemText(i, <span class="number">2</span>, SoftInfo.m_strInstallLocation);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//卸载路径</span></span><br><span class="line">		RegQueryValueEx(hkValueKey, <span class="string">L&quot;UninstallString&quot;</span>, <span class="number">0</span>, &amp;dwType, (LPBYTE)SoftInfo.m_strUninstallPth, &amp;dwNameLen);</span><br><span class="line">		dwNameLen = <span class="number">255</span>;</span><br><span class="line">		Soft.SetItemText(i, <span class="number">3</span>, SoftInfo.m_strUninstallPth);<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">		i++;</span><br><span class="line">		dwIndex++;</span><br><span class="line">		<span class="keyword">if</span> (lReturn == ERROR_NO_MORE_ITEMS)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//消息映射</span></span><br><span class="line">ON_NOTIFY(NM_DBLCLK, IDC_INSTALL, &amp;CMyInstallDlg::OnDblclkInstall)</span><br><span class="line"><span class="comment">//类中声明</span></span><br><span class="line"><span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnDblclkInstall</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span>;</span><br><span class="line"><span class="comment">//双击响应卸载</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyInstallDlg::OnDblclkInstall</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LPNMITEMACTIVATE pNMItemActivate = <span class="keyword">reinterpret_cast</span>&lt;LPNMITEMACTIVATE&gt;(pNMHDR);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> Value = MessageBox(<span class="string">L&quot;请再次确定卸载该程序&quot;</span>, <span class="string">L&quot;警告！&quot;</span>, MB_OK | MB_OKCANCEL);</span><br><span class="line">	<span class="keyword">if</span> (Value == IDCANCEL)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	CString Path = m_objInstallList.GetItemText(pNMItemActivate-&gt;iItem, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	ShellExecute(<span class="literal">NULL</span>, <span class="literal">NULL</span>, _T(<span class="string">&quot;explorer&quot;</span>), Path, <span class="literal">NULL</span>, SW_SHOW);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	*pResult = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务的遍历与开关</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//状态赋值</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyServicesDlg::ServiceStaus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	mapServiceStaus[<span class="number">1</span>] = <span class="string">&quot;服务已停止&quot;</span>;</span><br><span class="line">	mapServiceStaus[<span class="number">2</span>] = <span class="string">&quot;服务正在启动&quot;</span>;</span><br><span class="line">	mapServiceStaus[<span class="number">3</span>] = <span class="string">&quot;服务正在停止&quot;</span>;</span><br><span class="line">	mapServiceStaus[<span class="number">4</span>] = <span class="string">&quot;服务正在运行&quot;</span>;</span><br><span class="line">	mapServiceStaus[<span class="number">5</span>] = <span class="string">&quot;该服务将继续&quot;</span>;</span><br><span class="line">	mapServiceStaus[<span class="number">6</span>] = <span class="string">&quot;服务正在暂停&quot;</span>;</span><br><span class="line">	mapServiceStaus[<span class="number">7</span>] = <span class="string">&quot;服务已暂停&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历服务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyServicesDlg::EnumServices</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ServiceStaus();</span><br><span class="line">	<span class="comment">//打开远程计算机服务控制管理器</span></span><br><span class="line">	SC_HANDLE hscm = OpenSCManagerW(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_ALL_ACCESS);</span><br><span class="line">	<span class="comment">//第一次调用,获取内容大小</span></span><br><span class="line">	DWORD dwServiceNum = <span class="number">0</span>;</span><br><span class="line">	DWORD dwSize = <span class="number">0</span>;</span><br><span class="line">	EnumServicesStatusEx(</span><br><span class="line">		hscm,</span><br><span class="line">		SC_ENUM_PROCESS_INFO,</span><br><span class="line">		SERVICE_WIN32,</span><br><span class="line">		SERVICE_STATE_ALL,<span class="comment">//所有服务状态</span></span><br><span class="line">		<span class="literal">NULL</span>,        <span class="comment">//缓冲区大小</span></span><br><span class="line">		<span class="number">0</span>,          <span class="comment">//缓冲区大小</span></span><br><span class="line">		&amp;dwSize,      <span class="comment">//需要大小</span></span><br><span class="line">		&amp;dwServiceNum,    <span class="comment">//缓冲区服务个数</span></span><br><span class="line">		<span class="literal">NULL</span>, <span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	<span class="comment">//3.申请需要的内存,第二次调用</span></span><br><span class="line">	LPENUM_SERVICE_STATUS_PROCESS pEnumService = (LPENUM_SERVICE_STATUS_PROCESS)<span class="keyword">new</span> <span class="keyword">char</span>[dwSize];</span><br><span class="line">	<span class="comment">//4.第二次枚举</span></span><br><span class="line">	<span class="keyword">bool</span> bStatus = FALSE;</span><br><span class="line">	bStatus = EnumServicesStatusEx(</span><br><span class="line">		hscm,</span><br><span class="line">		SC_ENUM_PROCESS_INFO,</span><br><span class="line">		SERVICE_WIN32,</span><br><span class="line">		SERVICE_STATE_ALL,<span class="comment">//所有服务状态</span></span><br><span class="line">		(PBYTE)pEnumService,        <span class="comment">//缓冲区大小</span></span><br><span class="line">		dwSize,          <span class="comment">//缓冲区大小</span></span><br><span class="line">		&amp;dwSize,      <span class="comment">//需要大小</span></span><br><span class="line">		&amp;dwServiceNum,    <span class="comment">//缓冲区服务个数</span></span><br><span class="line">		<span class="literal">NULL</span>, <span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	<span class="comment">//遍历信息</span></span><br><span class="line">	CString cs;</span><br><span class="line">	<span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; dwServiceNum; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		cs = pEnumService[i].lpServiceName;</span><br><span class="line">		m_objServices.InsertItem(i, cs);</span><br><span class="line">		cs.Format(<span class="string">L&quot;%d&quot;</span>, pEnumService[i].ServiceStatusProcess.dwProcessId);</span><br><span class="line">		m_objServices.SetItemText(i, <span class="number">1</span>, cs);</span><br><span class="line">		cs = pEnumService[i].lpDisplayName;</span><br><span class="line">		m_objServices.SetItemText(i, <span class="number">2</span>, cs);</span><br><span class="line">		cs = mapServiceStaus[pEnumService[i].ServiceStatusProcess.dwCurrentState];</span><br><span class="line">		m_objServices.SetItemText(i, <span class="number">3</span>, cs);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="系统、CPU、内存网卡信息的获取"><a href="#系统、CPU、内存网卡信息的获取" class="headerlink" title="系统、CPU、内存网卡信息的获取"></a>系统、CPU、内存网卡信息的获取</h1><p>我直接在网上找到的零散代码，给他整合封装成了一个类</p>
<h2 id="h文件"><a href="#h文件" class="headerlink" title=".h文件"></a>.h文件</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iphlpapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;intrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;iphlpapi.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">//去掉警告信息</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable: 4996) </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//保存获取到信息的结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SYSTEMINFO</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="comment">//OS INFO</span></span><br><span class="line">	CString OS_NAME;</span><br><span class="line">	CString OS_VERSION;</span><br><span class="line">	<span class="comment">//CPU INFO</span></span><br><span class="line">	LONG CPU_FREQUENCY;</span><br><span class="line">	CString CPU_MANUFACTURE;</span><br><span class="line">	CString CPU_TYPE;</span><br><span class="line">	<span class="comment">//MEMORY INFO</span></span><br><span class="line">	CString MEMORY_INFO;</span><br><span class="line">	<span class="comment">//DISK</span></span><br><span class="line">	CString HardDisk;</span><br><span class="line">	<span class="comment">//NETWORK</span></span><br><span class="line">	CString NET_CARD;</span><br><span class="line">	CString NET_CARD_NAME;</span><br><span class="line">	CString NET_CARD_DECS;</span><br><span class="line">	CString NET_IP;</span><br><span class="line">	CString NET_MAC;</span><br><span class="line">	<span class="comment">//PROCESS</span></span><br><span class="line">	CString PID;</span><br><span class="line"></span><br><span class="line">&#125;SYSTEMINFO,*PSYSTEMINFO;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DiySystemInfo</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">GetInfo</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">getOsInfo</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">getCpuInfo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">initCpu</span><span class="params">(DWORD veax)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">long</span> <span class="title">getCpuFreq</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">CString <span class="title">getManufactureID</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">CString <span class="title">getCpuType</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">getCpuInfo</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">getMemoryInfo</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">CString <span class="title">execCmd</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* cmd)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">getHardDiskInfo</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">getNetworkInfo</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">getProcessInfo</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	SYSTEMINFO m_SystemInfo;</span><br><span class="line">	</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="cpp文件"><a href="#cpp文件" class="headerlink" title=".cpp文件"></a>.cpp文件</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DiySystemInfo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//字节转换的宏定义</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kMaxInfoBuffer = <span class="number">256</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  GBYTES  1073741824  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  MBYTES  1048576  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  KBYTES  1024  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DKBYTES 1024.0  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统版本的获取</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiySystemInfo::getOsInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// get os name according to version number</span></span><br><span class="line">	OSVERSIONINFO osver = &#123; <span class="keyword">sizeof</span>(OSVERSIONINFO) &#125;;</span><br><span class="line">	GetVersionEx(&amp;osver);</span><br><span class="line">	CString os_name;</span><br><span class="line">	<span class="keyword">if</span> (osver.dwMajorVersion == <span class="number">5</span> &amp;&amp; osver.dwMinorVersion == <span class="number">0</span>)</span><br><span class="line">		os_name = <span class="string">&quot;Windows 2000&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (osver.dwMajorVersion == <span class="number">5</span> &amp;&amp; osver.dwMinorVersion == <span class="number">1</span>)</span><br><span class="line">		os_name = <span class="string">&quot;Windows XP&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (osver.dwMajorVersion == <span class="number">6</span> &amp;&amp; osver.dwMinorVersion == <span class="number">0</span>)</span><br><span class="line">		os_name = <span class="string">&quot;Windows 2003&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (osver.dwMajorVersion == <span class="number">5</span> &amp;&amp; osver.dwMinorVersion == <span class="number">2</span>)</span><br><span class="line">		os_name = <span class="string">&quot;windows vista&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (osver.dwMajorVersion == <span class="number">6</span> &amp;&amp; osver.dwMinorVersion == <span class="number">1</span>)</span><br><span class="line">		os_name = <span class="string">&quot;windows 7&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (osver.dwMajorVersion == <span class="number">6</span> &amp;&amp; osver.dwMinorVersion == <span class="number">2</span>)</span><br><span class="line">		os_name = <span class="string">&quot;windows 10&quot;</span>;</span><br><span class="line"></span><br><span class="line">	m_SystemInfo.OS_NAME = os_name;</span><br><span class="line">	m_SystemInfo.OS_VERSION.Format(<span class="string">L&quot;%d.%d&quot;</span>, osver.dwMajorVersion, osver.dwMinorVersion);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 当程序是64位时CPU的初始化和获取</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiySystemInfo::getCpuInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> cpuInfo[<span class="number">4</span>] = &#123; <span class="number">-1</span> &#125;;</span><br><span class="line">	<span class="keyword">char</span> cpu_manufacture[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">char</span> cpu_type[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">char</span> cpu_freq[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	__cpuid(cpuInfo, <span class="number">0x80000002</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(cpu_manufacture, cpuInfo, <span class="keyword">sizeof</span>(cpuInfo));</span><br><span class="line"></span><br><span class="line">	__cpuid(cpuInfo, <span class="number">0x80000003</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(cpu_type, cpuInfo, <span class="keyword">sizeof</span>(cpuInfo));</span><br><span class="line"></span><br><span class="line">	__cpuid(cpuInfo, <span class="number">0x80000004</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(cpu_freq, cpuInfo, <span class="keyword">sizeof</span>(cpuInfo));</span><br><span class="line"></span><br><span class="line">	m_SystemInfo.CPU_FREQUENCY = cpu_freq;</span><br><span class="line">	m_SystemInfo.CPU_MANUFACTURE = cpu_manufacture;</span><br><span class="line">	m_SystemInfo.CPU_TYPE = cpu_type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">DWORD deax;</span><br><span class="line">DWORD debx;</span><br><span class="line">DWORD decx;</span><br><span class="line">DWORD dedx;</span><br><span class="line"><span class="comment">// 使用汇编初始化CPU</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiySystemInfo::initCpu</span><span class="params">(DWORD veax)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov eax, veax</span><br><span class="line">		cpuid</span><br><span class="line">			mov deax, eax</span><br><span class="line">			mov debx, ebx</span><br><span class="line">			mov decx, ecx</span><br><span class="line">			mov dedx, edx</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//频率</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">DiySystemInfo::getCpuFreq</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> start, over;</span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		RDTSC</span><br><span class="line">		mov start, eax</span><br><span class="line">	&#125;</span><br><span class="line">	Sleep(<span class="number">50</span>);</span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		RDTSC</span><br><span class="line">		mov over, eax</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (over - start) / <span class="number">50000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//制造商</span></span><br><span class="line"><span class="function">CString <span class="title">DiySystemInfo::getManufactureID</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> manuID[<span class="number">25</span>];</span><br><span class="line">	<span class="built_in">memset</span>(manuID, <span class="number">0</span>, <span class="keyword">sizeof</span>(manuID));</span><br><span class="line"></span><br><span class="line">	initCpu(<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(manuID + <span class="number">0</span>, &amp;debx, <span class="number">4</span>); </span><br><span class="line">	<span class="built_in">memcpy</span>(manuID + <span class="number">4</span>, &amp;dedx, <span class="number">4</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(manuID + <span class="number">8</span>, &amp;decx, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	CString cs;</span><br><span class="line">	cs.Format(<span class="string">L&quot;%S&quot;</span>, manuID);</span><br><span class="line">	<span class="keyword">return</span> cs;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//CPU的类型</span></span><br><span class="line"><span class="function">CString <span class="title">DiySystemInfo::getCpuType</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> DWORD id = <span class="number">0x80000002</span>; <span class="comment">// start 0x80000002 end to 0x80000004</span></span><br><span class="line">	<span class="keyword">char</span> cpuType[<span class="number">49</span>];</span><br><span class="line">	<span class="built_in">memset</span>(cpuType, <span class="number">0</span>, <span class="keyword">sizeof</span>(cpuType));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (DWORD t = <span class="number">0</span>; t &lt; <span class="number">3</span>; t++)</span><br><span class="line">	&#123;</span><br><span class="line">		initCpu(id + t);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">memcpy</span>(cpuType + <span class="number">16</span> * t + <span class="number">0</span>, &amp;deax, <span class="number">4</span>);</span><br><span class="line">		<span class="built_in">memcpy</span>(cpuType + <span class="number">16</span> * t + <span class="number">4</span>, &amp;debx, <span class="number">4</span>);</span><br><span class="line">		<span class="built_in">memcpy</span>(cpuType + <span class="number">16</span> * t + <span class="number">8</span>, &amp;decx, <span class="number">4</span>);</span><br><span class="line">		<span class="built_in">memcpy</span>(cpuType + <span class="number">16</span> * t + <span class="number">12</span>, &amp;dedx, <span class="number">4</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	CString cs;</span><br><span class="line">	cs.Format(<span class="string">L&quot;%S&quot;</span>, cpuType);</span><br><span class="line">	<span class="keyword">return</span> cs;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//CPU的调用</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiySystemInfo::getCpuInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_SystemInfo.CPU_FREQUENCY = getCpuFreq();</span><br><span class="line">	m_SystemInfo.CPU_MANUFACTURE = getManufactureID();</span><br><span class="line">	m_SystemInfo.CPU_TYPE = getCpuType();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取存信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiySystemInfo::getMemoryInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> memory_info;</span><br><span class="line">	MEMORYSTATUSEX statusex;</span><br><span class="line">	statusex.dwLength = <span class="keyword">sizeof</span>(statusex);</span><br><span class="line">	<span class="keyword">if</span> (GlobalMemoryStatusEx(&amp;statusex))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> total = <span class="number">0</span>, remain_total = <span class="number">0</span>, avl = <span class="number">0</span>, remain_avl = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">double</span> decimal_total = <span class="number">0</span>, decimal_avl = <span class="number">0</span>;</span><br><span class="line">		remain_total = statusex.ullTotalPhys % GBYTES;</span><br><span class="line">		total = statusex.ullTotalPhys / GBYTES;</span><br><span class="line">		avl = statusex.ullAvailPhys / GBYTES;</span><br><span class="line">		remain_avl = statusex.ullAvailPhys % GBYTES;</span><br><span class="line">		<span class="keyword">if</span> (remain_total &gt; <span class="number">0</span>)</span><br><span class="line">			decimal_total = (remain_total / MBYTES) / DKBYTES;</span><br><span class="line">		<span class="keyword">if</span> (remain_avl &gt; <span class="number">0</span>)</span><br><span class="line">			decimal_avl = (remain_avl / MBYTES) / DKBYTES;</span><br><span class="line"></span><br><span class="line">		decimal_total += (<span class="keyword">double</span>)total;</span><br><span class="line">		decimal_avl += (<span class="keyword">double</span>)avl;</span><br><span class="line">		<span class="keyword">char</span>  buffer[kMaxInfoBuffer];</span><br><span class="line">		sprintf_s(buffer, kMaxInfoBuffer, <span class="string">&quot;total %.2f GB (%.2f GB available)&quot;</span>, decimal_total, decimal_avl);</span><br><span class="line">		memory_info.append(buffer);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	m_SystemInfo.MEMORY_INFO.Format(<span class="string">L&quot;%S&quot;</span>,memory_info.c_str());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">CString <span class="title">DiySystemInfo::execCmd</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buffer[<span class="number">128</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	CString result;</span><br><span class="line">	FILE* pipe = _popen(cmd, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!pipe) <span class="keyword">throw</span> <span class="built_in">std</span>::runtime_error(<span class="string">&quot;_popen() failed!&quot;</span>);</span><br><span class="line">	<span class="keyword">while</span> (!feof(pipe))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (fgets(buffer, <span class="number">128</span>, pipe) != <span class="literal">NULL</span>)</span><br><span class="line">			result += buffer;</span><br><span class="line">	&#125;</span><br><span class="line">	_pclose(pipe);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取序列号</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiySystemInfo::getHardDiskInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CString hd_seiral = execCmd(<span class="string">&quot;wmic path win32_physicalmedia get SerialNumber&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	m_SystemInfo.HardDisk = hd_seiral;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取网卡信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiySystemInfo::getNetworkInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIP_ADAPTER_INFO pIpAdapterInfo = <span class="keyword">new</span> IP_ADAPTER_INFO();</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> adapter_size = <span class="keyword">sizeof</span>(IP_ADAPTER_INFO);</span><br><span class="line">	<span class="keyword">int</span> ret = GetAdaptersInfo(pIpAdapterInfo, &amp;adapter_size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret == ERROR_BUFFER_OVERFLOW)</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">delete</span> pIpAdapterInfo;</span><br><span class="line">		pIpAdapterInfo = (PIP_ADAPTER_INFO)<span class="keyword">new</span> BYTE[adapter_size];</span><br><span class="line">		ret = GetAdaptersInfo(pIpAdapterInfo, &amp;adapter_size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret == ERROR_SUCCESS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> card_index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> (pIpAdapterInfo)</span><br><span class="line">		&#123;</span><br><span class="line">			pIpAdapterInfo-&gt;Description &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">			m_SystemInfo.NET_CARD.Format(<span class="string">L&quot;%d&quot;</span>, ++card_index);</span><br><span class="line">			m_SystemInfo.NET_CARD_NAME = pIpAdapterInfo-&gt;AdapterName;</span><br><span class="line">			m_SystemInfo.NET_CARD_DECS = pIpAdapterInfo-&gt;Description;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">			PIP_ADDR_STRING pIpAddr = &amp;(pIpAdapterInfo-&gt;IpAddressList);</span><br><span class="line">			<span class="keyword">while</span> (pIpAddr)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span> local_ip[<span class="number">128</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">				<span class="built_in">strcpy</span>(local_ip, pIpAddr-&gt;IpAddress.String);</span><br><span class="line">				</span><br><span class="line">				m_SystemInfo.NET_IP.Format(<span class="string">L&quot;%S&quot;</span>,local_ip);</span><br><span class="line">				pIpAddr = pIpAddr-&gt;Next;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">char</span> local_mac[<span class="number">128</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			<span class="keyword">int</span> char_index = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pIpAdapterInfo-&gt;AddressLength; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span> temp_str[<span class="number">10</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">				<span class="built_in">sprintf</span>(temp_str, <span class="string">&quot;%02X-&quot;</span>, pIpAdapterInfo-&gt;Address[i]); </span><br><span class="line">				<span class="built_in">strcpy</span>(local_mac + char_index, temp_str);</span><br><span class="line">				char_index += <span class="number">3</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			local_mac[<span class="number">17</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">			m_SystemInfo.NET_MAC.Format(<span class="string">L&quot;%S&quot;</span>,local_mac);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pIpAdapterInfo)</span><br><span class="line">		<span class="keyword">delete</span> pIpAdapterInfo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 进程ID的获取 //</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiySystemInfo::getProcessInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> pid = GetCurrentProcessId();</span><br><span class="line"></span><br><span class="line">	m_SystemInfo.PID.Format(<span class="string">L&quot;Current Pid:%d&quot;</span>,pid);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//对外调用的接口</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiySystemInfo::GetInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//系统信息</span></span><br><span class="line">	getOsInfo();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//CPU信息</span></span><br><span class="line">	getCpuInfo();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//内存信息</span></span><br><span class="line">	getMemoryInfo();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//序列号</span></span><br><span class="line">	getHardDiskInfo();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//网卡信息</span></span><br><span class="line">	getNetworkInfo();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//进程ID</span></span><br><span class="line">	getProcessInfo();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调用与输出"><a href="#调用与输出" class="headerlink" title="调用与输出"></a>调用与输出</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取系统信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyComputerDlg::GetSystemInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CString cs;</span><br><span class="line">	DiySystemInfo system;</span><br><span class="line">	system.GetInfo();</span><br><span class="line">	m_strOsName.SetString(system.m_SystemInfo.OS_NAME);</span><br><span class="line">	m_strOsVersion.SetString(system.m_SystemInfo.OS_VERSION);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%dHZ&quot;</span>, system.m_SystemInfo.CPU_FREQUENCY);</span><br><span class="line">	m_strCpuFre.SetString(cs);</span><br><span class="line">	m_strCpuManuFac.SetString(system.m_SystemInfo.CPU_MANUFACTURE);</span><br><span class="line">	m_strCpuType.SetString(system.m_SystemInfo.CPU_TYPE);</span><br><span class="line">	m_strMemory.SetString(system.m_SystemInfo.MEMORY_INFO);</span><br><span class="line">	m_strDisk.SetString(system.m_SystemInfo.HardDisk);</span><br><span class="line">	m_strNetCard.SetString(system.m_SystemInfo.NET_CARD);</span><br><span class="line">	m_strNetCardName.SetString(system.m_SystemInfo.NET_CARD_NAME);</span><br><span class="line">	m_strNetCardDecs.SetString(system.m_SystemInfo.NET_CARD_DECS);</span><br><span class="line">	m_strNetIp.SetString(system.m_SystemInfo.NET_IP);</span><br><span class="line">	m_strNetMac.SetString(system.m_SystemInfo.NET_MAC);</span><br><span class="line"></span><br><span class="line">	UpdateData(FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="文件的遍历与树控件"><a href="#文件的遍历与树控件" class="headerlink" title="文件的遍历与树控件"></a>文件的遍历与树控件</h1><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算机界面的初始化</span></span><br><span class="line"><span class="function">BOOL <span class="title">CMyComputerDlg::OnInitDialog</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CDialogEx::OnInitDialog();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化Tree控件风格</span></span><br><span class="line">	DWORD dwStyle = GetWindowLong(m_objComTree.m_hWnd, GWL_STYLE);</span><br><span class="line">	dwStyle |= TVS_HASBUTTONS | TVS_HASLINES | TVS_LINESATROOT;</span><br><span class="line">	SetWindowLong(m_objComTree.m_hWnd, GWL_STYLE, dwStyle);</span><br><span class="line"></span><br><span class="line">	m_objComList.SetExtendedStyle(LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES );<span class="comment">//更改风格</span></span><br><span class="line">	<span class="comment">// 添加列</span></span><br><span class="line">	m_objComList.InsertColumn(<span class="number">0</span>, <span class="string">L&quot;文件名&quot;</span>, <span class="number">0</span>, <span class="number">150</span>);</span><br><span class="line">	m_objComList.InsertColumn(<span class="number">1</span>, <span class="string">L&quot;类型&quot;</span>, <span class="number">0</span>, <span class="number">80</span>);</span><br><span class="line">	m_objComList.InsertColumn(<span class="number">2</span>, <span class="string">L&quot;大小&quot;</span>, <span class="number">0</span>, <span class="number">50</span>);</span><br><span class="line">	m_objComList.InsertColumn(<span class="number">3</span>, <span class="string">L&quot;修改日期&quot;</span>, <span class="number">0</span>, <span class="number">200</span>);</span><br><span class="line">	m_objComList.InsertColumn(<span class="number">4</span>, <span class="string">L&quot;属性&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objComList.InsertColumn(<span class="number">5</span>, <span class="string">L&quot;路径&quot;</span>, <span class="number">0</span>, <span class="number">200</span>);</span><br><span class="line">	<span class="comment">//列表图片</span></span><br><span class="line">	m_ImageList.Create(<span class="number">16</span>, <span class="number">16</span>, ILC_COLOR32, <span class="number">4</span>, <span class="number">1</span>);     <span class="comment">//创建图像序列CImageList对象 </span></span><br><span class="line">	m_objComList.SetImageList(&amp;m_ImageList, LVSIL_SMALL);  <span class="comment">//为树形控件设置图像序列</span></span><br><span class="line">	<span class="comment">//树控件图片</span></span><br><span class="line">	m_DirImage.Create(<span class="number">16</span>, <span class="number">16</span>, ILC_COLOR32, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">	CBitmap ComPuter;</span><br><span class="line">	ComPuter.LoadBitmap(IDB_BITMAP3);</span><br><span class="line">	<span class="comment">//m_ComputerImage</span></span><br><span class="line">	m_DirImage.Add(&amp;ComPuter, RGB(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">	</span><br><span class="line">	m_Root = m_objComTree.InsertItem(<span class="string">L&quot;此电脑&quot;</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="comment">//遍历磁盘</span></span><br><span class="line">	GetDistHeadInfo();</span><br><span class="line">	<span class="comment">//插入磁盘分区</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Disk.size(); i++)</span><br><span class="line">	&#123;		</span><br><span class="line">		SHFILEINFO info = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">		CString temp = Disk[i]-&gt;csDiskHead;</span><br><span class="line">		SHGetFileInfo(temp, <span class="number">0</span>, &amp;info, <span class="keyword">sizeof</span>(&amp;info), SHGFI_DISPLAYNAME | SHGFI_ICON);</span><br><span class="line">		<span class="keyword">int</span> b = m_DirImage.Add(info.hIcon);</span><br><span class="line">		<span class="comment">//Disk[i]-&gt;csDiskHead += Disk[i]-&gt;attribute;</span></span><br><span class="line">		temp += Disk[i]-&gt;attribute;</span><br><span class="line">		HTREEITEM hDiskHead = m_objComTree.InsertItem(Disk[i]-&gt;csDiskHead, b, b, m_Root);</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	m_objComTree.SetImageList(&amp;m_DirImage, LVSIL_NORMAL);</span><br><span class="line">	<span class="keyword">return</span> TRUE;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="获取分区盘符"><a href="#获取分区盘符" class="headerlink" title="获取分区盘符"></a>获取分区盘符</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//遍历盘符</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyComputerDlg::GetDistHeadInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//1. 获取驱动器名称</span></span><br><span class="line">	TCHAR buf[<span class="number">100</span>] = &#123;&#125;;</span><br><span class="line">	TCHAR* pTemp = buf;</span><br><span class="line"></span><br><span class="line">	DWORD 总容量;</span><br><span class="line">	DWORD 空闲容量;</span><br><span class="line">	GetLogicalDriveStrings(<span class="number">100</span>, buf);</span><br><span class="line">	<span class="comment">// 把语言设置为中文</span></span><br><span class="line">	setlocale(LC_ALL, <span class="string">&quot;chs&quot;</span>);</span><br><span class="line">	<span class="keyword">int</span> Flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (pTemp[<span class="number">0</span>] != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		MyDiskHeadInfo* pds = <span class="keyword">new</span> MyDiskHeadInfo;</span><br><span class="line">		<span class="comment">//2. 获取驱动器类型</span></span><br><span class="line">		DWORD dwType = GetDriveType(pTemp);</span><br><span class="line">		<span class="keyword">switch</span> (dwType)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="keyword">case</span> DRIVE_REMOVABLE:</span><br><span class="line">			<span class="comment">//..ListView_SetItemText(hListCtrl, Flag, 1, (TCHAR*)_T(&quot;可移动设备&quot;));</span></span><br><span class="line">			pds-&gt;attribute = <span class="string">L&quot;可移动设备&quot;</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> DRIVE_FIXED:</span><br><span class="line">			<span class="comment">//ListView_SetItemText(hListCtrl, Flag, 1, (TCHAR*)_T(&quot;硬盘&quot;));</span></span><br><span class="line">			pds-&gt;attribute = <span class="string">L&quot;硬盘&quot;</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> DRIVE_REMOTE:</span><br><span class="line">			<span class="comment">//ListView_SetItemText(hListCtrl, Flag, 1, (TCHAR*)_T(&quot;远程设备&quot;));</span></span><br><span class="line">			pds-&gt;attribute = <span class="string">L&quot;远程设备&quot;</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> DRIVE_CDROM:</span><br><span class="line">			<span class="comment">//	ListView_SetItemText(hListCtrl, Flag, 1, (TCHAR*)_T(&quot;光驱&quot;));</span></span><br><span class="line">			pds-&gt;attribute = <span class="string">L&quot;光驱&quot;</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//3. 驱动器的空间信息</span></span><br><span class="line">		DWORD 每簇的扇区数量 = <span class="number">0</span>;</span><br><span class="line">		DWORD 每个扇区的容量 = <span class="number">0</span>;</span><br><span class="line">		DWORD 空闲簇的总量 = <span class="number">0</span>;</span><br><span class="line">		DWORD 全部簇的总量 = <span class="number">0</span>;</span><br><span class="line">		GetDiskFreeSpace(pTemp,</span><br><span class="line">			&amp;每簇的扇区数量,</span><br><span class="line">			&amp;每个扇区的容量,</span><br><span class="line">			&amp;空闲簇的总量,</span><br><span class="line">			&amp;全部簇的总量</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		pds-&gt;uAllSize = (((全部簇的总量 / <span class="number">1024.0</span>) * 每簇的扇区数量 * 每个扇区的容量) / <span class="number">1024</span>) / <span class="number">1024</span>;</span><br><span class="line">		pds-&gt;uAbouleSize = (((空闲簇的总量 / <span class="number">1024.0</span>) * 每簇的扇区数量 * 每个扇区的容量) / <span class="number">1024</span>) / <span class="number">1024</span>;</span><br><span class="line">		pds-&gt;uUsed = pds-&gt;uAllSize - pds-&gt;uAbouleSize;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		pds-&gt;csDiskHead = pTemp;</span><br><span class="line">		Disk.push_back(pds);</span><br><span class="line">		pTemp += wcslen(buf) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		Flag++;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="添加目录"><a href="#添加目录" class="headerlink" title="添加目录"></a>添加目录</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加子目录</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyComputerDlg::AddSubDir</span><span class="params">(HTREEITEM hParent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CString strPath = GetFullPath(hParent);     <span class="comment">//获取全路径</span></span><br><span class="line">	<span class="keyword">if</span> (strPath.Right(<span class="number">1</span>) != <span class="string">&quot;\\&quot;</span>)</span><br><span class="line">		strPath += <span class="string">&quot;\\&quot;</span>;</span><br><span class="line">	strPath += <span class="string">&quot;*.*&quot;</span>;</span><br><span class="line">	CFileFind file;</span><br><span class="line">	BOOL bContinue = file.FindFile(strPath);    <span class="comment">//查找包含字符串的文件</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (bContinue)</span><br><span class="line">	&#123;</span><br><span class="line">		bContinue = file.FindNextFile();        <span class="comment">//查找下一个文件</span></span><br><span class="line">		<span class="keyword">if</span> (file.IsDirectory() &amp;&amp; !file.IsDots())</span><br><span class="line">		&#123;	</span><br><span class="line"></span><br><span class="line">			SHFILEINFO info = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			CString temp = strPath;</span><br><span class="line">			<span class="keyword">int</span> index = temp.Find(<span class="string">L&quot;*.*&quot;</span>);</span><br><span class="line">			temp.Delete(index, <span class="number">3</span>);</span><br><span class="line">			SHGetFileInfo(temp + file.GetFileName(), <span class="number">0</span>, &amp;info, <span class="keyword">sizeof</span>(&amp;info), SHGFI_DISPLAYNAME | SHGFI_ICON);</span><br><span class="line">			<span class="keyword">int</span> i = m_DirImage.Add(info.hIcon);</span><br><span class="line">			<span class="comment">//m_objComList.InsertItem(i, info.szDisplayName, i);</span></span><br><span class="line">			m_objComTree.InsertItem(file.GetFileName(),i,i, hParent);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取全路径"><a href="#获取全路径" class="headerlink" title="获取全路径"></a>获取全路径</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取树项目全根路径</span></span><br><span class="line"><span class="function">CString <span class="title">CMyComputerDlg::GetFullPath</span><span class="params">(HTREEITEM hCurrent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CString strTemp;</span><br><span class="line">	CString strReturn = <span class="string">L&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">while</span> (hCurrent != m_Root)</span><br><span class="line">	&#123;</span><br><span class="line">		strTemp = m_objComTree.GetItemText(hCurrent);    <span class="comment">//检索列表中项目文字</span></span><br><span class="line">		<span class="keyword">if</span> (strTemp.Right(<span class="number">1</span>) != <span class="string">&quot;\\&quot;</span>)</span><br><span class="line">			strTemp += <span class="string">&quot;\\&quot;</span>;</span><br><span class="line">		strReturn = strTemp + strReturn;</span><br><span class="line">		hCurrent = m_objComTree.GetParentItem(hCurrent); <span class="comment">//返回父项目句柄</span></span><br><span class="line">	&#125;</span><br><span class="line">	csPath = strReturn;</span><br><span class="line">	<span class="keyword">return</span> strReturn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在List控件中显示"><a href="#在List控件中显示" class="headerlink" title="在List控件中显示"></a>在List控件中显示</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在右侧列表响应子文件图标</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyComputerDlg::OnSelchangedTree1</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> Const = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	m_objComList.DeleteAllItems();</span><br><span class="line">	NM_TREEVIEW* pNMTreeView = (NM_TREEVIEW*)pNMHDR;</span><br><span class="line">	TVITEM item = pNMTreeView-&gt;itemNew;</span><br><span class="line">	<span class="keyword">if</span> (item.hItem == m_Root)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	CString str = GetFullPath(item.hItem);</span><br><span class="line">	<span class="keyword">if</span> (str.Right(<span class="number">1</span>) != <span class="string">&quot;\\&quot;</span>)</span><br><span class="line">		str += <span class="string">&quot;\\&quot;</span>;</span><br><span class="line">	str += <span class="string">&quot;*.*&quot;</span>;</span><br><span class="line">	CFileFind file;</span><br><span class="line">	BOOL bContinue = file.FindFile(str);</span><br><span class="line">	<span class="keyword">while</span> (bContinue)</span><br><span class="line">	&#123;</span><br><span class="line">		bContinue = file.FindNextFile();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (!file.IsDirectory() &amp;&amp; !file.IsDots())</span><br><span class="line">		&#123;</span><br><span class="line">			SHFILEINFO info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">			CString temp = str;</span><br><span class="line">			<span class="keyword">int</span> index = temp.Find(<span class="string">L&quot;*.*&quot;</span>);</span><br><span class="line">			temp.Delete(index, <span class="number">3</span>);</span><br><span class="line">			SHGetFileInfo(temp + file.GetFileName(), <span class="number">0</span>, &amp;info, <span class="keyword">sizeof</span>(&amp;info), SHGFI_DISPLAYNAME | SHGFI_ICON);</span><br><span class="line">			<span class="keyword">int</span> i = m_ImageList.Add(info.hIcon);</span><br><span class="line">			m_objComList.InsertItem(i, info.szDisplayName, i);</span><br><span class="line">			CString  filePath;</span><br><span class="line">			filePath.Format(temp+ file.GetFileName());</span><br><span class="line">			ShowFileInfo(filePath,Const);</span><br><span class="line">			Const++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*pResult = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取文件的信息并输出"><a href="#获取文件的信息并输出" class="headerlink" title="获取文件的信息并输出"></a>获取文件的信息并输出</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//显示文件信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyComputerDlg::ShowFileInfo</span><span class="params">(CString  filePath,<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	</span><br><span class="line">	FILEINFO* fileInfo = <span class="keyword">new</span> FILEINFO;</span><br><span class="line">	CString buf;<span class="comment">//缓冲区</span></span><br><span class="line">	<span class="comment">// 筛选处指定后缀名的文件</span></span><br><span class="line">	<span class="keyword">if</span> (wcscmp(<span class="string">L&quot;.sLn&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.obj&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.tlog&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.idb&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.pdb&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.pch&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.res&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.ilk&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.sdf&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.ipch&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.lastbuildstate&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span></span><br><span class="line">		)</span><br><span class="line">	&#123;</span><br><span class="line">		buf.Format(<span class="string">L&quot;VS工程文件&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">1</span>, buf);</span><br><span class="line">		<span class="comment">//wcscmp(L&quot;.exe&quot;, PathFindExtension(filePath)) == 0 ||</span></span><br><span class="line">		fileInfo-&gt;TYPE = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wcscmp(<span class="string">L&quot;.cpp&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.h&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span></span><br><span class="line">		)</span><br><span class="line">	&#123;</span><br><span class="line">		buf.Format(<span class="string">L&quot;C++代码&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">1</span>, buf);</span><br><span class="line">		fileInfo-&gt;TYPE = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wcscmp(<span class="string">L&quot;.exe&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> </span><br><span class="line">		</span><br><span class="line">		)</span><br><span class="line">	&#123;</span><br><span class="line">		buf.Format(<span class="string">L&quot;应用程序&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">1</span>, buf);</span><br><span class="line">		fileInfo-&gt;TYPE = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">		wcscmp(<span class="string">L&quot;.dll&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span></span><br><span class="line">		)</span><br><span class="line">	&#123;</span><br><span class="line">		buf.Format(<span class="string">L&quot;应用程序扩展&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">1</span>, buf);</span><br><span class="line">		fileInfo-&gt;TYPE = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wcscmp(<span class="string">L&quot;.msi&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">		)</span><br><span class="line">	&#123;</span><br><span class="line">		buf.Format(<span class="string">L&quot;Windows安装程序包&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">1</span>, buf);</span><br><span class="line">		fileInfo-&gt;TYPE = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (wcscmp(<span class="string">L&quot;.html&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span>||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.js&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.css&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.htm&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span></span><br><span class="line">		)</span><br><span class="line">	&#123;</span><br><span class="line">		buf.Format(<span class="string">L&quot;网页文件&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">1</span>, buf);</span><br><span class="line">		fileInfo-&gt;TYPE = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">		wcscmp(<span class="string">L&quot;.rar&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span>||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.7z&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> ||</span><br><span class="line">		wcscmp(<span class="string">L&quot;.zip&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span></span><br><span class="line">		)</span><br><span class="line">	&#123;</span><br><span class="line">		buf.Format(<span class="string">L&quot;压缩文件&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">1</span>, buf);</span><br><span class="line">		fileInfo-&gt;TYPE = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">		wcscmp(<span class="string">L&quot;.log&quot;</span>, PathFindExtension(filePath)) == <span class="number">0</span> </span><br><span class="line">		)</span><br><span class="line">	&#123;</span><br><span class="line">		buf.Format(<span class="string">L&quot;日志文件&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">1</span>, buf);</span><br><span class="line">		fileInfo-&gt;TYPE = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		CString cs;</span><br><span class="line">		cs = filePath;</span><br><span class="line">		buf= cs.Right(<span class="number">3</span>);</span><br><span class="line">		cs.Format(<span class="string">L&quot;%s文件&quot;</span>,buf);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">1</span>, cs);</span><br><span class="line">		fileInfo-&gt;TYPE = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	HANDLE hFile = CreateFile(filePath, GENERIC_READ | GENERIC_WRITE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">	CHAR Buffer[<span class="number">10</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	DWORD Read = <span class="number">0</span>;</span><br><span class="line">	ReadFile(hFile, Buffer, <span class="number">3</span>, &amp;Read, <span class="literal">NULL</span>);</span><br><span class="line">	CString cs;</span><br><span class="line">	DWORD dwRealSize = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (hFile != INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//获取文件大小，申请相应的缓冲区空间</span></span><br><span class="line">		DWORD dwSize = GetFileSize(hFile, <span class="literal">NULL</span>);</span><br><span class="line">		dwRealSize = dwSize;</span><br><span class="line">		<span class="comment">//char* pbuf = new char[dwSize] &#123;0&#125;;</span></span><br><span class="line">	</span><br><span class="line">		CloseHandle(hFile);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//文件扩展属性</span></span><br><span class="line">	DWORD dwAttribute = GetFileAttributes(filePath);</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute &amp; FILE_ATTRIBUTE_HIDDEN)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		buf.Format(<span class="string">L&quot;隐藏文件&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">4</span>, buf);<span class="comment">//</span></span><br><span class="line">		fileInfo-&gt;PROPERTY = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (dwAttribute &amp; FILE_ATTRIBUTE_READONLY)</span><br><span class="line">	&#123;</span><br><span class="line">		buf.Format(<span class="string">L&quot;只读文件&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">4</span>, buf);<span class="comment">//</span></span><br><span class="line">		fileInfo-&gt;PROPERTY = buf;</span><br><span class="line">	&#125;</span><br><span class="line">	WIN32_FILE_ATTRIBUTE_DATA wfad = &#123;&#125;;<span class="comment">//创建时间</span></span><br><span class="line"><span class="comment">//	WIN32_FILE_ATTRIBUTE_DATA ftLastAccessTime;</span></span><br><span class="line"><span class="comment">//	WIN32_FILE_ATTRIBUTE_DATA ftLastWriteTime;</span></span><br><span class="line">	GetFileAttributesEx(filePath, GetFileExInfoStandard, &amp;wfad);</span><br><span class="line">	<span class="comment">//5.2 扩展属性</span></span><br><span class="line">	<span class="comment">//wfad.ftCreationTime;//这里获取到的是时间戳</span></span><br><span class="line">	<span class="comment">//存放创建时间</span></span><br><span class="line">	FILETIME fi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	SYSTEMTIME st = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="comment">//wfad.ftLastAccessTime;</span></span><br><span class="line">	<span class="comment">//修改时间</span></span><br><span class="line">	FILETIME fix = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	SYSTEMTIME stx = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="comment">//最后的访问时间</span></span><br><span class="line">	FILETIME fiw = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	SYSTEMTIME stw = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="comment">//将标准时间转换为本地时间</span></span><br><span class="line">	FileTimeToLocalFileTime(&amp;wfad.ftCreationTime, &amp;fi);<span class="comment">//创建时间</span></span><br><span class="line">	FileTimeToLocalFileTime(&amp;wfad.ftLastAccessTime, &amp;fix);<span class="comment">//访问时间</span></span><br><span class="line">	FileTimeToLocalFileTime(&amp;wfad.ftLastAccessTime, &amp;fiw);<span class="comment">//写入时间</span></span><br><span class="line">	<span class="comment">//将时间戳转为能够看懂的时间</span></span><br><span class="line">	FileTimeToSystemTime(&amp;fi, &amp;st);</span><br><span class="line">	FileTimeToSystemTime(&amp;fix, &amp;stx);</span><br><span class="line">	FileTimeToSystemTime(&amp;fiw, &amp;stw);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建时间</span></span><br><span class="line">	buf.Format(<span class="string">L&quot;%d年%d月%d日-%d时%d分%d秒&quot;</span>, st.wYear, st.wMonth, st.wDay, st.wHour, st.wMinute, st.wSecond);</span><br><span class="line">	<span class="comment">//m_objComList.SetItemText(i, 3, buf);</span></span><br><span class="line">	fileInfo-&gt;CREATEDATE = buf;</span><br><span class="line">	buf.Format(<span class="string">L&quot;%d年%d月%d日-%d时%d分%d秒&quot;</span>, stx.wYear, stx.wMonth, stx.wDay, stx.wHour, stx.wMinute, stx.wSecond);</span><br><span class="line">	m_objComList.SetItemText(i, <span class="number">3</span>, buf);<span class="comment">//修改时间</span></span><br><span class="line">	fileInfo-&gt;MODIFYDATE = buf;</span><br><span class="line">	<span class="comment">//访问时间</span></span><br><span class="line">	buf.Format(<span class="string">L&quot;%d年%d月%d日-%d时%d分%d秒&quot;</span>, stw.wYear, stw.wMonth, stw.wDay, stw.wHour, stw.wMinute, stw.wSecond);</span><br><span class="line">	fileInfo-&gt;ACCESSDATE = buf;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//文件大小转换字节转换KB</span></span><br><span class="line">	CString csSize;</span><br><span class="line">	<span class="keyword">int</span> Size = dwRealSize / <span class="number">1024</span>;</span><br><span class="line">	<span class="keyword">if</span> (Size &lt; <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		csSize.Format(<span class="string">L&quot;1 Kb&quot;</span>);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">2</span>, csSize);</span><br><span class="line">		fileInfo-&gt;SIZE = Size;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>((Size/<span class="number">1024</span>))</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		csSize.Format(<span class="string">L&quot;%d Kb&quot;</span>, Size);</span><br><span class="line">		m_objComList.SetItemText(i, <span class="number">2</span>, csSize);</span><br><span class="line">		fileInfo-&gt;SIZE = Size;</span><br><span class="line">	&#125;</span><br><span class="line">		m_objComList.SetItemText(i,<span class="number">5</span>, filePath);</span><br><span class="line">		fileInfo-&gt;PATH = filePath;</span><br><span class="line">		vecFileInfo.push_back(fileInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="双击list控件中的文件并执行"><a href="#双击list控件中的文件并执行" class="headerlink" title="双击list控件中的文件并执行"></a>双击list控件中的文件并执行</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//双击运行</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyComputerDlg::OnDblclkList1</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LPNMITEMACTIVATE pNMItemActivate = <span class="keyword">reinterpret_cast</span>&lt;LPNMITEMACTIVATE&gt;(pNMHDR);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	CString Path = m_objComList.GetItemText(pNMItemActivate-&gt;iItem, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	ShellExecute(<span class="literal">NULL</span>, <span class="literal">NULL</span>, _T(<span class="string">&quot;explorer&quot;</span>), Path, <span class="literal">NULL</span>, SW_SHOW);</span><br><span class="line"></span><br><span class="line">	*pResult = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="右击文件列表（List）弹窗显示详细信息"><a href="#右击文件列表（List）弹窗显示详细信息" class="headerlink" title="右击文件列表（List）弹窗显示详细信息"></a>右击文件列表（List）弹窗显示详细信息</h2><h3 id="响应右击并弹窗"><a href="#响应右击并弹窗" class="headerlink" title="响应右击并弹窗"></a>响应右击并弹窗</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//右击列表的响应</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyComputerDlg::OnRclickList1</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LPNMITEMACTIVATE pNMItemActivate = <span class="keyword">reinterpret_cast</span>&lt;LPNMITEMACTIVATE&gt;(pNMHDR);</span><br><span class="line">	</span><br><span class="line">	CString Name = m_objComList.GetItemText(pNMItemActivate-&gt;iItem, <span class="number">0</span>);</span><br><span class="line">	CString Path = m_objComList.GetItemText(pNMItemActivate-&gt;iItem, <span class="number">5</span>);</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; vecFileInfo.size(); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (vecFileInfo[i]-&gt;PATH == Path)</span><br><span class="line">		&#123;</span><br><span class="line">			CMyFileSelectDlg* FileDlg = <span class="keyword">new</span> CMyFileSelectDlg;</span><br><span class="line">			FileDlg-&gt;Create(IDD_FILESELECT,<span class="keyword">this</span>);</span><br><span class="line">			FileDlg-&gt;ShowWindow(SW_SHOW);</span><br><span class="line">			FileDlg-&gt;GetFileInfo(vecFileInfo[i]-&gt;TYPE, vecFileInfo[i]-&gt;SIZE, vecFileInfo[i]-&gt;CREATEDATE,</span><br><span class="line">				vecFileInfo[i]-&gt;MODIFYDATE, vecFileInfo[i]-&gt;ACCESSDATE, vecFileInfo[i]-&gt;PROPERTY, vecFileInfo[i]-&gt;PATH</span><br><span class="line">				,Name);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*pResult = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="输出信息及线程的调用"><a href="#输出信息及线程的调用" class="headerlink" title="输出信息及线程的调用"></a>输出信息及线程的调用</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">MD5Call</span><span class="params">(LPARAM lparam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CMyFileSelectDlg* pObj =(CMyFileSelectDlg*)lparam;</span><br><span class="line">	pObj-&gt;MD5(pObj-&gt;m_Path);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyFileSelectDlg::GetFileInfo</span><span class="params">(CString TYPE, DWORD SIZE, CString CREATEDATE,</span></span></span><br><span class="line"><span class="function"><span class="params">	CString MODIFYDATE, CString ACCESSDATE, CString PROPERTY, CString PATH,CString Name</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_Path = PATH;</span><br><span class="line">	m_strFileName.SetString(Name);</span><br><span class="line">	CString cs;</span><br><span class="line">	cs.Format(<span class="string">L&quot;%dKB&quot;</span>, SIZE);</span><br><span class="line">	m_strFileSize .SetString(cs);</span><br><span class="line">	m_strFileType .SetString(TYPE);</span><br><span class="line">	m_strFileProperty.SetString(PROPERTY);</span><br><span class="line">	m_strCreateDate .SetString(ACCESSDATE);</span><br><span class="line">	m_strModifyDate .SetString(MODIFYDATE);</span><br><span class="line">	m_strAccessDate .SetString(CREATEDATE);</span><br><span class="line">	m_strFilePath.SetString(PATH);</span><br><span class="line">	UpdateData(FALSE);</span><br><span class="line">	<span class="keyword">if</span>(!(SIZE &gt;(<span class="number">1.5</span>*<span class="number">1025</span>*<span class="number">1024</span>)))</span><br><span class="line">	&#123; </span><br><span class="line">	HANDLE ThreadT = CreateThread(</span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 线程的安全属性</span></span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 默认栈的大小(局部变量、参数、返回地址)</span></span><br><span class="line">		(LPTHREAD_START_ROUTINE)MD5Call,	<span class="comment">// 线程代码的起始位置</span></span><br><span class="line">		<span class="keyword">this</span>,	<span class="comment">// 线程函数的参数，如果传递的是地址，那么需要保证这块内存地址的生命周期（不能是局部变量）</span></span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 创建标志</span></span><br><span class="line">		<span class="literal">NULL</span>);			<span class="comment">// 传出的线程ID</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	WaitForSingleObject(ThreadT,<span class="number">-1</span>);</span><br><span class="line">	m_strMd5.SetString(m_chex);</span><br><span class="line">	UpdateData(FALSE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		m_strMd5.SetString(<span class="string">L&quot;文件过大，无法计算&quot;</span>);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="计算MD5值（需要保护openssl）"><a href="#计算MD5值（需要保护openssl）" class="headerlink" title="计算MD5值（需要保护openssl）"></a>计算MD5值（需要保护openssl）</h3><p>#include &lt;openssl/md5.h&gt;<br>#pragma comment(lib,”res/libcrypto.lib”)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算md5</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CMyFileSelectDlg::md5_Value</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* data, <span class="keyword">size_t</span> len, <span class="keyword">unsigned</span> <span class="keyword">char</span>* md5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 初始化保存 md5 信息的结构体</span></span><br><span class="line">	MD5_CTX ctx = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	MD5_Init(&amp;ctx);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将需要计算的数据传入到对应的结构中</span></span><br><span class="line">	MD5_Update(&amp;ctx, data, len);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从结构中获取计算后的结果</span></span><br><span class="line">	MD5_Final(md5, &amp;ctx);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="转换成我们看的懂的16进制"><a href="#转换成我们看的懂的16进制" class="headerlink" title="转换成我们看的懂的16进制"></a>转换成我们看的懂的16进制</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//转换为大端16进制</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyFileSelectDlg::show_hex</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* n, <span class="keyword">unsigned</span> <span class="keyword">char</span>* hex, <span class="keyword">size_t</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CString cs;</span><br><span class="line">	m_chex = <span class="string">L&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		cs.Format(<span class="string">L&quot;%2X&quot;</span>, hex[i]);</span><br><span class="line">		m_chex += cs;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="文件清理"><a href="#文件清理" class="headerlink" title="文件清理"></a>文件清理</h1><h2 id="清空活回收站"><a href="#清空活回收站" class="headerlink" title="清空活回收站"></a>清空活回收站</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//清空回收站</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMySystemDlg::Recycle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SHQUERYRBINFO Recycle = &#123;&#125;;</span><br><span class="line">	Recycle.cbSize = <span class="keyword">sizeof</span>(Recycle);</span><br><span class="line">	SHQueryRecycleBin(<span class="literal">NULL</span>,&amp;Recycle);</span><br><span class="line">	SHEmptyRecycleBin(<span class="literal">NULL</span>,<span class="literal">NULL</span>,SHERB_NOCONFIRMATION|SHERB_NOPROGRESSUI|SHERB_NOSOUND);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="VS工程清理"><a href="#VS工程清理" class="headerlink" title="VS工程清理"></a>VS工程清理</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vs工程查找</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMySystemDlg::OnBnClickedCleanbuttonvs</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (filePath != <span class="string">L&quot;&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">char</span> pDecs1[][<span class="number">20</span>] = &#123;</span><br><span class="line">		<span class="string">&quot;.exe&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.obj&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.tlog&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.idb&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.pdb&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.pch&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.res&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.ilk&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.sdf&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.ipch&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.log&quot;</span>,</span><br><span class="line">		<span class="string">&quot;.lastbuildstate&quot;</span></span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0xc</span>; i++)</span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="keyword">sizeof</span>(pDecs[i]); j++)</span><br><span class="line">			&#123;</span><br><span class="line">				pDecs[i][j] = pDecs1[i][j];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		EnumFile(filePath);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(<span class="string">L&quot;请先把需要清理的VS工程文件拖入本程序&quot;</span>,<span class="string">L&quot;提示&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="文件遍历"><a href="#文件遍历" class="headerlink" title="文件遍历"></a>文件遍历</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMySystemDlg::EnumFile</span><span class="params">(CString filePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CString csPath;</span><br><span class="line">		<span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">		CString cs;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 拼接完整路径</span></span><br><span class="line">		CString fullPath = filePath + <span class="string">L&quot;\\*&quot;</span>;</span><br><span class="line">		<span class="comment">// 查找第一个文件</span></span><br><span class="line">		WIN32_FIND_DATA fileData = &#123;&#125;;</span><br><span class="line">		HANDLE hFile = FindFirstFile(fullPath, &amp;fileData);</span><br><span class="line">		<span class="keyword">if</span> (hFile != INVALID_HANDLE_VALUE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">do</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// 输出文件的信息，</span></span><br><span class="line">				<span class="comment">// 过滤两个文件夹……</span></span><br><span class="line">				<span class="keyword">if</span> (wcscmp(fileData.cFileName, <span class="string">L&quot;.&quot;</span>) == <span class="number">0</span> ||</span><br><span class="line">					wcscmp(fileData.cFileName, <span class="string">L&quot;..&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 如果找到的是目录，递归遍历目录中的其他文件</span></span><br><span class="line">				<span class="keyword">if</span> (fileData.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">				&#123;</span><br><span class="line">					EnumFile(filePath + <span class="string">L&quot;\\&quot;</span> + fileData.cFileName);</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 获取文件大小</span></span><br><span class="line">				DWORD dwSize = (fileData.nFileSizeHigh * (MAXDWORD + <span class="number">1</span>))</span><br><span class="line">					+ fileData.nFileSizeLow;</span><br><span class="line">				<span class="comment">// 转换成字符串格式</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="keyword">sizeof</span>(pDecs); j++)</span><br><span class="line">				&#123;</span><br><span class="line">					cs = pDecs[j];</span><br><span class="line">					<span class="keyword">if</span> (wcscmp(cs, PathFindExtension(fileData.cFileName)) == <span class="number">0</span></span><br><span class="line">						)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//保存路径到vector中</span></span><br><span class="line">						csPath.Format(<span class="string">L&quot;%s\\%s&quot;</span>, filePath, fileData.cFileName);</span><br><span class="line"></span><br><span class="line">						vecPath.push_back(csPath);<span class="comment">//将路径加入vector</span></span><br><span class="line">						m_objInputInfo.InsertItem(i, <span class="string">L&quot;&quot;</span>);</span><br><span class="line">						m_objInputInfo.SetItemText(i, <span class="number">1</span>, filePath + <span class="string">L&quot;\\&quot;</span> + fileData.cFileName);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				i++;</span><br><span class="line">				<span class="comment">// 继续遍历下一个文件</span></span><br><span class="line">			&#125; <span class="keyword">while</span> (FindNextFile(hFile, &amp;fileData));</span><br><span class="line">		&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="文件删除"><a href="#文件删除" class="headerlink" title="文件删除"></a>文件删除</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Vs文件删除</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMySystemDlg::OnBnClickedButton1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!(vecPath.size() == <span class="number">0</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> Error;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; vecPath.size(); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//1. 删除文件</span></span><br><span class="line">			Error = DeleteFile(vecPath[i]);<span class="comment">//error等于0说明清理成功</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (Error)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//m_FileList2.SetItemText(i, 1, L&quot;清理成功&quot;);</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; vecPath.size(); i++)</span><br><span class="line">			&#123;</span><br><span class="line">				m_objInputInfo.DeleteItem(<span class="number">1</span>);</span><br><span class="line">				Sleep(<span class="number">30</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			vecPath.empty();</span><br><span class="line">			m_objInputInfo.InsertItem(<span class="number">1</span>, <span class="string">L&quot;&quot;</span>);</span><br><span class="line">			m_objInputInfo.SetItemText(<span class="number">1</span>, <span class="number">1</span>, <span class="string">L&quot;清理成功&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(<span class="string">L&quot;请先点击VS工程获取按钮&quot;</span>, <span class="string">L&quot;提示&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="系统缓存"><a href="#系统缓存" class="headerlink" title="系统缓存"></a>系统缓存</h2><h3 id="缓存查找"><a href="#缓存查找" class="headerlink" title="缓存查找"></a>缓存查找</h3><p>我这里就使用了三个路径</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//系统缓存查找</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMySystemDlg::OnBnClickedCleanbuttonsy</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	CString sPath;</span><br><span class="line">	CString csCleanPath;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取//L&quot;C:\\Users\\hugan\\AppData\\Local\\Temp&quot;路径 （用户临时文件）</span></span><br><span class="line">	SHGetFolderPath(<span class="literal">NULL</span>, CSIDL_LOCAL_APPDATA, <span class="literal">NULL</span>, <span class="number">0</span>, sPath.GetBuffer());<span class="comment">//L&quot;C:\\Users\\hugan\\AppData\\Local&quot;</span></span><br><span class="line"></span><br><span class="line">	csCleanPath.Format(<span class="string">L&quot;%s%s&quot;</span>, sPath, <span class="string">L&quot;\\Temp&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	csSystem[<span class="number">0</span>] = csCleanPath;</span><br><span class="line">	</span><br><span class="line">	csCleanPath.Format(<span class="string">L&quot;%s%s&quot;</span>, sPath, <span class="string">L&quot;\\Microsoft\\Windows\\WER\\ReportQueue&quot;</span>);</span><br><span class="line">	csSystem[<span class="number">1</span>] = csCleanPath;<span class="comment">//Windows错误报告</span></span><br><span class="line">	sPath.ReleaseBuffer();</span><br><span class="line">	<span class="comment">//获取L&quot;C:\\WINDOWS\\Temp&quot;路径  （系统临时文件）</span></span><br><span class="line">	SHGetFolderPath(<span class="literal">NULL</span>, CSIDL_WINDOWS, <span class="literal">NULL</span>, <span class="number">0</span>, sPath.GetBuffer(MAX_PATH));<span class="comment">//L&quot;C:\\WINDOWS&quot;</span></span><br><span class="line"></span><br><span class="line">	csCleanPath.Format(<span class="string">L&quot;%s%s&quot;</span>, sPath, <span class="string">L&quot;\\Temp&quot;</span>);</span><br><span class="line">	csSystem[<span class="number">2</span>] = csCleanPath;</span><br><span class="line">	sPath.ReleaseBuffer();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建线程</span></span><br><span class="line">	HANDLE Thread = CreateThread(</span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 线程的安全属性</span></span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 默认栈的大小(局部变量、参数、返回地址)</span></span><br><span class="line">		(LPTHREAD_START_ROUTINE)SystemCleanBack,	<span class="comment">// 线程代码的起始位置</span></span><br><span class="line">		<span class="keyword">this</span>,	<span class="comment">// 线程函数的参数，如果传递的是地址，那么需要保证这块内存地址的生命周期（不能是局部变量）</span></span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 创建标志</span></span><br><span class="line">		<span class="literal">NULL</span>);			<span class="comment">// 传出的线程ID</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//系统缓存回调函数所用参数</span></span><br><span class="line">CString csSystem[<span class="number">3</span>];</span><br><span class="line"><span class="built_in">vector</span>&lt;CString&gt;vecCleanPath;</span><br><span class="line"><span class="comment">//系统缓存回调函数</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">SystemCleanBack</span><span class="params">(LPARAM lparam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CMySystemDlg* pObj = (CMySystemDlg*)lparam;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		pObj-&gt;SystemClean(csSystem[i]);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="文件遍历-1"><a href="#文件遍历-1" class="headerlink" title="文件遍历"></a>文件遍历</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMySystemDlg::SystemClean</span><span class="params">(CString csPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CString csFilePath;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">		CString fullPath = csPath + <span class="string">L&quot;\\*&quot;</span>;</span><br><span class="line">		<span class="comment">// 查找第一个文件</span></span><br><span class="line">		WIN32_FIND_DATA fileData = &#123;&#125;;</span><br><span class="line">		HANDLE hFile = FindFirstFile(fullPath, &amp;fileData);</span><br><span class="line">		<span class="keyword">if</span> (hFile != INVALID_HANDLE_VALUE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">do</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// 输出文件的信息，</span></span><br><span class="line">				<span class="comment">// 过滤两个文件夹……</span></span><br><span class="line">				<span class="keyword">if</span> (wcscmp(fileData.cFileName, <span class="string">L&quot;.&quot;</span>) == <span class="number">0</span> ||</span><br><span class="line">					wcscmp(fileData.cFileName, <span class="string">L&quot;..&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 如果找到的是目录，递归遍历目录中的其他文件</span></span><br><span class="line">				<span class="keyword">if</span> (fileData.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">				&#123;</span><br><span class="line">					</span><br><span class="line">					SystemClean(csPath + <span class="string">L&quot;\\&quot;</span> + fileData.cFileName);</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//保存路径到vector中</span></span><br><span class="line">				csFilePath = csPath + <span class="string">L&quot;\\&quot;</span> + fileData.cFileName;</span><br><span class="line">				<span class="comment">//csPath.Format(L&quot;%s%s&quot;, csSystem[j], fileData.cFileName);</span></span><br><span class="line">				vecCleanPath.push_back(csFilePath);<span class="comment">//将路径加入vector</span></span><br><span class="line">				<span class="comment">//cs.Format(L&quot;%d&quot;, i);</span></span><br><span class="line">				m_objInputInfo.InsertItem(i, <span class="string">L&quot;&quot;</span>);</span><br><span class="line">				m_objInputInfo.SetItemText(i, <span class="number">1</span>, csFilePath);</span><br><span class="line">				i++;</span><br><span class="line">				<span class="comment">// 继续遍历下一个文件</span></span><br><span class="line">			&#125; <span class="keyword">while</span> (FindNextFile(hFile, &amp;fileData));</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="内存优化（类似于一键加速）"><a href="#内存优化（类似于一键加速）" class="headerlink" title="内存优化（类似于一键加速）"></a>内存优化（类似于一键加速）</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内存优化</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMySystemDlg::GetMemStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MEMORYSTATUSEX stcMemStatusEx = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	stcMemStatusEx.dwLength = <span class="keyword">sizeof</span>(stcMemStatusEx);</span><br><span class="line">	GlobalMemoryStatusEx(&amp;stcMemStatusEx);</span><br><span class="line">	DWORDLONG preUsedMem = stcMemStatusEx.ullTotalPhys - stcMemStatusEx.ullAvailPhys;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2.清理内存</span></span><br><span class="line"></span><br><span class="line">	DWORD dwPIDList[<span class="number">1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	DWORD bufSize = <span class="keyword">sizeof</span>(dwPIDList); </span><br><span class="line">	DWORD dwNeedSize = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	EnumProcesses(dwPIDList, bufSize, &amp;dwNeedSize);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; dwNeedSize / <span class="keyword">sizeof</span>(DWORD); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		HANDLE hProcess = OpenProcess(PROCESS_SET_QUOTA, <span class="literal">false</span>, dwPIDList[i]);</span><br><span class="line"></span><br><span class="line">		SetProcessWorkingSetSize(hProcess, <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="comment">//3.获取清理后的内存状态</span></span><br><span class="line"></span><br><span class="line">	GlobalMemoryStatusEx(&amp;stcMemStatusEx); DWORDLONG afterCleanUsedMem;</span><br><span class="line"></span><br><span class="line">		stcMemStatusEx.ullTotalPhys - stcMemStatusEx.ullAvailPhys;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="LOAD-PE解析"><a href="#LOAD-PE解析" class="headerlink" title="LOAD_PE解析"></a>LOAD_PE解析</h1><h2 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">/响应文件拖拽</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyLoadPeDlg::OnDropFiles</span><span class="params">(HDROP hDropInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">	<span class="comment">// 存放文件路径</span></span><br><span class="line">	<span class="keyword">wchar_t</span> filePath[MAX_PATH] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取拖拽文件的路径</span></span><br><span class="line">	DragQueryFile(hDropInfo, <span class="number">0</span>, filePath, MAX_PATH);</span><br><span class="line"></span><br><span class="line">	WCHAR* wFilePath = filePath;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1 打开文件</span></span><br><span class="line">	HANDLE hFile = CreateFile(</span><br><span class="line">		wFilePath,</span><br><span class="line">		GENERIC_ALL,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	<span class="comment">//2 获取文件大小</span></span><br><span class="line">	DWORD dwFileSize = GetFileSize(hFile, <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//3 申请空间并初始化</span></span><br><span class="line">	buf = <span class="keyword">new</span> <span class="keyword">char</span>[dwFileSize] &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="comment">//4 读取文件</span></span><br><span class="line">	DWORD dwRealSize = <span class="number">0</span>;</span><br><span class="line">	ReadFile(hFile, buf, dwFileSize, &amp;dwRealSize, <span class="literal">NULL</span>);</span><br><span class="line">	CloseHandle(hFile);</span><br><span class="line">	<span class="comment">//5 判断是不是PE文件</span></span><br><span class="line">	<span class="keyword">if</span> (IsPE_File(buf) == TRUE)</span><br><span class="line">	&#123;		</span><br><span class="line">		<span class="comment">//AnalyzeNTHeader(buf);</span></span><br><span class="line">		CMyPeShowDlg* CMyShowDlg = <span class="keyword">new</span> CMyPeShowDlg;</span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		CMyShowDlg-&gt;Create(IDD_PESHOWND,<span class="keyword">this</span>);</span><br><span class="line">		CMyShowDlg-&gt;ShowWindow(SW_SHOW);</span><br><span class="line">		CMyShowDlg-&gt;GetFilePath(buf);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(<span class="string">L&quot;别瞎搞&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	CDialogEx::OnDropFiles(hDropInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="判断文件是否为PE文件"><a href="#判断文件是否为PE文件" class="headerlink" title="判断文件是否为PE文件"></a>判断文件是否为PE文件</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是不是PE文件</span></span><br><span class="line"><span class="function">BOOL <span class="title">CMyLoadPeDlg::IsPE_File</span><span class="params">(<span class="keyword">char</span>* lpImage)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)lpImage;</span><br><span class="line">	<span class="keyword">if</span> (pDos-&gt;e_magic != IMAGE_DOS_SIGNATURE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + lpImage);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pNt-&gt;Signature != IMAGE_NT_SIGNATURE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="位置计算器"><a href="#位置计算器" class="headerlink" title="位置计算器"></a>位置计算器</h2><h3 id="通过VA计算RVA、FOA"><a href="#通过VA计算RVA、FOA" class="headerlink" title="通过VA计算RVA、FOA"></a>通过VA计算RVA、FOA</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//VA</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyClacDlg::OnBnClickedButton1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	UpdateData(TRUE);</span><br><span class="line">	CString svPid = m_strEditVA.GetString();</span><br><span class="line">	DWORD dwVa = _tcstoul(svPid, <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">	<span class="comment">//1 获取区段表的起始位置</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)m_buff;</span><br><span class="line">	PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + m_buff);</span><br><span class="line">	PIMAGE_SECTION_HEADER pHeader = IMAGE_FIRST_SECTION(pNt);</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER pOption = &amp;pNt-&gt;OptionalHeader;</span><br><span class="line"></span><br><span class="line">	DWORD Rva = dwVa - pOption-&gt;ImageBase;</span><br><span class="line">	CString rva;</span><br><span class="line">	rva.Format(<span class="string">L&quot;%08x&quot;</span>, Rva);</span><br><span class="line">	m_strEditRVA.SetString(rva);</span><br><span class="line">	<span class="comment">//2 循环判断RVA落在了哪个区段中</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		DWORD dwSectionRva = pHeader[i].VirtualAddress;</span><br><span class="line">		DWORD dwSectionEndRva = dwSectionRva + pHeader[i].SizeOfRawData;</span><br><span class="line">		DWORD dwSectionFOA = pHeader[i].PointerToRawData;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (Rva &gt;= dwSectionRva &amp;&amp; Rva &lt;= dwSectionEndRva)</span><br><span class="line">		&#123;</span><br><span class="line">			DWORD dwFOA = Rva - dwSectionRva + dwSectionFOA;</span><br><span class="line">			CString foa;</span><br><span class="line">			foa.Format(<span class="string">L&quot;%08x&quot;</span>, dwFOA);</span><br><span class="line">			m_strEditFOA.SetString(foa);</span><br><span class="line">			<span class="comment">//区段名</span></span><br><span class="line"></span><br><span class="line">			CString name;</span><br><span class="line">			name.Format(<span class="string">L&quot;%S&quot;</span>, pHeader[i].Name);</span><br><span class="line">			m_strEditName.SetString(name);</span><br><span class="line"></span><br><span class="line">			UpdateData(FALSE);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	MessageBox(<span class="string">L&quot;无法计算_请重新输入&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过RVA计算VA、FOA"><a href="#通过RVA计算VA、FOA" class="headerlink" title="通过RVA计算VA、FOA"></a>通过RVA计算VA、FOA</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RVA</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyClacDlg::OnBnClickedButton17</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UpdateData(TRUE);</span><br><span class="line">	CString svPid = m_strEditRVA.GetString();</span><br><span class="line">	DWORD dwRva = _tcstoul(svPid, <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">	<span class="comment">//1 获取区段表的起始位置</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)m_buff;</span><br><span class="line">	PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + m_buff);</span><br><span class="line">	PIMAGE_SECTION_HEADER pHeader = IMAGE_FIRST_SECTION(pNt);</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER pOption = &amp;pNt-&gt;OptionalHeader;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dwRva &lt; pNt-&gt;OptionalHeader.SizeOfHeaders)</span><br><span class="line">	&#123;</span><br><span class="line">		CString cd;</span><br><span class="line">		cd.Format(<span class="string">L&quot;%08x&quot;</span>, dwRva);</span><br><span class="line">		m_strEditFOA.SetString(cd);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//2 循环判断RVA落在了哪个区段中</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		DWORD dwSectionRva = pHeader[i].VirtualAddress;</span><br><span class="line">		DWORD dwSectionEndRva = dwSectionRva + pHeader[i].SizeOfRawData;</span><br><span class="line">		DWORD dwSectionFOA = pHeader[i].PointerToRawData;</span><br><span class="line">		<span class="keyword">if</span> (dwRva &gt;= dwSectionRva &amp;&amp; dwRva &lt;= dwSectionEndRva)</span><br><span class="line">		&#123;</span><br><span class="line">			pHeader[i].VirtualAddress;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//FOA		= RVA   - RVA区段	   + FOA区段</span></span><br><span class="line">			DWORD dwFOA = dwRva - dwSectionRva + dwSectionFOA;</span><br><span class="line">			CString foa;</span><br><span class="line">			foa.Format(<span class="string">L&quot;%08x&quot;</span>, dwFOA);</span><br><span class="line">			m_strEditFOA.SetString(foa);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//va虚拟地址= InmageBase(加载基址) + RVA(相对虚拟地址)</span></span><br><span class="line">			DWORD dwVA = pOption-&gt;ImageBase + dwRva;</span><br><span class="line">			CString va;</span><br><span class="line">			va.Format(<span class="string">L&quot;%08x&quot;</span>, dwVA);</span><br><span class="line">			m_strEditVA.SetString(va);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//区段名</span></span><br><span class="line">			CString name;</span><br><span class="line">			name.Format(<span class="string">L&quot;%S&quot;</span>, pHeader[i].Name);</span><br><span class="line">			m_strEditName.SetString(name);</span><br><span class="line"></span><br><span class="line">			UpdateData(FALSE);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	MessageBox(<span class="string">L&quot;无法计算_请重新输入&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过FOA计算VA、RVA"><a href="#通过FOA计算VA、RVA" class="headerlink" title="通过FOA计算VA、RVA"></a>通过FOA计算VA、RVA</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//FOA</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyClacDlg::OnBnClickedButton18</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UpdateData(TRUE);</span><br><span class="line">	CString svPid = m_strEditFOA.GetString();</span><br><span class="line">	DWORD dwFoa = _tcstoul(svPid, <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">	<span class="comment">//1 获取区段表的起始位置</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)m_buff;</span><br><span class="line">	PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + m_buff);</span><br><span class="line">	PIMAGE_SECTION_HEADER pHeader = IMAGE_FIRST_SECTION(pNt);</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER pOption = &amp;pNt-&gt;OptionalHeader;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dwFoa &lt; pNt-&gt;OptionalHeader.SizeOfHeaders)</span><br><span class="line">	&#123;</span><br><span class="line">		CString cd;</span><br><span class="line">		cd.Format(<span class="string">L&quot;%08x&quot;</span>, dwFoa);</span><br><span class="line">		m_strEditRVA.SetString(cd);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//2 循环判断FOA落在了哪个区段中</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		DWORD dwSectionRva = pHeader[i].VirtualAddress;</span><br><span class="line">		DWORD dwSectionEndRva = dwSectionRva + pHeader[i].SizeOfRawData;</span><br><span class="line">		DWORD dwSectionFOA = pHeader[i].PointerToRawData;</span><br><span class="line"></span><br><span class="line">			pHeader[i].VirtualAddress;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//FOA		= RVA   - RVA区段	   + FOA区段</span></span><br><span class="line">			<span class="comment">//DWORD dwFOA = dwFoa - dwSectionRva + dwSectionFOA;</span></span><br><span class="line">			DWORD	Rva = dwFoa + dwSectionRva - dwSectionFOA;</span><br><span class="line">			CString rva;</span><br><span class="line">			rva.Format(<span class="string">L&quot;%08x&quot;</span>, Rva);</span><br><span class="line">			m_strEditRVA.SetString(rva);</span><br><span class="line">			<span class="comment">//va虚拟地址= InmageBase(加载基址) + RVA(相对虚拟地址)</span></span><br><span class="line">			DWORD dwVA = pOption-&gt;ImageBase + Rva;</span><br><span class="line">			CString va;</span><br><span class="line">			va.Format(<span class="string">L&quot;%08x&quot;</span>, dwVA);</span><br><span class="line">			m_strEditVA.SetString(va);</span><br><span class="line">			<span class="keyword">if</span> (Rva &gt;= dwSectionRva &amp;&amp; Rva &lt;= dwSectionEndRva)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//区段名</span></span><br><span class="line">				CString name;</span><br><span class="line">				name.Format(<span class="string">L&quot;%S&quot;</span>, pHeader[i].Name);</span><br><span class="line">				m_strEditName.SetString(name);</span><br><span class="line"></span><br><span class="line">				UpdateData(FALSE);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	MessageBox(<span class="string">L&quot;无法计算_请重新输入&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="RVA转换FOA（函数封装）"><a href="#RVA转换FOA（函数封装）" class="headerlink" title="RVA转换FOA（函数封装）"></a>RVA转换FOA（函数封装）</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RVA转换FOA</span></span><br><span class="line"><span class="function">DWORD <span class="title">CMyExPortTabDlg::RvaToFoa</span><span class="params">(DWORD dwRva, <span class="keyword">char</span>* buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//1 获取区段表的起始位置</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)buf;</span><br><span class="line">	PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + buf);</span><br><span class="line">	PIMAGE_SECTION_HEADER pHeader = IMAGE_FIRST_SECTION(pNt);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dwRva &lt; pNt-&gt;OptionalHeader.SizeOfHeaders)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> dwRva;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//2 循环判断RVA落在了哪个区段中</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		DWORD dwSectionRva = pHeader[i].VirtualAddress;</span><br><span class="line">		DWORD dwSectionEndRva = dwSectionRva + pHeader[i].SizeOfRawData;</span><br><span class="line">		DWORD dwSectionFOA = pHeader[i].PointerToRawData;</span><br><span class="line">		<span class="keyword">if</span> (dwRva &gt;= dwSectionRva &amp;&amp; dwRva &lt;= dwSectionEndRva)</span><br><span class="line">		&#123;</span><br><span class="line">			pHeader[i].VirtualAddress;</span><br><span class="line">			DWORD dwFOA = dwRva - dwSectionRva + dwSectionFOA;</span><br><span class="line">			<span class="keyword">return</span> dwFOA;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="目录表"><a href="#目录表" class="headerlink" title="目录表"></a>目录表</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输出目录表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyDirTabDlg::GetPath</span><span class="params">(<span class="keyword">int</span> i, PIMAGE_DATA_DIRECTORY pExportDir, <span class="keyword">char</span>* buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_Filebuff = buf;</span><br><span class="line">	CString Address;</span><br><span class="line">	CString Size;</span><br><span class="line">	<span class="keyword">switch</span> (i)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:<span class="comment">//导出表	</span></span><br><span class="line">		m_pExportDir = pExportDir;</span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditOutTabRVA.SetString(Address);</span><br><span class="line">		m_dwSize = pExportDir-&gt;Size;<span class="comment">//保存导出表大小，可做判断</span></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditOutTabSIZE.SetString(Size);</span><br><span class="line"></span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:<span class="comment">//导入表</span></span><br><span class="line">		m_pInportDir = pExportDir;</span><br><span class="line"></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditInTabRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditInTabSIZE.SetString(Size);</span><br><span class="line"></span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:<span class="comment">//资源表</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditResourcesRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditResourcesSIZE.SetString(Size);</span><br><span class="line"></span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>:<span class="comment">//异常表Abnormal</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditAbnormalRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditAbnormalSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">4</span>:<span class="comment">//安全security</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditSecurityRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditSecuritySIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">5</span>:<span class="comment">//重定位Basereloc</span></span><br><span class="line">		m_pReLocaTionDir = pExportDir;</span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditBaserelocRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditBaserelocSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">6</span>:<span class="comment">//调试Debug</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditDebugRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditDebugSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">7</span>:<span class="comment">//版权Architecture</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditArchitectureRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditArchitectureSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">8</span>:<span class="comment">//全局指针Glpbalptr</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditGlpbalptrRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditGlpbalptrSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">9</span>:<span class="comment">//线程局部TLS</span></span><br><span class="line">		m_pTlsTab = pExportDir;</span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditTlsRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditTlsSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">10</span>:<span class="comment">//载入配置Config</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditConfigRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditConfigSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">11</span>:<span class="comment">//绑定输出Importll</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditImportllRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditImportllSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">12</span>:<span class="comment">//导入地址表IAT</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditIatRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditIatSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">13</span>:<span class="comment">//延迟载入Import</span></span><br><span class="line">		m_pUnloadTab = pExportDir;</span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditImportRVA.SetString(Address);</span><br><span class="line">		m_dwYanchiSize = pExportDir-&gt;Size;</span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditImportSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">14</span>:<span class="comment">//COM信息</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditComRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditComSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">15</span>:<span class="comment">//保留</span></span><br><span class="line">		Address.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;VirtualAddress);</span><br><span class="line">		m_strEditRVA.SetString(Address);</span><br><span class="line"></span><br><span class="line">		Size.Format(<span class="string">L&quot;%08x&quot;</span>, pExportDir-&gt;Size);</span><br><span class="line">		m_strEditSIZE.SetString(Size);</span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="导出表"><a href="#导出表" class="headerlink" title="导出表"></a>导出表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//导出表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyDirTabDlg::OnBnClickedButton1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m_dwSize==<span class="number">0</span>)<span class="comment">//如果导出表大小为0，直接退出</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(<span class="string">L&quot;导出表为空&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;  </span><br><span class="line">	CMyExPortTabDlg* pExPortTab = <span class="keyword">new</span> CMyExPortTabDlg;</span><br><span class="line">	pExPortTab-&gt;Create(IDD_EXPROTTAB, <span class="keyword">this</span>);</span><br><span class="line">	pExPortTab-&gt;ShowWindow(SW_SHOW);</span><br><span class="line">	pExPortTab-&gt;ShowPortTab(m_pExportDir, m_Filebuff);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="导出表的解析与输出"><a href="#导出表的解析与输出" class="headerlink" title="导出表的解析与输出"></a>导出表的解析与输出</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyExPortTabDlg::ShowPortTab</span><span class="params">(PIMAGE_DATA_DIRECTORY pExportDir, <span class="keyword">char</span>* buff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//初始化列表框</span></span><br><span class="line">	m_objExPortList.SetExtendedStyle(LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES);<span class="comment">//更改风格</span></span><br><span class="line">	<span class="comment">// 添加列</span></span><br><span class="line">	m_objExPortList.InsertColumn(<span class="number">0</span>, <span class="string">L&quot;序号&quot;</span>, <span class="number">0</span>, <span class="number">120</span>);</span><br><span class="line">	m_objExPortList.InsertColumn(<span class="number">1</span>, <span class="string">L&quot;RVA&quot;</span>, <span class="number">0</span>, <span class="number">120</span>);</span><br><span class="line">	m_objExPortList.InsertColumn(<span class="number">2</span>, <span class="string">L&quot;偏移&quot;</span>, <span class="number">0</span>, <span class="number">120</span>);</span><br><span class="line">	m_objExPortList.InsertColumn(<span class="number">3</span>, <span class="string">L&quot;函数名&quot;</span>, <span class="number">0</span>, <span class="number">120</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过导出的目录结构里的相对虚拟地址RVA给转换成FOA</span></span><br><span class="line">	DWORD dwportFOA = RvaToFoa(pExportDir-&gt;VirtualAddress, buff);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//得到FOA后，文件基址加上FOA 就找到了导出表</span></span><br><span class="line">	PIMAGE_EXPORT_DIRECTORY pExport = (PIMAGE_EXPORT_DIRECTORY)(buff + dwportFOA);</span><br><span class="line">	DWORD dwBase = pExport-&gt;Base;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2 得到地址表，名称表，序号表的 FOA</span></span><br><span class="line">	DWORD EatFoa = RvaToFoa( pExport-&gt;AddressOfFunctions, buff);</span><br><span class="line">	DWORD EntFoa = RvaToFoa( pExport-&gt;AddressOfNames, buff);</span><br><span class="line">	DWORD EotFoa = RvaToFoa( pExport-&gt;AddressOfNameOrdinals, buff);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//3 得到地址表，名称表，序号表在文件中的位置</span></span><br><span class="line">	PDWORD  pEat = (PDWORD)(buff + EatFoa);</span><br><span class="line">	PDWORD  pEnt = (PDWORD)(buff + EntFoa);</span><br><span class="line">	PWORD pEot = (PWORD)(buff + EotFoa);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//4 开始解析</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pExport-&gt;NumberOfFunctions; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//4.1 无效地址</span></span><br><span class="line">		<span class="keyword">if</span> (pEat[i] == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//4.2 有效地址将下标放到序号表中去寻找</span></span><br><span class="line">		<span class="keyword">int</span>  j = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span> nSign = FALSE;</span><br><span class="line">		<span class="keyword">for</span> (; j &lt; pExport-&gt;NumberOfNames; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (i == pEot[j])</span><br><span class="line">			&#123;</span><br><span class="line">				nSign = TRUE;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">			<span class="comment">//名称表中，存储的是RVA，需要转为FOA</span></span><br><span class="line">			DWORD dwFunNameFOA = RvaToFoa( pEnt[j], buff);</span><br><span class="line">			<span class="keyword">char</span>* pFunName = buff + dwFunNameFOA;</span><br><span class="line">			</span><br><span class="line">		</span><br><span class="line">			CString cs;</span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>, dwportFOA);</span><br><span class="line">			m_strExPort1.SetString(cs);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>, <span class="number">0x00000000</span>);</span><br><span class="line">			m_strExPort2.SetString(cs);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>, dwBase);</span><br><span class="line">			m_strExPort3.SetString(cs);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>, dwFunNameFOA);</span><br><span class="line">			m_strExPort4.SetString(cs);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>, <span class="number">0x00000000</span>);</span><br><span class="line">			m_strExPort5.SetString(cs);</span><br><span class="line"></span><br><span class="line">			cs.Format(<span class="string">L&quot;%08d&quot;</span>, pExport-&gt;NumberOfFunctions);</span><br><span class="line">			m_strExPort6.SetString(cs);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%08d&quot;</span>, pExport-&gt;NumberOfNames);</span><br><span class="line">			m_strExPort7.SetString(cs);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>, pExport-&gt;AddressOfFunctions);</span><br><span class="line">			m_strExPort8.SetString(cs);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>,pEat[i]);</span><br><span class="line">			m_strExPort9.SetString(cs);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>, pExport-&gt;AddressOfNameOrdinals);</span><br><span class="line">			m_strExPort10.SetString(cs);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//列表控件的输出</span></span><br><span class="line">			cs.Format(<span class="string">L&quot;%04x&quot;</span>, i + dwBase);</span><br><span class="line">			m_objExPortList.InsertItem(i, cs);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>, pEat[i]);</span><br><span class="line">			m_objExPortList.SetItemText(i,<span class="number">1</span>,cs);</span><br><span class="line"></span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>, RvaToFoa(pEat[i], buff));</span><br><span class="line">			m_objExPortList.SetItemText(i, <span class="number">2</span>, cs);</span><br><span class="line">			</span><br><span class="line">			cs.Format(<span class="string">L&quot;%S&quot;</span>, pFunName);</span><br><span class="line">			m_objExPortList.SetItemText(i, <span class="number">3</span>, cs);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		UpdateData(FALSE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="导入表"><a href="#导入表" class="headerlink" title="导入表"></a>导入表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//导入表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyDirTabDlg::OnBnClickedButton4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CMyPortTabDlg* pPortTab = <span class="keyword">new</span> CMyPortTabDlg;</span><br><span class="line">	pPortTab-&gt;Create(IDD_PORTTAB, <span class="keyword">this</span>);</span><br><span class="line">	pPortTab-&gt;ShowWindow(SW_SHOW);</span><br><span class="line">	pPortTab-&gt;ShowPortTab(m_pInportDir, m_Filebuff);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="初始化-2"><a href="#初始化-2" class="headerlink" title="初始化"></a>初始化</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化导入表窗口及控件</span></span><br><span class="line"><span class="function">BOOL <span class="title">CMyPortTabDlg::OnInitDialog</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CDialogEx::OnInitDialog();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化列表框LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES | LVS_EX_CHECKBOXES</span></span><br><span class="line">	m_objProtTabList1.SetExtendedStyle(LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES | LVS_EX_CHECKBOXES);<span class="comment">//更改风格</span></span><br><span class="line">	<span class="comment">// 添加列</span></span><br><span class="line">	m_objProtTabList1.InsertColumn(<span class="number">0</span>, <span class="string">L&quot;MoudleName&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objProtTabList1.InsertColumn(<span class="number">1</span>, <span class="string">L&quot;OriginalFirstThunk&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objProtTabList1.InsertColumn(<span class="number">2</span>, <span class="string">L&quot;TimeDatestamp&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objProtTabList1.InsertColumn(<span class="number">3</span>, <span class="string">L&quot;Name&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objProtTabList1.InsertColumn(<span class="number">4</span>, <span class="string">L&quot;FirstThunk&quot;</span>, <span class="number">0</span>, <span class="number">120</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化列表框LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES | LVS_EX_CHECKBOXES</span></span><br><span class="line">	m_objProtTabList2.SetExtendedStyle(LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES | LVS_EX_CHECKBOXES);<span class="comment">//更改风格</span></span><br><span class="line">	m_objProtTabList2.InsertColumn(<span class="number">0</span>, <span class="string">L&quot;ThunkRVA&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objProtTabList2.InsertColumn(<span class="number">1</span>, <span class="string">L&quot;ThunkOffset&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objProtTabList2.InsertColumn(<span class="number">2</span>, <span class="string">L&quot;ThunkValue&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objProtTabList2.InsertColumn(<span class="number">3</span>, <span class="string">L&quot;Hint&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objProtTabList2.InsertColumn(<span class="number">4</span>, <span class="string">L&quot;ApiName&quot;</span>, <span class="number">0</span>, <span class="number">120</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="导入表的解析"><a href="#导入表的解析" class="headerlink" title="导入表的解析"></a>导入表的解析</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//显示导入表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyPortTabDlg::ShowPortTab</span><span class="params">(PIMAGE_DATA_DIRECTORY pExportDir, <span class="keyword">char</span>* buff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//通过导出的目录结构里的相对虚拟地址RVA给转换成FOA</span></span><br><span class="line">	DWORD dwportFOA = RvaToFoa(pExportDir-&gt;VirtualAddress, buff);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//得到FOA后，文件基址加上FOA 就找到了导入表</span></span><br><span class="line">	PIMAGE_IMPORT_DESCRIPTOR pInportTab = (PIMAGE_IMPORT_DESCRIPTOR)(buff + dwportFOA);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//保存一下，为了给解析名字使用</span></span><br><span class="line">	m_cFilePath = buff;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (pInportTab-&gt;Name != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//保存被点击的行内容</span></span><br><span class="line">		vecInPort.push_back(pInportTab);</span><br><span class="line">		<span class="comment">//2.1 先解析DLL的名字</span></span><br><span class="line">		DWORD dwNameFoa = RvaToFoa(pInportTab-&gt;Name, buff);</span><br><span class="line">		<span class="keyword">char</span>* pDllName = (<span class="keyword">char</span>*)(dwNameFoa + buff);</span><br><span class="line"></span><br><span class="line">		CString temp;</span><br><span class="line">		temp.Format(<span class="string">L&quot;%S&quot;</span>, pDllName);</span><br><span class="line">		m_objProtTabList1.InsertItem(i, temp);</span><br><span class="line"></span><br><span class="line">		temp.Format(<span class="string">L&quot;%08x&quot;</span>, pInportTab-&gt;OriginalFirstThunk);</span><br><span class="line">		m_objProtTabList1.SetItemText(i, <span class="number">1</span>, temp);</span><br><span class="line"></span><br><span class="line">		temp.Format(<span class="string">L&quot;%08x&quot;</span>, pInportTab-&gt;TimeDateStamp);</span><br><span class="line">		m_objProtTabList1.SetItemText(i, <span class="number">2</span>, temp);</span><br><span class="line"></span><br><span class="line">		temp.Format(<span class="string">L&quot;%08x&quot;</span>, pInportTab-&gt;ForwarderChain);</span><br><span class="line">		m_objProtTabList1.SetItemText(i, <span class="number">2</span>, temp);</span><br><span class="line"></span><br><span class="line">		temp.Format(<span class="string">L&quot;%08x&quot;</span>, pInportTab-&gt;Name);</span><br><span class="line">		m_objProtTabList1.SetItemText(i, <span class="number">3</span>, temp);</span><br><span class="line"></span><br><span class="line">		temp.Format(<span class="string">L&quot;%08x&quot;</span>, pInportTab-&gt;FirstThunk);</span><br><span class="line">		m_objProtTabList1.SetItemText(i, <span class="number">4</span>, temp);</span><br><span class="line">		i++;</span><br><span class="line">		pInportTab++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="导入表的输出"><a href="#导入表的输出" class="headerlink" title="导入表的输出"></a>导入表的输出</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//单机显示详情</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyPortTabDlg::OnClickPortabtlist1</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LPNMITEMACTIVATE pNMItemActivate = <span class="keyword">reinterpret_cast</span>&lt;LPNMITEMACTIVATE&gt;(pNMHDR);</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> iItem = pNMItemActivate-&gt;iItem;</span><br><span class="line">	<span class="keyword">if</span> (iItem &lt; <span class="number">0</span>)<span class="comment">//点击的地方为空iItem的值会小于0，然后导致程序出错</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m_objProtTabList2.DeleteAllItems();</span><br><span class="line"></span><br><span class="line">	CString temp;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (vecInPort[iItem]-&gt;Name)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//2.2 解析函数名字，选择用什么去解析		</span></span><br><span class="line">		DWORD oFoa = RvaToFoa(vecInPort[iItem]-&gt;OriginalFirstThunk, m_cFilePath);</span><br><span class="line">		PIMAGE_THUNK_DATA32 pNameTable = (PIMAGE_THUNK_DATA32)(m_cFilePath + oFoa);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		m_objProtTabList2.InsertItem(i, temp);</span><br><span class="line">		<span class="keyword">while</span> (pNameTable-&gt;u1.Ordinal != <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//2.3.1 判断最高位是不是1</span></span><br><span class="line">			<span class="keyword">if</span> (IMAGE_SNAP_BY_ORDINAL32(pNameTable-&gt;u1.Ordinal) == <span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//只有序号</span></span><br><span class="line">				<span class="comment">//printf(&quot;  序号:%x,名称:NULL\n&quot;, pNameTable-&gt;u1.Ordinal &amp; 0x7FFFFFFF);</span></span><br><span class="line">				temp.Format(<span class="string">L&quot;%04x&quot;</span>, pNameTable-&gt;u1.Ordinal &amp; <span class="number">0x7FFFFFFF</span>);</span><br><span class="line">				m_objProtTabList2.InsertItem(i, temp);</span><br><span class="line">				temp.Format(<span class="string">L&quot;NULL&quot;</span>);</span><br><span class="line">				m_objProtTabList2.SetItemText(i, <span class="number">4</span>, temp);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//既有名字，又有序号</span></span><br><span class="line">				DWORD dwNameFoa = RvaToFoa(pNameTable-&gt;u1.AddressOfData, m_cFilePath);</span><br><span class="line">				PIMAGE_IMPORT_BY_NAME pName = (PIMAGE_IMPORT_BY_NAME)(dwNameFoa + m_cFilePath);</span><br><span class="line">				</span><br><span class="line">				temp.Format(<span class="string">L&quot;%08x&quot;</span>, vecInPort[iItem]-&gt;OriginalFirstThunk + (i * <span class="number">4</span>));</span><br><span class="line">				m_objProtTabList2.InsertItem(i, temp);</span><br><span class="line"></span><br><span class="line">				DWORD ThunkFOV = RvaToFoa(vecInPort[iItem]-&gt;OriginalFirstThunk + (i * <span class="number">4</span>), m_cFilePath);</span><br><span class="line">				temp.Format(<span class="string">L&quot;%08x&quot;</span>, ThunkFOV);</span><br><span class="line">				m_objProtTabList2.SetItemText(i, <span class="number">1</span>, temp);</span><br><span class="line"></span><br><span class="line">				temp.Format(<span class="string">L&quot;%08x&quot;</span>, pNameTable-&gt;u1.AddressOfData);</span><br><span class="line">				m_objProtTabList2.SetItemText(i, <span class="number">2</span>, temp);</span><br><span class="line"></span><br><span class="line">				temp.Format(<span class="string">L&quot;%04x&quot;</span>, pName-&gt;Hint);</span><br><span class="line">				m_objProtTabList2.SetItemText(i, <span class="number">3</span>, temp);</span><br><span class="line"></span><br><span class="line">				temp.Format(<span class="string">L&quot;%S&quot;</span>, pName-&gt;Name);</span><br><span class="line">				m_objProtTabList2.SetItemText(i, <span class="number">4</span>, temp);</span><br><span class="line">			&#125;</span><br><span class="line">			i++;</span><br><span class="line">			pNameTable++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*pResult = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="重定位表"><a href="#重定位表" class="headerlink" title="重定位表"></a>重定位表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重定位表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyDirTabDlg::OnBnClickedButton8</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CMyRecationTabDlg* pRecationTab = <span class="keyword">new</span> CMyRecationTabDlg;</span><br><span class="line">	pRecationTab-&gt;Create(IDD_RELOCATIONTAB,<span class="keyword">this</span>);</span><br><span class="line">	pRecationTab-&gt;ShowWindow(SW_SHOW);</span><br><span class="line">	pRecationTab-&gt;ShowReTab(m_pReLocaTionDir,m_Filebuff);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="初始化-3"><a href="#初始化-3" class="headerlink" title="初始化"></a>初始化</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化重定位表列表框，并获取文件基址</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyRecationTabDlg::ShowReTab</span><span class="params">(PIMAGE_DATA_DIRECTORY pReLocaTionDir,<span class="keyword">char</span>* Filebuff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_FilePath = Filebuff;</span><br><span class="line">	m_pReLocaTionDir = pReLocaTionDir;</span><br><span class="line">	<span class="comment">//初始化列表框LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES | LVS_EX_CHECKBOXES</span></span><br><span class="line">	m_objQuDuan.SetExtendedStyle(LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES);<span class="comment">//更改风格</span></span><br><span class="line">	m_objKuai.SetExtendedStyle(LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES);<span class="comment">//更改风格</span></span><br><span class="line">	<span class="comment">// 添加列</span></span><br><span class="line">	m_objQuDuan.InsertColumn(<span class="number">0</span>, <span class="string">L&quot;Index&quot;</span>, <span class="number">0</span>, <span class="number">50</span>);</span><br><span class="line">	m_objQuDuan.InsertColumn(<span class="number">1</span>, <span class="string">L&quot;Section&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objQuDuan.InsertColumn(<span class="number">2</span>, <span class="string">L&quot;RVA&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objQuDuan.InsertColumn(<span class="number">3</span>, <span class="string">L&quot;Item&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">	m_objKuai.InsertColumn(<span class="number">0</span>, <span class="string">L&quot;Index&quot;</span>, <span class="number">0</span>, <span class="number">50</span>);</span><br><span class="line">	m_objKuai.InsertColumn(<span class="number">1</span>, <span class="string">L&quot;RVA&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objKuai.InsertColumn(<span class="number">2</span>, <span class="string">L&quot;Offset&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objKuai.InsertColumn(<span class="number">3</span>, <span class="string">L&quot;Type&quot;</span>, <span class="number">0</span>, <span class="number">50</span>);</span><br><span class="line">	m_objKuai.InsertColumn(<span class="number">4</span>, <span class="string">L&quot;Far Address&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objKuai.InsertColumn(<span class="number">5</span>, <span class="string">L&quot;Data Interpretation&quot;</span>, <span class="number">0</span>, <span class="number">200</span>);</span><br><span class="line">	EnumRecationTabQuduan();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="区段"><a href="#区段" class="headerlink" title="区段"></a>区段</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//显示重定位表 区段</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyRecationTabDlg::EnumRecationTabQuduan</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)m_FilePath;</span><br><span class="line">	PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + m_FilePath);</span><br><span class="line">	<span class="comment">//Nt头下一个头文件就是区段头</span></span><br><span class="line">	PIMAGE_SECTION_HEADER pQuHead = IMAGE_FIRST_SECTION(pNt);</span><br><span class="line">	<span class="comment">//扩展头是nt头的第三个数据</span></span><br><span class="line">	PIMAGE_OPTIONAL_HEADER pOption = (PIMAGE_OPTIONAL_HEADER)&amp;pNt-&gt;OptionalHeader;</span><br><span class="line">	<span class="comment">//文件头是nt头的第二个数据</span></span><br><span class="line">	PIMAGE_FILE_HEADER pFileHead = (PIMAGE_FILE_HEADER)&amp;pNt-&gt;FileHeader;</span><br><span class="line">	<span class="comment">//重定位表是扩展头最后一个数据字段（目录表）中的下表为5的字段数据</span></span><br><span class="line">	PIMAGE_BASE_RELOCATION pDataDir = (PIMAGE_BASE_RELOCATION)&amp;pOption-&gt;DataDirectory[<span class="number">5</span>];</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//PIMAGE_BASE_RELOCATION pReloc =</span></span><br><span class="line">	<span class="comment">//	(PIMAGE_BASE_RELOCATION)</span></span><br><span class="line">	<span class="comment">//	(RvaToFoa(m_FilePath, pDataDir-&gt;VirtualAddress) + m_FilePath);</span></span><br><span class="line"></span><br><span class="line">	DWORD dwBeginRva = <span class="number">0x10000</span>;</span><br><span class="line">	<span class="comment">//2 循环判断RVA落在了哪个区段中</span></span><br><span class="line">		<span class="comment">//文件头的NumberOfSections字段表示区段头的数量</span></span><br><span class="line">	<span class="keyword">int</span> nNum = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pNt-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		DWORD dwSectionRva = pQuHead[i].VirtualAddress;</span><br><span class="line">		DWORD dwSectionEndRva = dwSectionRva + pQuHead[i].SizeOfRawData;</span><br><span class="line">		DWORD dwSectionFOA = pQuHead[i].PointerToRawData;</span><br><span class="line">		<span class="keyword">if</span> (dwBeginRva &lt; dwSectionRva)</span><br><span class="line">		&#123;</span><br><span class="line">			dwBeginRva = dwSectionRva;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span> (dwBeginRva &gt;= dwSectionRva &amp;&amp; dwBeginRva &lt;= dwSectionEndRva)</span><br><span class="line">		&#123;</span><br><span class="line">			CString cs;</span><br><span class="line">			<span class="comment">//序号</span></span><br><span class="line">			cs.Format(<span class="string">L&quot;%d&quot;</span>, nNum);</span><br><span class="line">			m_objQuDuan.InsertItem(nNum, cs);</span><br><span class="line">			<span class="comment">//区段名</span></span><br><span class="line">			cs.Format(<span class="string">L&quot;%S&quot;</span>, pQuHead[i].Name);</span><br><span class="line">			m_objQuDuan.SetItemText(nNum, <span class="number">1</span>, cs);</span><br><span class="line">			<span class="comment">//RVA</span></span><br><span class="line">			cs.Format(<span class="string">L&quot;%08x&quot;</span>, dwBeginRva);</span><br><span class="line">			m_objQuDuan.SetItemText(nNum, <span class="number">2</span>, cs);</span><br><span class="line">			<span class="comment">//Item</span></span><br><span class="line">			DWORD dwCount = ((pDataDir-&gt;SizeOfBlock - <span class="number">8</span>) / <span class="number">2</span>);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%04x&quot;</span>, dwCount);</span><br><span class="line">			m_objQuDuan.SetItemText(nNum, <span class="number">3</span>, cs);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			m_vecRva.push_back(dwBeginRva);</span><br><span class="line">			dwBeginRva += <span class="number">0x1000</span>;</span><br><span class="line">			nNum++;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="块"><a href="#块" class="headerlink" title="块"></a>块</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//显示重定位表 块项目</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyRecationTabDlg::EnumRecationTabKuai</span><span class="params">(DWORD dwRVA,DWORD dwClistItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_objKuai.DeleteAllItems();</span><br><span class="line">	<span class="keyword">int</span> Const = <span class="number">0</span>;</span><br><span class="line">	CString Temp;</span><br><span class="line">	<span class="comment">//重定位表</span></span><br><span class="line">	PIMAGE_BASE_RELOCATION pReloc = (PIMAGE_BASE_RELOCATION)(RvaToFoa(m_FilePath, m_pReLocaTionDir-&gt;VirtualAddress) + m_FilePath);</span><br><span class="line">	<span class="comment">//3. 开始解析重定位</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//1 获取区段表的起始位置</span></span><br><span class="line">	<span class="comment">//Dos头</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)m_FilePath;</span><br><span class="line">	<span class="comment">//Nt头</span></span><br><span class="line">	PIMAGE_NT_HEADERS pNt = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + m_FilePath);</span><br><span class="line">	<span class="comment">//区段头</span></span><br><span class="line">	PIMAGE_SECTION_HEADER pHeader = IMAGE_FIRST_SECTION(pNt);</span><br><span class="line">	<span class="comment">//扩展头</span></span><br><span class="line">	PIMAGE_OPTIONAL_HEADER pOption = &amp;pNt-&gt;OptionalHeader;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//如果重定位表有数据（SizeOfBlock这个字段表示重定位表的结构大小）</span></span><br><span class="line">	<span class="keyword">while</span> (pReloc-&gt;SizeOfBlock != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//得到描述每一个位置偏移的数组</span></span><br><span class="line">		<span class="comment">//重定位表+1表示第一个数据</span></span><br><span class="line">		TYPEOFFSET* typeoffset = (TYPEOFFSET*)(pReloc + <span class="number">1</span>);</span><br><span class="line">		<span class="comment">//重定位结构体大小减去8后除以2就等于重定位地址的数量</span></span><br><span class="line">		DWORD dwCount = (pReloc-&gt;SizeOfBlock - <span class="number">8</span>) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">		DWORD dwBeginRva = pReloc-&gt;VirtualAddress;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (pReloc-&gt;SizeOfBlock != <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//得到描述每一个位置偏移的数组</span></span><br><span class="line">			TYPEOFFSET* typeoffset = (TYPEOFFSET*)(pReloc + <span class="number">1</span>);</span><br><span class="line">			DWORD dwCount = (pReloc-&gt;SizeOfBlock - <span class="number">8</span>) / <span class="number">2</span>;</span><br><span class="line">			DWORD dwBeginRva = pReloc-&gt;VirtualAddress;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//dwBeginRva *= dwClistItem + 1;</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; dwCount; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (typeoffset[i].TYPE == <span class="number">3</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					DWORD dwRelocRva = (dwRVA + typeoffset[i].OFFSET);</span><br><span class="line">					<span class="keyword">if</span> (m_vecRva.size() &gt; <span class="number">1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">if</span> (dwRelocRva &gt;= m_vecRva[dwClistItem] &amp;&amp; dwRelocRva &lt; m_vecRva[dwClistItem + <span class="number">1</span>])</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="comment">//序号</span></span><br><span class="line">							Temp.Format(<span class="string">L&quot;%d&quot;</span>, i);</span><br><span class="line">							m_objKuai.InsertItem(i, Temp);</span><br><span class="line">							<span class="comment">//RVA</span></span><br><span class="line">							Temp.Format(<span class="string">L&quot;%08x&quot;</span>, dwRelocRva);</span><br><span class="line">							m_objKuai.SetItemText(i, <span class="number">1</span>, Temp);</span><br><span class="line">							<span class="comment">//printf(&quot;要重定位的位置RVA：%p\n&quot;, dwRelocRva);</span></span><br><span class="line">							<span class="comment">//RVA对应的数据</span></span><br><span class="line">							<span class="comment">//类型</span></span><br><span class="line">							Temp.Format(<span class="string">L&quot;%02x&quot;</span>, typeoffset[i].TYPE);</span><br><span class="line">							m_objKuai.SetItemText(i, <span class="number">3</span>, Temp);</span><br><span class="line"></span><br><span class="line">							PDWORD offset = (PDWORD)RvaToFoa(m_FilePath, dwRelocRva);</span><br><span class="line">							Temp.Format(<span class="string">L&quot;%08x&quot;</span>, offset);</span><br><span class="line">							m_objKuai.SetItemText(i, <span class="number">2</span>, Temp);</span><br><span class="line">							PDWORD pRelocData = (PDWORD)(RvaToFoa(m_FilePath, dwRelocRva) + m_FilePath);</span><br><span class="line">							Temp.Format(<span class="string">L&quot;%08x&quot;</span>, pRelocData);</span><br><span class="line">							m_objKuai.SetItemText(i, <span class="number">4</span>, Temp);</span><br><span class="line">							<span class="comment">//printf(&quot;要重定位的数据：%p\n&quot;, *pRelocData);</span></span><br><span class="line"></span><br><span class="line">							<span class="keyword">unsigned</span> <span class="keyword">char</span>* pRec = (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)</span><br><span class="line">								(RvaToFoa(m_FilePath, *pRelocData) + m_FilePath);</span><br><span class="line">							Temp = <span class="string">L&quot;&quot;</span>;</span><br><span class="line">							<span class="keyword">for</span> (<span class="keyword">size_t</span> m = <span class="number">0</span>; m &lt; <span class="number">20</span>; m++)</span><br><span class="line">							&#123;</span><br><span class="line">								Temp += pRec[m];</span><br><span class="line">							&#125;</span><br><span class="line">							m_objKuai.SetItemText(i, <span class="number">5</span>, Temp);</span><br><span class="line">						&#125;</span><br><span class="line">	</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line"></span><br><span class="line">						Temp.Format(<span class="string">L&quot;%d&quot;</span>, i);</span><br><span class="line">						m_objKuai.InsertItem(i, Temp);</span><br><span class="line">						<span class="comment">//RVA</span></span><br><span class="line">						Temp.Format(<span class="string">L&quot;%08x&quot;</span>, dwRelocRva);</span><br><span class="line">						m_objKuai.SetItemText(i, <span class="number">1</span>, Temp);</span><br><span class="line">						<span class="comment">//printf(&quot;要重定位的位置RVA：%p\n&quot;, dwRelocRva);</span></span><br><span class="line">						<span class="comment">//RVA对应的数据</span></span><br><span class="line">						<span class="comment">//类型</span></span><br><span class="line">						Temp.Format(<span class="string">L&quot;%02x&quot;</span>, typeoffset[i].TYPE);</span><br><span class="line">						m_objKuai.SetItemText(i, <span class="number">3</span>, Temp);</span><br><span class="line"></span><br><span class="line">						PDWORD offset = (PDWORD)RvaToFoa(m_FilePath, dwRelocRva);</span><br><span class="line">						Temp.Format(<span class="string">L&quot;%08x&quot;</span>, offset);</span><br><span class="line">						m_objKuai.SetItemText(i, <span class="number">2</span>, Temp);</span><br><span class="line">						PDWORD pRelocData = (PDWORD)(RvaToFoa(m_FilePath, dwRelocRva) + m_FilePath);</span><br><span class="line">						Temp.Format(<span class="string">L&quot;%08x&quot;</span>, pRelocData);</span><br><span class="line">						m_objKuai.SetItemText(i, <span class="number">4</span>, Temp);</span><br><span class="line">						<span class="comment">//printf(&quot;要重定位的数据：%p\n&quot;, *pRelocData);</span></span><br><span class="line"></span><br><span class="line">						<span class="keyword">unsigned</span> <span class="keyword">char</span>* pRec = (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)</span><br><span class="line">							(RvaToFoa(m_FilePath, *pRelocData) + m_FilePath);</span><br><span class="line">						Temp = <span class="string">L&quot;&quot;</span>;</span><br><span class="line">						<span class="keyword">for</span> (<span class="keyword">size_t</span> m = <span class="number">0</span>; m &lt; <span class="number">20</span>; m++)</span><br><span class="line">						&#123;</span><br><span class="line">							Temp += pRec[m];</span><br><span class="line">						&#125;</span><br><span class="line">						m_objKuai.SetItemText(i, <span class="number">5</span>, Temp);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="点击区段响应块"><a href="#点击区段响应块" class="headerlink" title="点击区段响应块"></a>点击区段响应块</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点击区段列表响应</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyRecationTabDlg::OnClickList1</span><span class="params">(NMHDR* pNMHDR, LRESULT* pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LPNMITEMACTIVATE pNMItemActivate = <span class="keyword">reinterpret_cast</span>&lt;LPNMITEMACTIVATE&gt;(pNMHDR);</span><br><span class="line">	</span><br><span class="line">	m_objKuai.DeleteAllItems();</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	CString RVA =  m_objQuDuan.GetItemText(pNMItemActivate-&gt;iItem, <span class="number">2</span>);</span><br><span class="line">	 DWORD dwVa = _tcstoul(RVA, <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">	 EnumRecationTabKuai(dwVa, pNMItemActivate-&gt;iItem);</span><br><span class="line">	*pResult = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="TLS表"><a href="#TLS表" class="headerlink" title="TLS表"></a>TLS表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TLS表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyDirTabDlg::OnBnClickedButton12</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CMyTlsTabDlg* pTlsTab = <span class="keyword">new</span> CMyTlsTabDlg;</span><br><span class="line">	pTlsTab-&gt;Create(IDD_TLSTAB,<span class="keyword">this</span>);</span><br><span class="line">	pTlsTab-&gt;ShowWindow(SW_SHOW);</span><br><span class="line">	pTlsTab-&gt;GetInfo(m_pTlsTab,m_Filebuff);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="TLS表的输出"><a href="#TLS表的输出" class="headerlink" title="TLS表的输出"></a>TLS表的输出</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyTlsTabDlg::GetInfo</span><span class="params">(PIMAGE_DATA_DIRECTORY m_pTlsTab, <span class="keyword">char</span>* m_Filebuff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD dwLtsFOA = RvaToFoa(m_pTlsTab-&gt;VirtualAddress, m_Filebuff);</span><br><span class="line">	PIMAGE_TLS_DIRECTORY32 pTls = (PIMAGE_TLS_DIRECTORY32)(dwLtsFOA + m_Filebuff);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	CString cs;</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pTls-&gt;StartAddressOfRawData);</span><br><span class="line">	m_strEdit1.SetString(cs);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pTls-&gt;EndAddressOfRawData);</span><br><span class="line">	m_strEdit2.SetString(cs);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pTls-&gt;AddressOfIndex);</span><br><span class="line">	m_strEdit3.SetString(cs);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pTls-&gt;AddressOfCallBacks);</span><br><span class="line">	m_strEdit4.SetString(cs);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pTls-&gt;SizeOfZeroFill);</span><br><span class="line">	m_strEdit5.SetString(cs);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pTls-&gt;Characteristics);</span><br><span class="line">	m_strEdit6.SetString(cs);</span><br><span class="line"></span><br><span class="line">	UpdateData(FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="延迟输入表"><a href="#延迟输入表" class="headerlink" title="延迟输入表"></a>延迟输入表</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//延迟输入表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyDirTabDlg::OnBnClickedButton16</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m_dwYanchiSize == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(<span class="string">L&quot;延迟表为空&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	CMyUnloadTabDlg* pUnloadTab = <span class="keyword">new</span> CMyUnloadTabDlg;</span><br><span class="line">	pUnloadTab-&gt;Create(IDD_DECSRIPTORTAB, <span class="keyword">this</span>);</span><br><span class="line">	pUnloadTab-&gt;ShowWindow(SW_SHOW);</span><br><span class="line">	pUnloadTab-&gt;GetUnloadTabInfo(m_pUnloadTab, m_Filebuff);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="延迟输入表的输出"><a href="#延迟输入表的输出" class="headerlink" title="延迟输入表的输出"></a>延迟输入表的输出</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyUnloadTabDlg::GetUnloadTabInfo</span><span class="params">(PIMAGE_DATA_DIRECTORY m_pUnloadTab, <span class="keyword">char</span>* m_Filebuff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD pUnloadFov = RvaToFoa((DWORD)(m_pUnloadTab-&gt;VirtualAddress), m_Filebuff);</span><br><span class="line">	PIMAGE_DELAYLOAD_DESCRIPTOR pUnload = (PIMAGE_DELAYLOAD_DESCRIPTOR)(pUnloadFov + m_Filebuff);</span><br><span class="line">	CString cs;</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pUnload-&gt;DllNameRVA);</span><br><span class="line">	m_strEdit1.SetString(cs);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pUnload-&gt;ModuleHandleRVA);</span><br><span class="line">	m_strEdit2.SetString(cs);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pUnload-&gt;ImportAddressTableRVA);</span><br><span class="line">	m_strEdit3.SetString(cs);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pUnload-&gt;ImportNameTableRVA);</span><br><span class="line">	m_strEdit4.SetString(cs);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pUnload-&gt;BoundImportAddressTableRVA);</span><br><span class="line">	m_strEdit5.SetString(cs);</span><br><span class="line">	cs.Format(<span class="string">L&quot;%08x&quot;</span>, pUnload-&gt;UnloadInformationTableRVA);</span><br><span class="line">	m_strEdit6.SetString(cs);</span><br><span class="line">	UpdateData(FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="区段表"><a href="#区段表" class="headerlink" title="区段表"></a>区段表</h2><h3 id="初始化-4"><a href="#初始化-4" class="headerlink" title="初始化"></a>初始化</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化区段表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyQuDuanDlg::InitQuDuanTable</span><span class="params">(<span class="keyword">char</span>* buff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_objQuDuanList.SetExtendedStyle(LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES);<span class="comment">//更改风格</span></span><br><span class="line">	<span class="comment">// 添加列</span></span><br><span class="line">	m_objQuDuanList.InsertColumn(<span class="number">0</span>, <span class="string">L&quot;名称&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objQuDuanList.InsertColumn(<span class="number">1</span>, <span class="string">L&quot;相对偏移&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objQuDuanList.InsertColumn(<span class="number">2</span>, <span class="string">L&quot;区段大小&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objQuDuanList.InsertColumn(<span class="number">3</span>, <span class="string">L&quot;文件偏移&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objQuDuanList.InsertColumn(<span class="number">4</span>, <span class="string">L&quot;区段文件大小&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	m_objQuDuanList.InsertColumn(<span class="number">5</span>, <span class="string">L&quot;标志&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">	AnalyzeQuDuan(buff);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解析与输出"><a href="#解析与输出" class="headerlink" title="解析与输出"></a>解析与输出</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解析区段表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyQuDuanDlg::AnalyzeQuDuan</span><span class="params">(<span class="keyword">char</span>* buff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)buff;</span><br><span class="line">	PIMAGE_NT_HEADERS pNtHead = (PIMAGE_NT_HEADERS)(pDos-&gt;e_lfanew + buff);</span><br><span class="line">	PIMAGE_FILE_HEADER FileHead  = (PIMAGE_FILE_HEADER)(&amp;pNtHead-&gt;FileHeader);</span><br><span class="line">	PIMAGE_SECTION_HEADER pQuDuan = IMAGE_FIRST_SECTION(pNtHead);</span><br><span class="line">	CString cs;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i&lt; FileHead-&gt;NumberOfSections; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//区段名</span></span><br><span class="line">		cs.Format(<span class="string">L&quot;%S&quot;</span>, pQuDuan[i].Name);</span><br><span class="line">		m_objQuDuanList.InsertItem(i, cs);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//相对偏移</span></span><br><span class="line">		cs.Format(<span class="string">L&quot;%p&quot;</span>, pQuDuan[i].VirtualAddress);</span><br><span class="line">		m_objQuDuanList.SetItemText(i,<span class="number">1</span>, cs);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//区段大小</span></span><br><span class="line">		cs.Format(<span class="string">L&quot;%p&quot;</span>, pQuDuan[i].Misc);</span><br><span class="line">		m_objQuDuanList.SetItemText(i,<span class="number">2</span>, cs);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//文件偏移</span></span><br><span class="line">		cs.Format(<span class="string">L&quot;%p&quot;</span>, pQuDuan[i].PointerToRawData);</span><br><span class="line">		m_objQuDuanList.SetItemText(i,<span class="number">3</span>, cs);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//区段文件大小</span></span><br><span class="line">		cs.Format(<span class="string">L&quot;%p&quot;</span>, pQuDuan[i].SizeOfRawData);</span><br><span class="line">		m_objQuDuanList.SetItemText(i,<span class="number">4</span>, cs);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//标志</span></span><br><span class="line">		cs.Format(<span class="string">L&quot;%p&quot;</span>, pQuDuan[i].Characteristics);</span><br><span class="line">		m_objQuDuanList.SetItemText(i,<span class="number">5</span>, cs);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="查杀"><a href="#查杀" class="headerlink" title="查杀"></a>查杀</h1><h2 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a>MD5</h2><h3 id="启动MD5查杀"><a href="#启动MD5查杀" class="headerlink" title="启动MD5查杀"></a>启动MD5查杀</h3><p>#include &lt;openssl/md5.h&gt;<br>#pragma comment(lib,”res/libcrypto.lib”)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MD5按钮</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyAntivirusDlg::OnBnClickedButton1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//m_strFilePath = L&quot;&quot;;</span></span><br><span class="line">	UpdateData(TRUE);</span><br><span class="line">	<span class="keyword">if</span> (m_strFilePath==<span class="string">L&quot;&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(<span class="string">L&quot;请先输入文件路径&quot;</span>,<span class="string">L&quot;提示！&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m_objOutList.DeleteAllItems();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//打开文件属性</span></span><br><span class="line">	WIN32_FIND_DATA fileData = &#123;&#125;;</span><br><span class="line">	HANDLE hFile = FindFirstFile(m_strFilePath, &amp;fileData);</span><br><span class="line">	<span class="keyword">if</span> (!(fileData.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY))</span><br><span class="line">	&#123;</span><br><span class="line">		MD5_First();</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//显示进度条</span></span><br><span class="line">	m_objProcessT.ShowWindow(SW_SHOW);</span><br><span class="line">	m_strTishiText.SetString(<span class="string">L&quot;查杀中...&quot;</span>);</span><br><span class="line">	UpdateData(FALSE);</span><br><span class="line">	m_objTishiText.ShowWindow(SW_SHOW);</span><br><span class="line">	<span class="comment">// 创建线程</span></span><br><span class="line">	Thread = CreateThread(</span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 线程的安全属性</span></span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 默认栈的大小(局部变量、参数、返回地址)</span></span><br><span class="line">		(LPTHREAD_START_ROUTINE)MD5_CallBack,	<span class="comment">// 线程代码的起始位置</span></span><br><span class="line">		<span class="keyword">this</span>,	<span class="comment">// 线程函数的参数，如果传递的是地址，那么需要保证这块内存地址的生命周期（不能是局部变量）</span></span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 创建标志</span></span><br><span class="line">		<span class="literal">NULL</span>);			<span class="comment">// 传出的线程ID</span></span><br><span class="line"></span><br><span class="line">	HANDLE ThreadT = CreateThread(</span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 线程的安全属性</span></span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 默认栈的大小(局部变量、参数、返回地址)</span></span><br><span class="line">		(LPTHREAD_START_ROUTINE)Process,	<span class="comment">// 线程代码的起始位置</span></span><br><span class="line">		<span class="keyword">this</span>,	<span class="comment">// 线程函数的参数，如果传递的是地址，那么需要保证这块内存地址的生命周期（不能是局部变量）</span></span><br><span class="line">		<span class="literal">NULL</span>,			<span class="comment">// 创建标志</span></span><br><span class="line">		<span class="literal">NULL</span>);			<span class="comment">// 传出的线程ID</span></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MD5—CallBack回调"><a href="#MD5—CallBack回调" class="headerlink" title="MD5—CallBack回调"></a>MD5—CallBack回调</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MD5计算回调函数</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">MD5_CallBack</span><span class="params">(LPARAM lparam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CMyAntivirusDlg* pObj = (CMyAntivirusDlg*)lparam;</span><br><span class="line">	pObj-&gt;GetFilePath(pObj-&gt;m_strFilePath);</span><br><span class="line">	pObj-&gt;MD5_ANT(<span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取需要查杀的目录及文件"><a href="#获取需要查杀的目录及文件" class="headerlink" title="获取需要查杀的目录及文件"></a>获取需要查杀的目录及文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件遍历</span></span><br><span class="line"><span class="function">CString <span class="title">CMyAntivirusDlg::GetFilePath</span><span class="params">(CString FilePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CString strTemp;</span><br><span class="line">	CString strReturn = <span class="string">L&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 拼接完整路径</span></span><br><span class="line">	CString fullPath = FilePath + <span class="string">L&quot;\\*&quot;</span>;</span><br><span class="line">	<span class="comment">// 查找第一个文件</span></span><br><span class="line">	WIN32_FIND_DATA fileData = &#123;&#125;;</span><br><span class="line">	HANDLE hFile = FindFirstFile(fullPath, &amp;fileData);</span><br><span class="line">	<span class="keyword">if</span> (hFile != INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// 输出文件的信息，</span></span><br><span class="line">			<span class="comment">// 过滤两个文件夹……</span></span><br><span class="line">			<span class="keyword">if</span> (wcscmp(fileData.cFileName, <span class="string">L&quot;.&quot;</span>) == <span class="number">0</span> ||</span><br><span class="line">				wcscmp(fileData.cFileName, <span class="string">L&quot;..&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 如果找到的是目录，递归遍历目录中的其他文件</span></span><br><span class="line">			<span class="keyword">if</span> (fileData.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY)</span><br><span class="line">			&#123;</span><br><span class="line">				GetFilePath(FilePath + <span class="string">L&quot;\\&quot;</span> + fileData.cFileName);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">				CString csPath;<span class="comment">//保存路径到vector中</span></span><br><span class="line">				csPath.Format(<span class="string">L&quot;%s\\%s&quot;</span>, FilePath, fileData.cFileName);</span><br><span class="line">				vecPath.push_back(csPath);<span class="comment">//将路径加入vector</span></span><br><span class="line">				m_objOutList.InsertItem(i, fileData.cFileName);</span><br><span class="line"></span><br><span class="line">			i++;</span><br><span class="line">			<span class="comment">// 继续遍历下一个文件</span></span><br><span class="line">		&#125; <span class="keyword">while</span> (FindNextFile(hFile, &amp;fileData));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> strReturn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="验证MD5值"><a href="#验证MD5值" class="headerlink" title="验证MD5值"></a>验证MD5值</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MD5校验</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyAntivirusDlg::MD5_ANT</span><span class="params">(BOOL b = <span class="literal">true</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CString cs;</span><br><span class="line">	<span class="keyword">if</span> (vecPath.size() != <span class="number">0</span>)</span><br><span class="line">	&#123;		</span><br><span class="line">		<span class="comment">//打开存储在文件中的md5值</span></span><br><span class="line">		HANDLE hFile = CreateFile(<span class="string">L&quot;res\\MD5.txt&quot;</span>, GENERIC_READ, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="comment">//定义缓冲去</span></span><br><span class="line">		<span class="keyword">char</span> md5[<span class="number">100</span>] = &#123;&#125;;</span><br><span class="line">		DWORD dwRead;</span><br><span class="line">		<span class="comment">//读取文件内容到缓冲区</span></span><br><span class="line">		ReadFile(hFile, md5, <span class="number">100</span>, &amp;dwRead, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//定义缓冲区</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> hex[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; vecPath.size(); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			m_objOutList.SetItemText(i,<span class="number">4</span>,vecPath[i]);</span><br><span class="line">			<span class="comment">//计算md5值</span></span><br><span class="line">			<span class="comment">//_bstr_t b(vecPath[i]);</span></span><br><span class="line">			HANDLE hFilePath = CreateFile(vecPath[i], GENERIC_READ, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);		</span><br><span class="line">			DWORD FileSize=GetFileSize(hFilePath,<span class="literal">NULL</span>);</span><br><span class="line">			DWORD dwReadPath;</span><br><span class="line">			<span class="keyword">char</span>* md5Path = <span class="keyword">new</span> <span class="keyword">char</span>[FileSize];</span><br><span class="line">			ReadFile(hFilePath, md5Path, FileSize, &amp;dwReadPath, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">			md5_Value(md5Path, FileSize,hex);</span><br><span class="line">			<span class="comment">//换算成大端16进制</span></span><br><span class="line">			show_hex(<span class="string">&quot;md5: &quot;</span>, hex, <span class="number">16</span>);</span><br><span class="line">			cs.Format(<span class="string">L&quot;%S&quot;</span>, md5);</span><br><span class="line">			vecMd5.push_back(m_chex);</span><br><span class="line">			m_objOutList.SetItemText(i,<span class="number">1</span>, m_chex);</span><br><span class="line">			<span class="keyword">if</span>(b)<span class="comment">//如果是云查杀就不输出库MD5</span></span><br><span class="line">			m_objOutList.SetItemText(i, <span class="number">2</span>, cs);</span><br><span class="line">			<span class="comment">//比较文件MD5值是否相等</span></span><br><span class="line">			<span class="keyword">if</span> (!(wcscmp(cs, m_chex)))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(b)</span><br><span class="line">				m_objOutList.SetItemText(i, <span class="number">3</span>,<span class="string">L&quot;是&quot;</span>);</span><br><span class="line">				BinDuFile.push_back(vecPath[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (b)</span><br><span class="line">				m_objOutList.SetItemText(i, <span class="number">3</span>, <span class="string">L&quot;否&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(hex); i++)</span><br><span class="line">			&#123;</span><br><span class="line">				hex[i] = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			CloseHandle(hFilePath);</span><br><span class="line">			<span class="keyword">delete</span> md5Path;</span><br><span class="line">		&#125;		</span><br><span class="line">		CloseHandle(hFile);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="验证MD5所用的函数"><a href="#验证MD5所用的函数" class="headerlink" title="验证MD5所用的函数"></a>验证MD5所用的函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算md5</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CMyAntivirusDlg::md5_Value</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* data, <span class="keyword">size_t</span> len, <span class="keyword">unsigned</span> <span class="keyword">char</span>* md5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 初始化保存 md5 信息的结构体</span></span><br><span class="line">	MD5_CTX ctx = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	MD5_Init(&amp;ctx);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将需要计算的数据传入到对应的结构中</span></span><br><span class="line">	MD5_Update(&amp;ctx, data, len);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从结构中获取计算后的结果</span></span><br><span class="line">	MD5_Final(md5, &amp;ctx);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//转换为大端16进制</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyAntivirusDlg::show_hex</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* n, <span class="keyword">unsigned</span> <span class="keyword">char</span>* hex, <span class="keyword">size_t</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CString cs;</span><br><span class="line">	m_chex = <span class="string">L&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		cs.Format(<span class="string">L&quot;%2X&quot;</span>, hex[i]);</span><br><span class="line">		m_chex += cs;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="异常文件的删除"><a href="#异常文件的删除" class="headerlink" title="异常文件的删除"></a>异常文件的删除</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断MD5值结构异常的文件处理</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyAntivirusDlg::FileDelete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!(BinDuFile.size() == <span class="number">0</span>))</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; BinDuFile.size(); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//shDelFile.fFlags |= FOF_ALLOWUNDO; //删除到回收</span></span><br><span class="line">			DeleteFile(BinDuFile[i]);</span><br><span class="line">		&#125;	</span><br><span class="line">		MessageBox(<span class="string">L&quot;删除成功&quot;</span>,<span class="string">L&quot;提示&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(<span class="string">L&quot;没有找到病毒文件&quot;</span>,<span class="string">L&quot;提示&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="云端查杀"><a href="#云端查杀" class="headerlink" title="云端查杀"></a>云端查杀</h2><h3 id="开启线程"><a href="#开启线程" class="headerlink" title="开启线程"></a>开启线程</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//网络客户端回调函数</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">Cilent</span><span class="params">(LPARAM lparam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CMyAntivirusDlg* pObj = (CMyAntivirusDlg*)lparam;</span><br><span class="line">	pObj-&gt;GetClienObj();<span class="comment">//调用</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="调用本地的文件遍历及MD5计算及启动客户端"><a href="#调用本地的文件遍历及MD5计算及启动客户端" class="headerlink" title="调用本地的文件遍历及MD5计算及启动客户端"></a>调用本地的文件遍历及MD5计算及启动客户端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取网络客户端对象并调用客户端入口</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMyAntivirusDlg::GetClienObj</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GetFilePath(filePath);</span><br><span class="line">	MD5_ANT(<span class="literal">false</span>);</span><br><span class="line">	NetWorkClient obj;</span><br><span class="line">	</span><br><span class="line">	obj.NetWorkClientMain(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>包含所需的文件</p>
<p>#include &lt;WinSock2.h&gt;</p>
<p>#include &lt;ws2tcpip.h&gt;</p>
<p>#pragma comment(lib, “ws2_32.lib”)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NetWorkClient::NetWorkClientMain</span><span class="params">(LPVOID obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CMyAntivirusDlg* pObj = (CMyAntivirusDlg*)obj;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//SendMessage(UM_MYMESSAGE,1,2);</span></span><br><span class="line">	<span class="comment">// 1. 初始化套接字模块，必须是网络程序中第一个调用的函数(搜索信号)</span></span><br><span class="line">	WSADATA wsadata = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">int</span> result = WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsadata);</span><br><span class="line">	check_result(!result &amp;&amp; wsadata.wVersion == <span class="number">0x0202</span>, <span class="string">&quot;套接字环境初始化失败!&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 创建一个套接字，应该保存[IP:PORT](买一部手机)</span></span><br><span class="line">	<span class="comment">//	参数分别是使用的协议种类，数据传输方式以及协议类型</span></span><br><span class="line">	SOCKET client = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">	check_result(client != INVALID_SOCKET, <span class="string">&quot;套接字创建失败!&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 将套接字绑定到指定的 ip 地址和端口(安装手机卡)</span></span><br><span class="line">	SOCKADDR_IN server_addr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	server_addr.sin_family = AF_INET;		<span class="comment">// 协议</span></span><br><span class="line">	server_addr.sin_port = htons(<span class="number">0x1515</span>);	<span class="comment">// 端口</span></span><br><span class="line">	inet_pton(AF_INET, <span class="string">&quot;127.0.0.1&quot;</span>, &amp;server_addr.sin_addr);</span><br><span class="line">	result = connect(client, (SOCKADDR*)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">	check_result(result != SOCKET_ERROR, <span class="string">&quot;套接字连接失败!&quot;</span>);</span><br><span class="line"></span><br><span class="line">	CString cs;</span><br><span class="line">	pObj-&gt;m_objAccept.ShowWindow(SW_SHOW);</span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;		</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">0</span> ; i&lt;vecMd5.size();i++)</span><br><span class="line">		&#123;			</span><br><span class="line">			<span class="keyword">if</span> ((i + <span class="number">1</span>) == vecMd5.size())</span><br><span class="line">			&#123;</span><br><span class="line">				send(client, <span class="string">&quot;T&quot;</span>, <span class="number">1</span>, <span class="number">0</span>);<span class="comment">//发送完成后发送T表示结束了</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">				</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">_bstr_t</span> <span class="title">b</span><span class="params">(vecMd5[i])</span></span>;</span><br><span class="line">			send(client,b , <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">			recv(client, buff, <span class="number">100</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">strcmp</span>(buff, <span class="string">&quot;a&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				pObj-&gt;m_objOutList.SetItemText(i, <span class="number">3</span>, <span class="string">L&quot;否&quot;</span>);</span><br><span class="line">			</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(buff, <span class="string">&quot;b&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				pObj-&gt;m_objOutList.SetItemText(i, <span class="number">3</span>, <span class="string">L&quot;是&quot;</span>);</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 6. 当数据处理结束之后，需要断开连接</span></span><br><span class="line">	closesocket(client);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 7. 清理套接字模块坏境</span></span><br><span class="line">	WSACleanup();</span><br><span class="line"></span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查函数的执行结果是否正确</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NetWorkClient::check_result</span><span class="params">(<span class="keyword">bool</span> result, <span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 如果传入的表达式位假，意味着出错</span></span><br><span class="line">	<span class="keyword">if</span> (result == <span class="literal">false</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox((CString)msg);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;error: %s\n&quot;</span>, msg);</span><br><span class="line">		system(<span class="string">&quot;pause&quot;</span>); <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><h4 id="服务端入口"><a href="#服务端入口" class="headerlink" title="服务端入口"></a>服务端入口</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;NetWorkClient.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NetWorkClient obj;</span><br><span class="line">	obj.m_argc = argc;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(argv); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		obj.m_argv[i] = argv[i];</span><br><span class="line">	&#125;</span><br><span class="line">	obj.NetMain();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>.h文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;include/mysql.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;libmysql.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">vector</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NetWorkClient</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">NetMain</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">MysqlInit</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sql_insert</span><span class="params">(MYSQL* mysql, <span class="keyword">const</span> <span class="keyword">char</span>* sql)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sql_check_result</span><span class="params">(MYSQL* mysql)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sql_select</span><span class="params">(MYSQL* mysql, <span class="keyword">const</span> <span class="keyword">char</span>* sql, <span class="keyword">char</span>* filemd5)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">MysqlSelect</span><span class="params">(<span class="keyword">char</span>* Filemd5)</span></span>;</span><br><span class="line"></span><br><span class="line">	SOCKET client;</span><br><span class="line">	MYSQL mysql;</span><br><span class="line">	<span class="comment">//vector&lt;char*&gt;vecChar;</span></span><br><span class="line"><span class="keyword">public</span> :</span><br><span class="line">	<span class="keyword">int</span> m_argc;</span><br><span class="line">	<span class="keyword">char</span>* m_argv[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>.cpp文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0. 添加必要的头文件，并且链接到相应的静态库</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;NetWorkClient.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于保存当前连接到服务器的所有客户端</span></span><br><span class="line"><span class="built_in">map</span>&lt;SOCKET, <span class="built_in">string</span>&gt; clients;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查函数的执行结果是否正确</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">check_result</span><span class="params">(<span class="keyword">bool</span> result, <span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 如果传入的表达式位假，意味着出错</span></span><br><span class="line">	<span class="keyword">if</span> (result == <span class="literal">false</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;error: %s\n&quot;</span>, msg);</span><br><span class="line">		system(<span class="string">&quot;pause&quot;</span>); <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务器入口（套接字初始化）</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NetWorkClient::NetMain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 1. 初始化套接字模块，必须是网络程序中第一个调用的函数(搜索信号)</span></span><br><span class="line">	WSADATA wsadata = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">int</span> result = WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsadata);</span><br><span class="line">	check_result(!result &amp;&amp; wsadata.wVersion == <span class="number">0x0202</span>, <span class="string">&quot;套接字环境初始化失败!&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 创建一个套接字，应该保存[IP:PORT](买一部手机)</span></span><br><span class="line">	<span class="comment">//	参数分别是使用的协议种类，数据传输方式以及协议类型</span></span><br><span class="line">	SOCKET server = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">	check_result(server != INVALID_SOCKET, <span class="string">&quot;套接字创建失败!&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 将套接字绑定到指定的 ip 地址和端口(安装手机卡)</span></span><br><span class="line">	SOCKADDR_IN server_addr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	server_addr.sin_family = AF_INET;		<span class="comment">// 协议</span></span><br><span class="line">	server_addr.sin_port = htons(<span class="number">0x1515</span>);	<span class="comment">// 端口</span></span><br><span class="line">	inet_pton(AF_INET, <span class="string">&quot;127.0.0.1&quot;</span>, &amp;server_addr.sin_addr);</span><br><span class="line">	result = bind(server, (SOCKADDR*)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">	check_result(result != SOCKET_ERROR, <span class="string">&quot;套接字绑定失败!&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4. 开启套接字的监听状态，第二个参数是同一时刻可以等待的客户端数量(开机)</span></span><br><span class="line">	result = listen(server, SOMAXCONN);</span><br><span class="line">	check_result(result != SOCKET_ERROR, <span class="string">&quot;套接字监听失败!&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 5. 等待客户端的连接，返回值是连接到的客户端(等接电话)</span></span><br><span class="line">	<span class="keyword">int</span> size = <span class="keyword">sizeof</span>(SOCKADDR_IN);</span><br><span class="line">	SOCKADDR_IN client_addr = &#123; <span class="number">0</span> &#125;;		<span class="comment">// 用于接收客户端信息(来电显示)</span></span><br><span class="line">	client = accept(server, (SOCKADDR*)&amp;client_addr, &amp;size);</span><br><span class="line">	check_result(client != INVALID_SOCKET, <span class="string">&quot;客户端接收失败!&quot;</span>);</span><br><span class="line">	<span class="comment">//char buff[10] = &#123; 0 &#125;;</span></span><br><span class="line">	<span class="comment">//recv(client, buff, 10, 0);</span></span><br><span class="line">	MysqlInit(m_argc, m_argv);</span><br><span class="line">	<span class="keyword">int</span> T = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (T)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> nickname[<span class="number">0x100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">		</span><br><span class="line">		recv(client, nickname, <span class="number">0x100</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ((<span class="built_in">strcmp</span>(nickname, <span class="string">&quot;T&quot;</span>) == <span class="number">0</span>))<span class="comment">//如果客户端发过来的消息时T，就结束循环</span></span><br><span class="line">		&#123;</span><br><span class="line">			T = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		MysqlSelect(nickname);</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	mysql_library_end();</span><br><span class="line">	<span class="comment">// 8. 当数据处理结束之后，需要断开连接</span></span><br><span class="line">	closesocket(server);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 9. 清理套接字模块坏境</span></span><br><span class="line">	WSACleanup();</span><br><span class="line"></span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////SQL///////////////////////</span></span><br><span class="line"><span class="comment">//初始化mysql</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NetWorkClient::MysqlInit</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 1. 初始化 mysql 模块</span></span><br><span class="line">	mysql_library_init(argc, argv, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 创建一个 mysql 对象并初始化</span></span><br><span class="line">	mysql = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	mysql_init(&amp;mysql);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 通过指定的函数提供用户名密码和主机信息连接到数据库</span></span><br><span class="line">	mysql_real_connect(&amp;mysql, <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;root&quot;</span>,</span><br><span class="line">		<span class="string">&quot;123456&quot;</span>, <span class="string">&quot;md5_value&quot;</span>, <span class="number">3306</span>, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">	sql_check_result(&amp;mysql);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置字符编码为 GB2312</span></span><br><span class="line">	sql_insert(&amp;mysql, <span class="string">&quot;SET NAMES GB2312&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4. 向数据库中添加指定的内容(先测试sql指令，在放到代码中)</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//查询数据库存放的md5值</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NetWorkClient::MysqlSelect</span><span class="params">(<span class="keyword">char</span>* Filemd5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 5. sql_select</span></span><br><span class="line">	sql_select(&amp;mysql, <span class="string">&quot;SELECT md5 FROM md5_table;&quot;</span>, Filemd5);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 封装添加内容的函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NetWorkClient::sql_insert</span><span class="params">(MYSQL* mysql, <span class="keyword">const</span> <span class="keyword">char</span>* sql)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 通过 mysql_query 可以执行所有的 sql 操作</span></span><br><span class="line">	mysql_query(mysql, sql);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 由于操作可能出现错误，所以需要判断是否成功</span></span><br><span class="line">	sql_check_result(mysql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 封装查询内容的函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NetWorkClient::sql_select</span><span class="params">(MYSQL* mysql, <span class="keyword">const</span> <span class="keyword">char</span>* sql,<span class="keyword">char</span>* filemd5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 通过 mysql_query 可以执行所有的 sql 操作</span></span><br><span class="line">	mysql_query(mysql, sql);</span><br><span class="line">	sql_check_result(mysql);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 通过函数从 sql 对象中接收查询到的结果</span></span><br><span class="line">	MYSQL_RES* res = mysql_use_result(mysql);</span><br><span class="line">	sql_check_result(mysql);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取到查询到的结果的列数</span></span><br><span class="line">	<span class="keyword">int</span> count = mysql_num_fields(res);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> Flag = <span class="number">1</span>;</span><br><span class="line">	<span class="comment">//// 从结果集中循环获取到下一项并输出</span></span><br><span class="line">	MYSQL_ROW row = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">while</span> (row = mysql_fetch_row(res))</span><br><span class="line">	&#123;   <span class="comment">// 获取每一行的信息</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i)</span><br><span class="line">		&#123;    <span class="comment">// 需要提防产生空指针的情况	</span></span><br><span class="line">			<span class="keyword">if</span> ((<span class="built_in">strcmp</span>(row[i], filemd5) == <span class="number">0</span>) &amp;&amp; row[i] != <span class="literal">nullptr</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, filemd5);</span><br><span class="line">				send(client,<span class="string">&quot;b&quot;</span>,<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">				Flag = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;		</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (Flag == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		send(client, <span class="string">&quot;a&quot;</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, filemd5);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查数据库操作是否成功</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NetWorkClient::sql_check_result</span><span class="params">(MYSQL* mysql)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 如果 mysql 操作出现了问题，就返回非 0 值</span></span><br><span class="line">	<span class="keyword">if</span> (mysql_errno(mysql) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 通过 mysql_error 获取到具体的错误信息</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;连接数据库出错: %s\n&quot;</span>, mysql_error(mysql));</span><br><span class="line">		system(<span class="string">&quot;pause&quot;</span>); <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">胡先森</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/11/22/%E5%AE%89%E5%85%A8%E5%8D%AB%E5%A3%AB%E7%AC%94%E8%AE%B0/">http://yoursite.com/2020/11/22/%E5%AE%89%E5%85%A8%E5%8D%AB%E5%A3%AB%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">Mr.Hu</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Windows/">Windows</a><a class="post-meta__tags" href="/tags/MFC/">MFC</a></div><div class="post_share"><div class="social-share" data-image="/img/14.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/02/Python%E5%9F%BA%E7%A1%80/"><img class="prev-cover" data-lazy-src="/img/Python.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python————基础</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/18/Window_MFC/"><img class="next-cover" data-lazy-src="/img/6.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Windows————MFC</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/11/18/Window_MFC/" title="Windows————MFC"><img class="relatedPosts_cover" data-lazy-src="img/6.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-18</div><div class="relatedPosts_title">Windows————MFC</div></div></a></div><div class="relatedPosts_item"><a href="/2021/03/12/Windows驱动开发/" title="驱动开发"><img class="relatedPosts_cover" data-lazy-src="/img/2021-3-2.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-12</div><div class="relatedPosts_title">驱动开发</div></div></a></div><div class="relatedPosts_item"><a href="/2021/02/01/内核编程/" title="内核基础"><img class="relatedPosts_cover" data-lazy-src="/img/2021-3-1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-01</div><div class="relatedPosts_title">内核基础</div></div></a></div><div class="relatedPosts_item"><a href="/2021/01/23/壳代码设计/" title="壳代码设计"><img class="relatedPosts_cover" data-lazy-src="/img/19.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-23</div><div class="relatedPosts_title">壳代码设计</div></div></a></div><div class="relatedPosts_item"><a href="/2020/10/22/CodeInjection/" title="Windows————代码注入与拦截"><img class="relatedPosts_cover" data-lazy-src="img/11.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-22</div><div class="relatedPosts_title">Windows————代码注入与拦截</div></div></a></div><div class="relatedPosts_item"><a href="/2020/10/17/Windows编程进程线程/" title="Windows————进程线程"><img class="relatedPosts_cover" data-lazy-src="img/8.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-17</div><div class="relatedPosts_title">Windows————进程线程</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" style="background-image: url(/img/14.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 胡先森</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    $.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js', function () {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: 'Eo4Vh3u0nKU2EUIpOMidpb6L-gzGzoHsz',
      appKey: 'RIFmwqkX4dT5EpJghF6o6DWE',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: 'https://eo4vh3u0.lc-cn-n1-shared.com',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><style type="text/css">#toggle-sidebar {bottom: 80px}</style><div class="aplayer no-destroy" data-id="7322622901" data-server="tencent" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/third-party/ClickShowText.js" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script></div></body></html><!-- 雪花特效 -->
<script type="text/javascript" src="\js\snow.js"></script>